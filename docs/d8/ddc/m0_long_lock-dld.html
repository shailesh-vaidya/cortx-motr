<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: FOM long lock DLD</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d8/ddc/m0_long_lock-dld.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">FOM long lock DLD </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="m0_long_lock-dld-ovw"></a>
Overview</h1>
<p>Long lock is a non-blocking synchronization construct which has to be used in FOM state handlers <a class="el" href="../../d6/dda/structm0__fom__ops.html#a43d7f67fb67810b227eab454513bec33">m0_fom_ops::fo_tick()</a>. Long lock provides support for a reader-writer lock for FOMs.</p>
<h1><a class="anchor" id="m0_long_lock-dld-func"></a>
Functional specification</h1>
<p>According to reasons, described in <a class="el" href="../../d8/ddc/m0_long_lock-dld.html#m0_long_lock-dld-logic">Logical specification</a>, application of struct <a class="el" href="../../dd/dc5/structm0__long__lock.html">m0_long_lock</a> requires to introduce special link structures struct <a class="el" href="../../df/d87/structm0__long__lock__link.html">m0_long_lock_link</a>: one structure per one acquiring long lock in the FOM. It's required that individual FOMs allocate and initialize link structures in their derived FOM data structures, and use this structures with long lock interfaces. The following code example demonstrates the usage example of the lock:</p>
<div class="fragment"><div class="line"><span class="comment">// Object encompassing FOM for some FOP type which</span></div><div class="line"><span class="comment">// typically contains necessary context data</span></div><div class="line"><span class="keyword">struct </span>fom_object_type {</div><div class="line">     <span class="comment">// Generic m0_fom object.</span></div><div class="line">     <span class="keyword">struct </span><a class="code" href="../../d9/db7/structm0__fom.html">m0_fom</a>                    fp_gen;</div><div class="line">     <span class="comment">// ...</span></div><div class="line">     <span class="comment">// Long lock link structure, embedded into derived FOM object.</span></div><div class="line">     <span class="keyword">struct </span><a class="code" href="../../df/d87/structm0__long__lock__link.html">m0_long_lock_link</a>    fp_link;</div><div class="line">     <span class="comment">// ...</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d3a/fop__allow__ut_8c.html#ad3801ce8e6c8dff65ec3f4a28ee41ba8">fom_tick</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/db7/structm0__fom.html">m0_fom</a> *<a class="code" href="../../d7/d59/structfom.html">fom</a>)</div><div class="line">{</div><div class="line">     <span class="comment">//...</span></div><div class="line">     <span class="keyword">struct </span>fom_object_type      *fom_obj;</div><div class="line">     <span class="keyword">struct </span><a class="code" href="../../df/d87/structm0__long__lock__link.html">m0_long_lock_link</a> *link;</div><div class="line"></div><div class="line">     <span class="comment">// Retreive derived FOM object and long lock link.</span></div><div class="line">     fom_obj = <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#af8c317a42292b61c93aae91e59118a46">container_of</a>(<a class="code" href="../../d7/d59/structfom.html">fom</a>, <span class="keyword">struct</span> fom_object_type, fp_gen);</div><div class="line">     link = &amp;fom_obj-&gt;fp_link;</div><div class="line">     <span class="comment">//...</span></div><div class="line">     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d59/group__fom.html#gaa36a85b631316d662c2a1d5a9169057d">m0_fom_phase</a>(<a class="code" href="../../d7/d59/structfom.html">fom</a>) == PH_CURRENT) {</div><div class="line">        <span class="comment">// try to obtain a lock, when it&#39;s obtained FOM is</span></div><div class="line">        <span class="comment">// transitted into PH_GOT_LOCK</span></div><div class="line"></div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#gac7dcfcd902e681ec0766463721434d4f">M0_FOM_LONG_LOCK_RETURN</a>(</div><div class="line">             <a class="code" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#ga32c86cc142a302f4b5a976bb66dbeb40">m0_long_read_lock</a>(<a class="code" href="../../d2/d66/group__dtm.html#ga2a86bbc40fcee6c3db38e5a56bf5acf8">lock</a>, link, <a class="code" href="../../d8/d57/rdwr__test__bench_8c.html#a0fc859360673b471b3e286d816ad32bda70f0e6d3da2b6ecf36e5acc30fb3d428">PH_GOT_LOCK</a>));</div><div class="line">     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d59/group__fom.html#gaa36a85b631316d662c2a1d5a9169057d">m0_fom_phase</a>(<a class="code" href="../../d7/d59/structfom.html">fom</a>) == <a class="code" href="../../d8/d57/rdwr__test__bench_8c.html#a0fc859360673b471b3e286d816ad32bda70f0e6d3da2b6ecf36e5acc30fb3d428">PH_GOT_LOCK</a>) {</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        <a class="code" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#ga780120feeb7c6d856ccf41cdbbe3cafc">m0_long_read_unlock</a>(<a class="code" href="../../d2/d66/group__dtm.html#ga2a86bbc40fcee6c3db38e5a56bf5acf8">lock</a>, link);</div><div class="line">        <span class="comment">// ...</span></div><div class="line">     }</div><div class="line">     <span class="comment">//...</span></div><div class="line">}</div></div><!-- fragment --><dl class="section see"><dt>See also</dt><dd><a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html">FOM long lock API</a></dd></dl>
<h1><a class="anchor" id="m0_long_lock-dld-logic"></a>
Logical specification</h1>
<p>The lock is considered to be obtained when FOM transitions to the phase specified by the next_phase parameter to the m0_long_{read|write}_lock subroutine - the PH_GOT_LOCK value in the example above. Eventually, when FOMs state handler does not need to read or write shared data structures, access to which must be synchronized, the lock can be released with <a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#ga780120feeb7c6d856ccf41cdbbe3cafc">m0_long_read_unlock()</a> and <a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#gaf275d1f45f62ea03cf941299c2ba29b6">m0_long_write_unlock()</a> calls.</p>
<p>The long lock uses special link structures struct <a class="el" href="../../df/d87/structm0__long__lock__link.html">m0_long_lock_link</a> to track the FOMs that actively own the lock (<a class="el" href="../../dd/dc5/structm0__long__lock.html#a13d33050a8f44785cae957aaf6b48b2f">m0_long_lock::l_owners</a>), and the FOMs that are queued waiting to acquire the lock (<a class="el" href="../../dd/dc5/structm0__long__lock.html#ac5f0218bfe4e745393d2fc5614f155f6">m0_long_lock::l_waiters</a>). This is dictated by the requirement that one FOM can obtain multiple long locks. Holding multiple locks assumes that the same FOM can be presented in an arbitary number of queues in different long_locks. Derived FOM objects should contain a distinct link structure for each long lock used. The link must be initialized with <a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#gaf1ae488b8e87316ced7848717c2756a6">m0_long_lock_link_init()</a> before use.</p>
<p>To avoid starvation of writers in the face of a stream of incoming readers, a queue of waiting for the long lock FOMs is maintained:</p>
<ul>
<li>Long lock links store read/write flags.</li>
<li><a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#ga32c86cc142a302f4b5a976bb66dbeb40">m0_long_read_lock()</a> adds new links into the <a class="el" href="../../dd/dc5/structm0__long__lock.html#a13d33050a8f44785cae957aaf6b48b2f">m0_long_lock::l_owners</a> list if the lock is obtained for reading or unlocked, otherwise into the <a class="el" href="../../dd/dc5/structm0__long__lock.html#ac5f0218bfe4e745393d2fc5614f155f6">m0_long_lock::l_waiters</a>.</li>
<li>When a lock is released and there are no FOMs which own the lock, FOMs waiting for processing (if any) are processed in FIFO order. This avoid starvation and provides a degree of fairness.</li>
</ul>
<p>When some lock is being unlocked the work of selecting the next lock owner(s) and waking them up is done in the unlock path in <a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#ga780120feeb7c6d856ccf41cdbbe3cafc">m0_long_read_unlock()</a> and <a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#gaf275d1f45f62ea03cf941299c2ba29b6">m0_long_write_unlock()</a> with respect to <a class="el" href="../../dd/dc5/structm0__long__lock.html#a13d33050a8f44785cae957aaf6b48b2f">m0_long_lock::l_owners</a> and <a class="el" href="../../dd/dc5/structm0__long__lock.html#ac5f0218bfe4e745393d2fc5614f155f6">m0_long_lock::l_waiters</a> lists. m0_fom_ready_remote() call is used to wake FOMs up. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:24 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
