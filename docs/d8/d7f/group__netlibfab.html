<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: Netlibfab</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d8/d7f/group__netlibfab.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Netlibfab</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:gae762ad8776496e788bf62e0fa1615b61"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d8/d7f/group__netlibfab.html#gae762ad8776496e788bf62e0fa1615b61">M0_TRACE_SUBSYSTEM</a>&#160;&#160;&#160;M0_TRACE_SUBSYS_NET</td></tr>
<tr class="separator:gae762ad8776496e788bf62e0fa1615b61"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gae3e33de3778dec5a6273cf16fa829664"><td class="memItemLeft" align="right" valign="top">M0_INTERNAL int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d8/d7f/group__netlibfab.html#gae3e33de3778dec5a6273cf16fa829664">m0_net_libfab_init</a> (void)</td></tr>
<tr class="separator:gae3e33de3778dec5a6273cf16fa829664"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga657cf941e06cb1b05d42e5548089f6a8"><td class="memItemLeft" align="right" valign="top">M0_INTERNAL void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d8/d7f/group__netlibfab.html#ga657cf941e06cb1b05d42e5548089f6a8">m0_net_libfab_fini</a> (void)</td></tr>
<tr class="separator:ga657cf941e06cb1b05d42e5548089f6a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h2>Overview </h2>
<p>net/libfab/libfab.[ch] contains an implementation of the interfaces defined in <a class="el" href="../../db/db3/net_2net_8h.html">net/net.h</a>. Together these interfaces define a network transport layer used by motr. A network transport provides unreliable, unordered, asynchronous point-to-point messaging interface.</p>
<p>Libfabric network transport is implemented using libfabric library. It is user-space only.</p>
<p>Libfabric has no inherent fragmentation restrictions on segment size and buffer length. Using a large number of small segments is pure overhead because it will increase send/recv operations. Hence, to get best performance, optimal values of segment size and number of segments should be used.</p>
<h2>Data structures </h2>
<p><a class="el" href="../../d6/d24/libfab__internal_8h.html">libfab_internal.h</a> introduces data-structures corresponding to the abstractions in net.h and some of the additional data structures required for libfabric transport.</p>
<p>The libfabric end-point structure (struct m0_fab__ep) keeps a) A passive endpoint which is mainly used for listening connection requests, loopback ping and bulk operations and endpoint resources. B) A active endpoint which is used for transmit and receive operation with remote endpoint, it also stores current connection state for Tx and Rx endpoints and endpoint resources.</p>
<p>The libfabric transfer machine data structure (struct m0_fab__tm) contains hashtable for buffers associated with tm, this is required to keep track of valid operations within tm. In some cases, buffers are cancelled by RPC layer and libfabric library does not provide mechanism to cancel ongoing operation on respective buffer in such cases buffer token is removed from hashtable and if same buffer is re-used for other operation then new unique hash key is generated and added into hashtable.</p>
<p>Whenever any net buffer is posted successfully then unique token is generated and token is added into hashtable. Before generating a completion event of any buffer (i.e. libfab_buf_done()), token lookup is done within hashtable to check if buffer operation is valid, If token is present then token for that buffer is removed from hashtable while buffer completion callback, else buffer completion event is skipped.</p>
<p>Libfabric module is having two types of activities:</p>
<p>1) Synchronous Activity: These are initiated by <a class="el" href="../../db/db3/net_2net_8h.html">net/net.h</a> entry-points being called by a user and 2) Asynchronous Activity: Initiated by network related events, such as incoming connections or buffer completions.</p>
<h2>Synchronous activities: </h2>
<p>A buffer is added to a transfer machine (m0_net_buf_add()-&gt;...-&gt;libfab_buf_add()).</p>
<p>If the buffer is added to M0_NET_QT_MSG_RECV queue it is just placed on the libfabric internal receive queue, waiting for the incoming data.</p>
<p>If the buffer is added to M0_NET_QT_MSG_SEND, M0_NET_QT_ACTIVE_BULK_RECV, M0_NET_QT_ACTIVE_BULK_SEND then if the connection is established between two endpoints then buffer is posted to libfabric library, else connection request is sent to remote endpoint and buffer is added into send list, once connection is establihsed in poller thread then all then buffers from send list gets posted to libfabric library. If buffer is added to M0_NET_QT_PASSIVE_BULK_RECV, M0_NET_QT_PASSIVE_BULK_SEND queue buffer descriptors are encoded and in case of M0_NET_QT_PASSIVE_BULK_SEND dummy buffer is posted for remote end completion if extra receieve buffer is not available.</p>
<h2>Asynchronous activities: </h2>
<p>When a transfer machine is started, an end-point, representing the local peer, is created, i.e. a passive libfabric endpoint is created. This is a "listening endpoint" and poller thread checks for new incoming connection request events on this endpoint.</p>
<p>The starting point of asynchronous activity associated with a libfabric transfer machine is libfab_poller(). Currently, this function is ran as a separate thread.</p>
<p>The poller thread checks for connection request events and transmitting buffer completions, even poller thread checks for receiving buffer completion events using epoll_wait() a list of libfabric evert queues configured.</p>
<p>In case of RMA operations, single RMA operation is split into multiple requests based on segment size on local and remote endpoint, and buffer completion event shall be generated once last request is processed. In case of M0_NET_QT_ACTIVE_BULK_RECV, one extra dummy message is sent to remote endpoint (target of RDMA) to notify operation completion.</p>
<h2>Concurrency </h2>
<p>Libfabric module uses a very simple locking model: all state transitions are protected by a per-tm mutex: m0_net_transfer_mc::ntm_mutex. For synchronous activity, this mutex is taken by the entry-point code in net/ and is not released until the entry-point completes. For asynchronous activity, libfab_poller() keeps the lock taken most of the time.</p>
<p>Few points about concurrency:</p><ul>
<li>the tm lock is not held while epoll_wait() is executed by libfab_poller(). It is acquired after exiting the epoll_wait either due to some event or due to timeout.</li>
<li>buffer completion (libfab_buf_done()) includes notifying the application by invoking a user-supplied call-back. Completion event can happen both asynchronously (when a transfer operation completes for the buffer or the buffer times out, and synchronously (when the buffer is canceled by the user. Libfabric code will not support generation of synchronous callback events for buffer cancel operations. It will instead mark the buffer status as cancelled and add it to a list which will be processed in the poller thread and the callback would be invoked in asynchronous manner only.</li>
</ul>
<h2>Libfabric interface: </h2>
<p>Libfabric module uses fi_endpoint() to create transport level communication portals. Libfabric supports two types of endpoints: Passive endpoint and Active endpoint. Passive endpoints are most often used to listen for incoming connection requests. However, a passive endpoint may be used to reserve a fabric address that can be granted to an active endpoint. Active endpoints belong to access domains and can perform data transfers.</p>
<p>Below Libfabric interfaces are used: 1) fi_fabric : Used for fabric domain operations. Reference: <a href="https://ofiwg.github.io/libfabric/v1.6.2/man/fi_fabric.3.html">https://ofiwg.github.io/libfabric/v1.6.2/man/fi_fabric.3.html</a></p>
<p>2) fi_domain: Used for accessing fabric domain. Reference: <a href="https://ofiwg.github.io/libfabric/v1.1.1/man/fi_domain.3.html">https://ofiwg.github.io/libfabric/v1.1.1/man/fi_domain.3.html</a></p>
<p>3) fi_endpoint: USed for fabric endpoint operations. Reference: <a href="https://ofiwg.github.io/libfabric/master/man/fi_endpoint.3.html">https://ofiwg.github.io/libfabric/master/man/fi_endpoint.3.html</a></p>
<p>4) fi_mr: Used for memory region operations. Reference: <a href="https://ofiwg.github.io/libfabric/v1.1.1/man/fi_mr.3.html">https://ofiwg.github.io/libfabric/v1.1.1/man/fi_mr.3.html</a></p>
<p>5) fi_rma: Used for remote memory access operations. Reference: <a href="https://ofiwg.github.io/libfabric/v1.1.1/man/fi_rma.3.html">https://ofiwg.github.io/libfabric/v1.1.1/man/fi_rma.3.html</a> </p>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="gae762ad8776496e788bf62e0fa1615b61"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gae762ad8776496e788bf62e0fa1615b61">&#9670;&nbsp;</a></span>M0_TRACE_SUBSYSTEM</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define M0_TRACE_SUBSYSTEM&#160;&#160;&#160;M0_TRACE_SUBSYS_NET</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../d9/d56/libfab_8c_source.html#l00176">176</a> of file <a class="el" href="../../d9/d56/libfab_8c_source.html">libfab.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga657cf941e06cb1b05d42e5548089f6a8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga657cf941e06cb1b05d42e5548089f6a8">&#9670;&nbsp;</a></span>m0_net_libfab_fini()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">M0_INTERNAL void m0_net_libfab_fini </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../d9/d56/libfab_8c_source.html#l03452">3452</a> of file <a class="el" href="../../d9/d56/libfab_8c_source.html">libfab.c</a>.</p>

</div>
</div>
<a id="gae3e33de3778dec5a6273cf16fa829664"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gae3e33de3778dec5a6273cf16fa829664">&#9670;&nbsp;</a></span>m0_net_libfab_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">M0_INTERNAL int m0_net_libfab_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../d9/d56/libfab_8c_source.html#l03447">3447</a> of file <a class="el" href="../../d9/d56/libfab_8c_source.html">libfab.c</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="../../d8/d7f/group__netlibfab_gae3e33de3778dec5a6273cf16fa829664_cgraph.png" border="0" usemap="#d8/d7f/group__netlibfab_gae3e33de3778dec5a6273cf16fa829664_cgraph" alt=""/></div>
<map name="d8/d7f/group__netlibfab_gae3e33de3778dec5a6273cf16fa829664_cgraph" id="d8/d7f/group__netlibfab_gae3e33de3778dec5a6273cf16fa829664_cgraph">
<area shape="rect" id="node2" href="../../db/dcd/m0t1fs_2linux__kernel_2dir_8c.html#a9a02a790ad457506f9f3bc12121e6079" title="M0_RC" alt="" coords="180,5,247,32"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:47 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
