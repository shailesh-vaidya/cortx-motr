<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: Layout DB DLD</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d8/de8/_layout-_d_b.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Layout DB DLD </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-ovw">Overview</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-def">Definitions</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-req">Requirements</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-depends">Dependencies</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-highlights">Design Highlights</a></li>
<li><a class="el" href="../../dd/d61/_layout-_d_b-fspec.html">Functional Specification</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec">Logical Specification</a><ul>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-schema">Layout Schema Design</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-numa">NUMA optimizations</a></li>
</ul>
</li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-conformance">Conformance</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-ut">Unit Tests</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-st">System Tests</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-O">Analysis</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-ref">References</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="Layout-DB-ovw"></a>
Overview</h1>
<p>This document contains the detail level design for the Layout DB Module.</p>
<p>Purpose of the Layout-DB DLD <br />
 The purpose of the Layout-DB Detailed Level Design (DLD) specification is to:</p><ul>
<li>Refine the higher level design</li>
<li>To be verified by inspectors and architects</li>
<li>To guide the coding phase</li>
</ul>
<hr/>
 <h1><a class="anchor" id="Layout-DB-def"></a>
Definitions</h1>
<ul>
<li><p class="startli">COB: COB is component object For documentation links, please refer to this file : doc/motr-design-doc-list.rst</p>
<p class="startli">M0 Glossary</p>
</li>
</ul>
<hr/>
 <h1><a class="anchor" id="Layout-DB-req"></a>
Requirements</h1>
<p>The specified requirements are as follows:</p><ul>
<li>R.LAYOUT.SCHEMA.Layid: Layout identifiers are unique globally in the system, and persistent in the life cycle.</li>
<li>R.LAYOUT.SCHEMA.Types There are multiple layout types for different purposes: SNS, block map, local raid, de-dup, encryption, compression, etc.</li>
<li>R.LAYOUT.SCHEMA.Formulae<ul>
<li>Parameters: Layout may contain sub-map information. Layout may contain some formula, and its parameters and real mapping information should be calculated from the formula and its parameters.</li>
<li>Garbage Collection: If some objects are deleted from the system, their associated layout may still be left in the system, with zero user count. This layout can be re-used, or be garbage collected in some time.</li>
</ul>
</li>
<li>R.LAYOUT.SCHEMA.Sub-Layouts: Sub-layouts.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="Layout-DB-depends"></a>
Dependencies</h1>
<ul>
<li>Layout is a managed resource and depends upon Resource Manager.</li>
<li>Layout DB module depends upon the Layout module since the Layout module creates the layouts and uses/manages them.</li>
<li>Layout DB module depends upon the DB5 interfaces exposed by Motr since the layouts are stored using the DB5 data-base.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="Layout-DB-highlights"></a>
Design Highlights</h1>
<ul>
<li>Layout and layout-id are managed resources. <dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/da8/group__layout.html">Layouts.</a></dd></dl>
</li>
<li>The Layout DB module provides support for storing layouts with multiple layout types.</li>
<li>It provides support for storing composite layout maps.</li>
<li>It is required that for adding a layout type or layout enumeration type, central layout.h should not require modifications.</li>
<li>It is assumed that the problem of coruption is going to be attacked generically at the lower layers (db and fop) transparently, instead of adding magic numbers and check-sums in every module. Thus the input to Layout DB APIs which is either a layout or a FOP buffer in most of the cases is going to be tested for corruption by db or fop layer, as applicable.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="Layout-DB-lspec"></a>
Logical Specification</h1>
<p>Layout DB makes use of the DB5 data-base to persistently store the layout entries. This section describes how the Layout DB module works.</p>
<ul>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-schema">Layout Schema Design</a><ul>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-ds1">Subcomponent Data Structures</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-sub1">Subcomponent Subroutines</a></li>
<li><a class="el" href="../../d5/da3/group___layout_d_b_d_f_s_internal.html">Layout DB Internals</a></li>
</ul>
</li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-numa">NUMA optimizations</a></li>
</ul>
<h2><a class="anchor" id="Layout-DB-lspec-comps"></a>
Component Overview</h2>
<p>The following diagram shows the internal components of the "Layout" module, including the "Layout DB" component.</p>
<div class="dotgraph">
<img src="../../dot_inline_dotgraph_20.png" alt="dot_inline_dotgraph_20.png" border="0" usemap="#dot_inline_dotgraph_20.map"/>
<map name="dot_inline_dotgraph_20.map" id="dot_inline_dotgraph_20.map"></map>
</div>
<h2><a class="anchor" id="Layout-DB-lspec-schema"></a>
Layout Schema Design</h2>
<p>The layout schema for the Layout DB module consists of the following tables.</p><ul>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-schema-layouts">Table layouts</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-schema-cob_lists">Table cob_lists</a></li>
<li><a class="el" href="../../d8/de8/_layout-_d_b.html#Layout-DB-lspec-schema-comp_layout_ext_map">Layout-DB-lspec-schema-comp_layout_ext_map</a></li>
</ul>
<p>Key-Record structures for these tables are described below.</p>
<h2><a class="anchor" id="Layout-DB-lspec-schema-layouts"></a>
Table layouts</h2>
<pre class="fragment">* Table Name: layouts
* Key: layout_id
* Record:
*    - layout_type_id
*    - user_count
*    - layout_type_specific_data (optional)
*
* </pre><p>layout_type_specific_data field is used to store layout type or layout enum type specific data. Structure of this field varies accordingly. For example:</p><ul>
<li>In case of a layout with PDCLUST layout type, the structure <a class="el" href="../../d4/d0e/structm0__layout__pdclust__rec.html">m0_layout_pdclust_rec</a> is used to store attributes like enumeration type id, N, K, P.</li>
<li>In case of a layout with LIST enum type, an array of <a class="el" href="../../d9/d8a/structm0__fid.html">m0_fid</a> structure with size LDB_MAX_INLINE_COB_ENTRIES is used to store a few COB entries inline into the layouts table itself.</li>
<li>It is possible that some layouts do not need to store any layout type or layout enum type specific data in the layouts table. For example, a layout with COMPOSITE layout type.</li>
</ul>
<h2><a class="anchor" id="Layout-DB-lspec-schema-cob_lists"></a>
Table cob_lists</h2>
<pre class="fragment">* Table Name: cob_lists
* Key:
*    - layout_id
*    - cob_index
* Record:
*    - cob_id
*
*  </pre><p>This table contains multiple COB identifier entries for every PDCLUST type of layout with LIST enumeration type.</p>
<p>layout_id is a foreign key referring record, in the layouts table.</p>
<p>cob_index for the first entry in this table will be the continuation of the index from the array of <a class="el" href="../../d9/d8a/structm0__fid.html">m0_fid</a> structures stored inline in the layouts table.</p>
<h2><a class="anchor" id="Layout-DB-lspec-schema-comp_layout_ext_map"></a>
Layout-DB-lspec-schema-comp_layout_ext_map</h2>
<p>Table comp_layout_ext_map</p>
<pre class="fragment">* Table Name: comp_layout_ext_map
* Key
*    - composite_layout_id
*    - last_offset_of_segment
* Record
*    - start_offset_of_segment
*    - layout_id
*
* </pre><p>composite_layout_id is the layout_id for the COMPOSITE type of layout, stored as key in the layouts table.</p>
<p>layout_id is a foreign key referring record, in the layouts table.</p>
<p>Layout DB uses a single m0_emap instance to implement the composite layout extent map viz. comp_layout_ext_map. This table stores the "layout segment
  to sub-layout id mappings" for each compsite layout.</p>
<p>Since prefix (an element of the key for m0_emap) is required to be 128 bit in size, layout id (unit64_t) of the composite layout is used as a part of the prefix (struct <a class="el" href="../../dc/d54/structlayout__prefix.html">layout_prefix</a>) to identify an extent map belonging to one specific composite layout. The lower 64 bits are currently unused (fillers).</p>
<p>An example:</p>
<p>Suppose a layout L1 is of the type composite and constitutes of 3 sub-layouts say S1, S2, S3. These sub-layouts S1, S2 and S3 use the layouts with layout id L11, L12 and L13 respectively.</p>
<p>In this example, for the composite layout L1, the comp_layout_ext_map table stores 3 layout segments viz. S1, S2 and S3. All these 3 segments are stored in the form of ([A, B), V) where:</p><ul>
<li>A is the start offset from the layout L1</li>
<li>B is the end offset from the layout L1</li>
<li>V is the layout id for the layout used by the respective segment and is either of L11, L12 or L13 as applicable.</li>
</ul>
<h3><a class="anchor" id="Layout-DB-lspec-ds1"></a>
Subcomponent Data Structures</h3>
<p>See <a class="el" href="../../d5/da3/group___layout_d_b_d_f_s_internal.html">Layout DB Internals</a> for internal data structures.</p>
<h3><a class="anchor" id="Layout-DB-lspec-sub1"></a>
Subcomponent Subroutines</h3>
<p>See <a class="el" href="../../d5/da3/group___layout_d_b_d_f_s_internal.html">Layout DB Internals</a> for internal subroutines.</p>
<h2><a class="anchor" id="Layout-DB-lspec-state"></a>
State Specification</h2>
<p>This module does follow state machine ind of a design. Hence, this section is not applicable.</p>
<h2><a class="anchor" id="Layout-DB-lspec-thread"></a>
Threading and Concurrency Model</h2>
<p>See <a class="el" href="../../da/da8/group__layout.html#layout-thread">Layout Threading and Concurrency Model</a>.</p>
<h2><a class="anchor" id="Layout-DB-lspec-numa"></a>
NUMA optimizations</h2>
<hr/>
 <h1><a class="anchor" id="Layout-DB-conformance"></a>
Conformance</h1>
<ul>
<li>I.LAYOUT.SCHEMA.Layid: Layout identifiers are unique globally in the system, and persistent in the life cycle. It is assumed that the layout identifiers are assigned by the Layout module and Layout DB module helps to store those persistently.</li>
<li>I.LAYOUT.SCHEMA.Types: There are multiple layout types for different purposes: SNS, block map, local raid, de-dup, encryption, compression, etc. <br />
 Layout DB module supports storing all kinds of layout types supported currently by the layout module viz. PDCLUST and COMPOSITE. The framework supports to add other layout types, as required in the future.</li>
<li>I.LAYOUT.SCHEMA.Formulae:<ul>
<li>Parameters:<ul>
<li>In case of PDCLUST layout type using LINEAR enumeration, linear formula is stored by the Layout DB and substituting parameters in the stored formula derives the real mapping information that is the list of COB identifiers.</li>
</ul>
</li>
<li>Garbage Collection:<ul>
<li>A layout with 0 user count can stay in the DB unless it is deleted explicitly from the DB.</li>
<li>An in-memory layout is deleted when its last reference is released explicitly.</li>
</ul>
</li>
</ul>
</li>
<li>I.LAYOUT.SCHEMA.Sub-Layouts: COMPOSITE type of layout is used to store sub-layouts.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="Layout-DB-ut"></a>
Unit Tests</h1>
<p>Following cases will be tested by unit tests:</p>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000061">Test:</a></b></dt><dd>1) Registering layout types including PDCLUST amd COMPOSITE types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000062">Test:</a></b></dt><dd>2) Unregistering layout types including PDCLUST amd COMPOSITE types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000063">Test:</a></b></dt><dd>3) Registering each of LIST and LINEAR enum types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000064">Test:</a></b></dt><dd>4) Unregistering each of LIST and LINEAR enum types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000065">Test:</a></b></dt><dd>5) Encode layout with each of layout type and enum types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000066">Test:</a></b></dt><dd>6) Decode layout with each of layout type and enum types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000067">Test:</a></b></dt><dd>7) Adding layouts with all the possible combinations of all the layout types and enumeration types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000068">Test:</a></b></dt><dd>8) Deleting layouts with all the possible combinations of all the layout types and enumeration types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000069">Test:</a></b></dt><dd>9) Updating layouts with all the possible combinations of all the layout types and enumeration types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000070">Test:</a></b></dt><dd>10) Reading a layout with all the possible combinations of all the layout types and enumeration types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000071">Test:</a></b></dt><dd>11) Checking DB persistence by comparing a layout with the layout read from the DB, for all the possible combinations of all the layout types and enumeration types.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000072">Test:</a></b></dt><dd>12) Covering all the negative test cases.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000073">Test:</a></b></dt><dd>13) Covering all the error cases.</dd></dl>
<hr/>
 <h1><a class="anchor" id="Layout-DB-st"></a>
System Tests</h1>
<p>System testing will include tests where multiple processes are writing to and reading from the DB at the same time.</p>
<hr/>
 <h1><a class="anchor" id="Layout-DB-O"></a>
Analysis</h1>
<hr/>
 <h1><a class="anchor" id="Layout-DB-ref"></a>
References</h1>
<p>For documentation links, please refer to this file : doc/motr-design-doc-list.rst</p><ul>
<li>HLD of Layout Schema</li>
<li>Understanding Layout Schema </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:25 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
