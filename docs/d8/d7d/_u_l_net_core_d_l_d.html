<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: LNet Transport User Space Core DLD</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d8/d7d/_u_l_net_core_d_l_d.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">LNet Transport User Space Core DLD </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-ovw">Overview</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-def">Definitions</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-req">Requirements</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-depends">Dependencies</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-highlights">Design Highlights</a></li>
<li>Functional Specification<ul>
<li><a class="el" href="../../da/d12/_l_net_core_d_l_d-fspec.html">LNet Transport Core API</a></li>
<li><a class="el" href="../../d3/d35/group___u_l_net_core.html">Core User Space Interface</a> <br />
 - <a class="el" href="../../df/d9e/group___l_net_dev.html">LNet Transport Device</a></li>
</ul>
</li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec">Logical Specification</a><ul>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-malloc">Memory Allocation Strategy</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-ioctl">Strategy for Kernel Interaction</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-dominit">Domain Initialization</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-domfini">Domain Finalization</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-reg">Buffer Registration and De-registration</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-bev">Managing the Buffer Event Queue</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-tmstart">Starting a Transfer Machine</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-tmstop">Stopping a Transfer Machine</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-buf">Transfer Machine Buffer Queue Operations</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-event">Waiting for Buffer Events</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-nids">Node Identifier Support</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-numa">NUMA optimizations</a></li>
</ul>
</li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-conformance">Conformance</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-ut">Unit Tests</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-st">System Tests</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-O">Analysis</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-ref">References</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-ovw"></a>
Overview</h1>
<p>The LNet Transport is built over an address space agnostic "core" I/O interface. This document describes the user space implementation of this interface, which interacts with <a class="el" href="../../db/dd7/_k_l_net_core_d_l_d.html">Kernel Core</a> by use of the <a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html">LNet Transport Device</a>.</p>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-def"></a>
Definitions</h1>
<ul>
<li>HLD of Motr LNet Transport : For documentation links, please refer to this file : doc/motr-design-doc-list.rst</li>
</ul>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-req"></a>
Requirements</h1>
<ul>
<li><b>r.m0.net.xprt.lnet.ioctl</b> The user space core interacts with the kernel core through ioctl requests.</li>
<li><b>r.m0.net.xprt.lnet.aligned-objects</b> The implementation must ensure that shared objects do not cross page boundaries.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-depends"></a>
Dependencies</h1>
<ul>
<li><a class="el" href="../../d7/db9/group___l_net_d_f_s.html">LNet Transport</a> <br />
 The <code><a class="el" href="../../d7/db9/group___l_net_d_f_s.html#ga608850305a1bd2f15f951bbce7700db2">m0_net_lnet_ifaces_get()</a></code> and <code><a class="el" href="../../d7/db9/group___l_net_d_f_s.html#ga0c9f7178e9044e2ee8cf747541f1dece">m0_net_lnet_ifaces_put()</a></code> APIs must be changed to require a <code><a class="el" href="../../db/d78/structm0__net__domain.html">m0_net_domain</a></code> parameter, because the user space must interact with the kernel to get the interfaces, and a per-domain file descriptor is required for this interaction.</li>
<li><a class="el" href="../../d8/de0/group___l_net_core.html">LNet Transport Core Interfaces</a> <br />
 New <code><a class="el" href="../../d8/de0/group___l_net_core.html#ga9fa65b9a7f3ca1f1a79066e731fddd2a">nlx_core_ep_addr_encode()</a></code> and <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gaf087fa4adb240f93d407184d3a451fc8">nlx_core_nidstr_decode()</a></code> functions are added to the core interface, allowing endpoint address encoding and decoding to be implemented in an address space independent manner.</li>
<li><a class="el" href="../../df/d9e/group___l_net_dev.html">LNet Transport Device</a> <br />
 The Device driver provides access to the Kernel Core implementation through ioctl requests on the "/dev/m0lnet" device.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-highlights"></a>
Design Highlights</h1>
<ul>
<li>The Core API is an address space agnostic I/O interface intended for use by the Motr Networking LNet transport operation layer in either user space or kernel space.</li>
<li>The user space implementation interacts with the kernel core implementation via a device driver.</li>
<li>Each user space <code><a class="el" href="../../db/d78/structm0__net__domain.html">m0_net_domain</a></code> corresponds to opening a separate file descriptor.</li>
<li>Shared memory objects allow indirect interaction with the kernel and reduce the number of required context switches.</li>
<li>Those core operations that require direct kernel interaction do so via ioctl requests.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-lspec"></a>
Logical Specification</h1>
<ul>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-malloc">Memory Allocation Strategy</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-ioctl">Strategy for Kernel Interaction</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-dominit">Domain Initialization</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-domfini">Domain Finalization</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-reg">Buffer Registration and De-registration</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-bev">Managing the Buffer Event Queue</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-tmstart">Starting a Transfer Machine</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-tmstop">Stopping a Transfer Machine</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-buf">Transfer Machine Buffer Queue Operations</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-event">Waiting for Buffer Events</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-nids">Node Identifier Support</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-numa">NUMA optimizations</a></li>
</ul>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-comps"></a>
Component Overview</h2>
<p>The relationship between the various objects in the components of the LNet transport and the networking layer is illustrated in the following UML diagram. </p><div class="image">
<img src="../../../../net/lnet/lnet_xo.png" alt="lnet_xo.png"/>
<div class="caption">
LNet Transport Objects</div></div>
<p> The Core layer in user space has no sub-components but interfaces with the kernel core layer via the device driver layer.</p>
<ul>
<li>HLD of Motr LNet Transport : For documentation links, please refer to this file : doc/motr-design-doc-list.rst</li>
</ul>
<p>Refer specifically the Design Highlights component diagram. </p><dl class="section see"><dt>See also</dt><dd><a class="el" href="../../db/dd7/_k_l_net_core_d_l_d.html#KLNetCoreDLD-lspec-userspace">Kernel Support for User Space Transports</a>.</dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-malloc"></a>
Memory Allocation Strategy</h2>
<p>The LNet driver layer requires that each shared object fit within a single page. Assertions about the structures in question,</p>
<ul>
<li><a class="el" href="../../d8/d81/structnlx__core__domain.html">nlx_core_domain</a></li>
<li><a class="el" href="../../d3/d98/structnlx__core__transfer__mc.html">nlx_core_transfer_mc</a></li>
<li><a class="el" href="../../d7/df3/structnlx__core__buffer.html">nlx_core_buffer</a></li>
<li><a class="el" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a></li>
</ul>
<p>ensure they are smaller than a page in size. However, to guarantee that instances of these structures do not cross page boundaries, all allocations of these structures must be performed using <code><a class="el" href="../../d7/ded/group__memory.html#gaba5ec475cae7ec35c8082362f50967aa">m0_alloc_aligned()</a></code>. The <code>shift</code> parameter for each allocation must be picked such that <code>1&lt;&lt;shift</code> is at least the size of the structure. Build-time assertions about these shifts can assure the correct shift is used.</p>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-ioctl"></a>
Strategy for Kernel Interaction</h2>
<p>The user space core interacts with the kernel through ioctl requests on a file descriptor opened on the "/dev/m0lnet" device. There is a 1:1 correspondence between <code><a class="el" href="../../db/d78/structm0__net__domain.html">m0_net_domain</a></code> (<code><a class="el" href="../../d8/d81/structnlx__core__domain.html">nlx_core_domain</a></code>) objects and file descriptors. So, each time a domain is initialized, a new file descriptor is obtained. After the file descriptor is obtained, further interaction is in the form of ioctl requests. When the <code><a class="el" href="../../db/d78/structm0__net__domain.html">m0_net_domain</a></code> is finalized, the file descriptor is closed. The specific interactions are detailed in the following sections.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html">LNet Transport Device DLD</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-dominit"></a>
Domain Initialization</h2>
<p>In the case of domain initialization, <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga5b6f0c3785f844e21283b04f1c7fa4c0">nlx_core_dom_init()</a></code>, the following sequence of tasks is performed by the user space core. This is the first interaction between the user space core and the kernel core.</p>
<ul>
<li>The user space core allocates a <code><a class="el" href="../../d8/d81/structnlx__core__domain.html">nlx_core_domain</a></code> object.</li>
<li>It performs upper layer initialization of this object, including allocating the <code><a class="el" href="../../d8/dbb/structnlx__ucore__domain.html">nlx_ucore_domain</a></code> object and setting the <code><a class="el" href="../../d8/d81/structnlx__core__domain.html#a9e413283bedb4390e3cbffd58c28c9e7">nlx_core_domain::cd_upvt</a></code> field.</li>
<li>It opens the device using the <code>open()</code> system call. The device is named <code>"/dev/m0lnet"</code> and the device is opened with <code>O_RDWR|O_CLOEXEC</code> flags. The file descriptor is saved in the <code><a class="el" href="../../d8/dbb/structnlx__ucore__domain.html#a08160846657fcb0e5e361075531493c9">nlx_ucore_domain::ud_fd</a></code> field.</li>
<li>It declares a <code><a class="el" href="../../dc/dfc/structm0__lnet__dev__dom__init__params.html">m0_lnet_dev_dom_init_params</a></code> object, setting the <code><a class="el" href="../../dc/dfc/structm0__lnet__dev__dom__init__params.html#a5013dcb192c88d9669e8d40654d55302">m0_lnet_dev_dom_init_params::ddi_cd</a></code> field.</li>
<li>It shares the <code><a class="el" href="../../d8/d81/structnlx__core__domain.html">nlx_core_domain</a></code> object via the <code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga604193f0a227cfe0ef279f652a513684">M0_LNET_DOM_INIT</a></code> ioctl request. Note that a side effect of this request is that the <code><a class="el" href="../../d8/d81/structnlx__core__domain.html#a4c53abb13f618eb6a128406d89ba96ed">nlx_core_domain::cd_kpvt</a></code> is set.</li>
<li>It completes user space initialization of the <code><a class="el" href="../../d8/d81/structnlx__core__domain.html">nlx_core_domain</a></code> object and the <code><a class="el" href="../../d8/dbb/structnlx__ucore__domain.html">nlx_ucore_domain</a></code> object, including caching the three buffer maximum size values returned in the <code><a class="el" href="../../dc/dfc/structm0__lnet__dev__dom__init__params.html">m0_lnet_dev_dom_init_params</a></code>.</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-dominit">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-domfini"></a>
Domain Finalization</h2>
<p>During domain finalization, <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga6581cd0b3aae790e5652cabe2c97ba3d">nlx_core_dom_fini()</a></code>, the user space core performs the following steps.</p>
<ul>
<li>It completes pre-checks of the <code><a class="el" href="../../d8/dbb/structnlx__ucore__domain.html">nlx_ucore_domain</a></code> and <code><a class="el" href="../../d8/d81/structnlx__core__domain.html">nlx_core_domain</a></code> objects.</li>
<li>It calls <code>close()</code> to release the file descriptor. This will typically cause the kernel to immediately finalize its private data and release resources (unless there is duplicate file descriptor, in which case the kernel will delay finalization until the final duplicate is closed; this is unlikely because the file descriptor is not exposed and the file is opened using <code>O_CLOEXEC</code>).</li>
<li>It completes any post-finalization steps, such as freeing its <code><a class="el" href="../../d8/dbb/structnlx__ucore__domain.html">nlx_ucore_domain</a></code> object.</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-domfini">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-reg"></a>
Buffer Registration and De-registration</h2>
<p>The user space core implementations of <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga0123b7f9ea91047bf6bad0b4ad590447">nlx_core_get_max_buffer_size()</a></code>, <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gaef4fdbb376819294dc4af8acb6732057">nlx_core_get_max_buffer_segment_size()</a></code> and <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gaf2a56a056ef61dcfd3ac6d73f3c6d2dc">nlx_core_get_max_buffer_segments()</a></code> each return the corresponding value cached in the <code><a class="el" href="../../d8/dbb/structnlx__ucore__domain.html">nlx_ucore_domain</a></code> object.</p>
<p>The user space core completes the following tasks to perform buffer registration.</p>
<ul>
<li>It performs upper layer initialization of the <code><a class="el" href="../../d7/df3/structnlx__core__buffer.html">nlx_core_buffer</a></code> object. This includes allocating and initializing the <code><a class="el" href="../../dc/dde/structnlx__ucore__buffer.html">nlx_ucore_buffer</a></code> object and setting the <code><a class="el" href="../../d7/df3/structnlx__core__buffer.html#aade6eaa08a1b3f68f6b16e5a51ad1655">nlx_core_buffer::cb_upvt</a></code> field.</li>
<li>It declares a <code><a class="el" href="../../d8/d18/structm0__lnet__dev__buf__register__params.html">m0_lnet_dev_buf_register_params</a></code> object, setting the parameter fields from the <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gac9bfb3d66ff5adfe644fdd2aed9b7a3a">nlx_core_buf_register()</a></code> parameters.</li>
<li>It copies the data referenced by the bvec parameter to the dbr_bvec field.</li>
<li>It performs a <code><a class="el" href="../../df/d9e/group___l_net_dev.html#gab70c3b3e49bd6f3871a12f1e49b2922b">M0_LNET_BUF_REGISTER</a></code> ioctl request to share the buffer with the kernel and complete the kernel part of buffer registration.</li>
<li>It completes any initialization of the <code><a class="el" href="../../dc/dde/structnlx__ucore__buffer.html">nlx_ucore_buffer</a></code> object.</li>
</ul>
<p>The user space core completes the following tasks to perform buffer de-registration.</p>
<ul>
<li>It completes pre-checks of the <code><a class="el" href="../../d7/df3/structnlx__core__buffer.html">nlx_core_buffer</a></code> object.</li>
<li>It performs a <code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga38d0ea03383ce6d9bbd2319ece7bf2b7">M0_LNET_BUF_DEREGISTER</a></code> ioctl request, causing the kernel to complete the kernel part of buffer de-registration.</li>
<li>It completes any user space de-registration of the <code><a class="el" href="../../d7/df3/structnlx__core__buffer.html">nlx_core_buffer</a></code> and <code><a class="el" href="../../dc/dde/structnlx__ucore__buffer.html">nlx_ucore_buffer</a></code> objects.</li>
<li>It frees the <code><a class="el" href="../../dc/dde/structnlx__ucore__buffer.html">nlx_ucore_buffer</a></code> object and resets the <code><a class="el" href="../../d7/df3/structnlx__core__buffer.html#aade6eaa08a1b3f68f6b16e5a51ad1655">nlx_core_buffer::cb_upvt</a></code> to NULL.</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-reg">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-bev"></a>
Managing the Buffer Event Queue</h2>
<p>The <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga90a62bfb8f2c6418f7f83e0512b25c19">nlx_core_new_blessed_bev()</a></code> helper allocates and blesses buffer event objects. In user space, blessing the object requires interacting with the kernel. After the object is blessed by the kernel, the user space core can add it to the buffer event queue directly, without further kernel interaction. The following steps are taken by the user space core.</p>
<ul>
<li>It allocates a new <code><a class="el" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a></code> object.</li>
<li>It declares a <code><a class="el" href="../../d0/d70/structm0__lnet__dev__bev__bless__params.html">m0_lnet_dev_bev_bless_params</a></code> object and sets its fields.</li>
<li>It performs a <code><a class="el" href="../../df/d9e/group___l_net_dev.html#gae897fa2a1613b644496aa88de0244cf5">M0_LNET_BEV_BLESS</a></code> ioctl request to share the <code><a class="el" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a></code> object with the kernel and complete the kernel part of blessing the object.</li>
</ul>
<p>Buffer event objects are never removed from the buffer event queue until the transfer machine is stopped.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-bev">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-tmstart"></a>
Starting a Transfer Machine</h2>
<p>The user space core <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga320b9bd08fca9515d270a582f7a2dc3f">nlx_core_tm_start()</a></code> subroutine completes the following tasks to start a transfer machine. Recall that there is no core API corresponding to the <code><a class="el" href="../../dd/d6e/group___l_net_x_o_d_f_s.html#ga3a49def9d891f703ead27c9e154e951c">nlx_xo_tm_init()</a></code> function.</p>
<ul>
<li>It performs upper layer initialization of the <code><a class="el" href="../../d3/d98/structnlx__core__transfer__mc.html">nlx_core_transfer_mc</a></code> object. This includes allocating and initializing the <code><a class="el" href="../../da/d4e/structnlx__ucore__transfer__mc.html">nlx_ucore_transfer_mc</a></code> object and setting the <code><a class="el" href="../../d3/d98/structnlx__core__transfer__mc.html#a0ce039ae3fd7cea48cec9e4ae96b167f">nlx_core_transfer_mc::ctm_upvt</a></code> field.</li>
<li>It performs a <code><a class="el" href="../../df/d9e/group___l_net_dev.html#gadb3f78ab30d5ac26541931bf4e5e9516">M0_LNET_TM_START</a></code> ioctl request to share the <code><a class="el" href="../../d3/d98/structnlx__core__transfer__mc.html">nlx_core_transfer_mc</a></code> object with the kernel and complete the kernel part of starting the transfer machine.</li>
<li>It allocates and initializes two <code><a class="el" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a></code> objects, using the user space <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga90a62bfb8f2c6418f7f83e0512b25c19">nlx_core_new_blessed_bev()</a></code> helper.</li>
<li>It completes the user space initialization of the <code><a class="el" href="../../d7/df3/structnlx__core__buffer.html">nlx_core_buffer</a></code> and <code><a class="el" href="../../da/d4e/structnlx__ucore__transfer__mc.html">nlx_ucore_transfer_mc</a></code> objects. This including initializing the buffer event circular queue using the <code><a class="el" href="../../dd/d08/group__bevcqueue.html#ga1e5ff189be5e9394e1f1ddad3cf64f6f">bev_cqueue_init()</a></code> function.</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-tmstart">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-tmstop"></a>
Stopping a Transfer Machine</h2>
<p>The user space core <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga40d158d51d960ab794120b77560e06a3">nlx_core_tm_stop()</a></code> subroutine completes the following tasks to stop a transfer machine. Recall that there is no core API corresponding to the <code><a class="el" href="../../dd/d6e/group___l_net_x_o_d_f_s.html#gaefd7f92ee503c744041f6d4faf26ae94">nlx_xo_tm_fini()</a></code> function.</p>
<ul>
<li>It completes pre-checks of the <code><a class="el" href="../../d3/d98/structnlx__core__transfer__mc.html">nlx_core_transfer_mc</a></code> object.</li>
<li>It performs a <code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga1cdddba87b15e8f14adaf4c5083e231c">M0_LNET_TM_STOP</a></code> ioctl request, causing the kernel to complete the kernel part of stopping the transfer machine.</li>
<li>It frees the buffer event queue using the <code><a class="el" href="../../dd/d08/group__bevcqueue.html#ga11b67df4714ae0ba1291f29d59af90cd">bev_cqueue_fini()</a></code> function.</li>
<li>It frees the <code><a class="el" href="../../da/d4e/structnlx__ucore__transfer__mc.html">nlx_ucore_transfer_mc</a></code> object and resets the <code><a class="el" href="../../d3/d98/structnlx__core__transfer__mc.html#a0ce039ae3fd7cea48cec9e4ae96b167f">nlx_core_transfer_mc::ctm_upvt</a></code> to NULL.</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-tmstop">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-buf"></a>
Transfer Machine Buffer Queue Operations</h2>
<p>Several LNet transport core subroutines,</p>
<ul>
<li><code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga4a1904545b37af90151765759a8c1ac2">nlx_core_buf_msg_recv()</a></code> </li>
<li><code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga70f259a426d073a46ca6a477dd640621">nlx_core_buf_msg_send()</a></code> </li>
<li><code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gab0f7d2d447f931f538e235d40787c2c3">nlx_core_buf_active_recv()</a></code> </li>
<li><code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gaa3f0a51bdcf5fb39721155d962248363">nlx_core_buf_active_send()</a></code> </li>
<li><code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga6b079c8c33e3be851281f141ad23ce35">nlx_core_buf_passive_recv()</a></code> </li>
<li><code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga2d0eba66a9a2f182ff13c8986b53839f">nlx_core_buf_passive_send()</a></code> </li>
<li><code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gadc89ed4c9201fee7e524777331f4b7ad">nlx_core_buf_del()</a></code> </li>
</ul>
<p>operate on buffers and transfer machine queues. In all user space core cases, the shared objects, <code><a class="el" href="../../d7/df3/structnlx__core__buffer.html">nlx_core_buffer</a></code> and <code><a class="el" href="../../d3/d98/structnlx__core__transfer__mc.html">nlx_core_transfer_mc</a></code>, must have been previously shared with the kernel, through use of the <code><a class="el" href="../../df/d9e/group___l_net_dev.html#gab70c3b3e49bd6f3871a12f1e49b2922b">M0_LNET_BUF_REGISTER</a></code> and <code><a class="el" href="../../df/d9e/group___l_net_dev.html#gadb3f78ab30d5ac26541931bf4e5e9516">M0_LNET_TM_START</a></code> ioctl requests, respectively.</p>
<p>The ioctl requests available to the user space core for managing buffers and transfer machine buffer queues are as follows.</p><ul>
<li><code><a class="el" href="../../df/d9e/group___l_net_dev.html#gad3a52e7ed4c59376d54738acb99af005">M0_LNET_BUF_MSG_RECV</a></code> </li>
<li><code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga6160a0de3eb8d7dbe8c715cfd3ec5db4">M0_LNET_BUF_MSG_SEND</a></code> </li>
<li><code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga5cfe5d931241ea690c72640ddb877658">M0_LNET_BUF_ACTIVE_RECV</a></code> </li>
<li><code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga89ebe6d201bca9c323a5184a21770bcb">M0_LNET_BUF_ACTIVE_SEND</a></code> </li>
<li><code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga6cb38d6d097b539d7f83e01f9509ecbf">M0_LNET_BUF_PASSIVE_RECV</a></code> </li>
<li><code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga5d4119ae5a0600bf43b8b87a648f8239">M0_LNET_BUF_PASSIVE_SEND</a></code> </li>
<li><code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga949b2c3987936d5cf8238ad7128b305f">M0_LNET_BUF_DEL</a></code> </li>
</ul>
<p>In each case, the user space core performs the following steps.</p><ul>
<li>Validates the parameters.</li>
<li>Declares a <code><a class="el" href="../../df/dd0/structm0__lnet__dev__buf__queue__params.html">m0_lnet_dev_buf_queue_params</a></code> object and sets the two fields. In this case, both fields are set to the kernel private pointers of the shared objects.</li>
<li>Performs the appropriate ioctl request from the list above.</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-buf">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-event"></a>
Waiting for Buffer Events</h2>
<p>The user space core <a class="el" href="../../d3/d35/group___u_l_net_core.html#gae13e825aec8f23e29b7f72af334192db">nlx_core_buf_event_wait()</a> subroutine completes the following tasks to wait for buffer events.</p>
<ul>
<li>It declares a <code><a class="el" href="../../df/dcc/structm0__lnet__dev__buf__event__wait__params.html">m0_lnet_dev_buf_event_wait_params</a></code> and sets the fields.</li>
<li>It performs a <code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga5fec6938ee8c7fd8592b697c634e79f9">M0_LNET_BUF_EVENT_WAIT</a></code> ioctl request to wait for the kernel to generate additional buffer events.</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-event">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-nids"></a>
Node Identifier Support</h2>
<p>Operations involving NID strings require ioctl requests to access kernel-only functions.</p>
<p>Most of the <code><a class="el" href="../../d8/de0/group___l_net_core.html#gadcf9e5c3e6a5615f874f8df656cc0298">nlx_core_ep_addr_decode()</a></code> and <code><a class="el" href="../../d8/de0/group___l_net_core.html#ga9fa65b9a7f3ca1f1a79066e731fddd2a">nlx_core_ep_addr_encode()</a></code> functions can be implemented common in user and kernel space code. However, converting a NID to a string or vice versa requires access to functions which exists only in the kernel. The <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gaf087fa4adb240f93d407184d3a451fc8">nlx_core_nidstr_decode()</a></code> and <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gac9644766a17ee27e52d75b64194a8933">nlx_core_nidstr_encode()</a></code> functions provide separate user and kernel implementations of this conversion code.</p>
<p>To convert a NID string to a NID, the user space core performs the following tasks.</p><ul>
<li>It declares a <code><a class="el" href="../../d8/d29/structm0__lnet__dev__nid__encdec__params.html">m0_lnet_dev_nid_encdec_params</a></code> and sets the <code>dn_buf</code> to the string to be decoded.</li>
<li>It calls the <code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga515e54b40a50371b20bc45917888f8fe">M0_LNET_NIDSTR_DECODE</a></code> ioctl request to cause the kernel to decode the string. On successful return, the <code>dn_nid</code> field will be set to the corresponding NID.</li>
</ul>
<p>To convert a NID into a NID string, the user space core performs the following tasks.</p><ul>
<li>It declares a <code><a class="el" href="../../d8/d29/structm0__lnet__dev__nid__encdec__params.html">m0_lnet_dev_nid_encdec_params</a></code> and sets the <code>dn_nid</code> to the value to be converted.</li>
<li>It calls the <code><a class="el" href="../../df/d9e/group___l_net_dev.html#ga3cec91339bba374817850a2613a0875e">M0_LNET_NIDSTR_ENCODE</a></code> ioctl request to cause the kernel to encode the string. On successful return, the <code>dn_buf</code> field will be set to the corresponding NID string.</li>
</ul>
<p>The final operations involving NID strings are the <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga37534378e7e83c213936decc2093c764">nlx_core_nidstrs_get()</a></code> and <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#gac79c6c9cc933d627df933fa895ed1555">nlx_core_nidstrs_put()</a></code> operations. The user space core obtains the strings from the kernel using the <code><a class="el" href="../../df/d9e/group___l_net_dev.html#gad30e698f8261f6659a86b6038f8c6aa0">M0_LNET_NIDSTRS_GET</a></code> ioctl request. This ioctl request returns a copy of the strings, rather than sharing a reference to them. As such, there is no ioctl request to "put" the strings. To get the list of strings, the user space core performs the following tasks.</p>
<ul>
<li>It allocates buffer where the NID strings are to be stored.</li>
<li>It declares a <code><a class="el" href="../../d4/d88/structm0__lnet__dev__nidstrs__get__params.html">m0_lnet_dev_nidstrs_get_params</a></code> object and sets the fields based on the allocated buffer and its size.</li>
<li>It performs a <code><a class="el" href="../../df/d9e/group___l_net_dev.html#gad30e698f8261f6659a86b6038f8c6aa0">M0_LNET_NIDSTRS_GET</a></code> ioctl request to populate the buffer with the NID strings, which returns the number of NID strings (not 0) on success.</li>
<li>If the ioctl request returns -EFBIG, the buffer should be freed, a larger buffer allocated, and the ioctl request re-attempted.</li>
<li>It allocates a <code>char**</code> array corresponding to the number of NID strings (plus 1 for the required terminating NULL pointer).</li>
<li>It populates this array by iterating over the now-populated buffer, adding a pointer to each nul-terminated NID string, until the number of strings returned by the ioctl request have been populated.</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-nids">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-state"></a>
State Specification</h2>
<p>The User Space Core implementation does not introduce its own state model, but operates within the frameworks defined by the Motr Networking Module and the Kernel device driver interface.</p>
<p>Use of the driver requires a file descriptor. This file descriptor is obtained as part of <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga5b6f0c3785f844e21283b04f1c7fa4c0">nlx_core_dom_init()</a></code> and closed as part of <code><a class="el" href="../../d3/d35/group___u_l_net_core.html#ga6581cd0b3aae790e5652cabe2c97ba3d">nlx_core_dom_fini()</a></code>.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec-state">Corresponding device layer behavior</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-thread"></a>
Threading and Concurrency Model</h2>
<p>The user space threading and concurrency model works in conjunction with the kernel core model. No additional behavior is added in user space.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../db/dd7/_k_l_net_core_d_l_d.html#KLNetCoreDLD-lspec-thread">Kernel Core Threading and Concurrency Model</a></dd></dl>
<h2><a class="anchor" id="ULNetCoreDLD-lspec-numa"></a>
NUMA optimizations</h2>
<p>The user space core does not allocate threads. The user space application can control thread processor affiliation by confining the threads it uses to via use of <code><a class="el" href="../../db/d41/group__kthread.html#gacd8c0a9923da5dbbd18419e6f003c36e">m0_thread_confine()</a></code>.</p>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-conformance"></a>
Conformance</h1>
<ul>
<li><b>i.m0.net.xprt.lnet.ioctl</b> The <a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-lspec">Logical Specification</a> covers how each LNet Core operation in user space is implemented using the driver ioctl requests.</li>
<li><b>i.m0.net.xprt.lnet.aligned-objects</b> The <a class="el" href="../../d8/d7d/_u_l_net_core_d_l_d.html#ULNetCoreDLD-lspec-malloc">Memory Allocation Strategy</a> section discusses how shared objects can be allocated as required.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-ut"></a>
Unit Tests</h1>
<p>Unit tests already exist for testing the core API. These tests have been used previously for the kernel core implementation. Since the user space must implement the same behavior, the unit tests will be reused.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d6/de0/_l_net_d_l_d.html#LNetDLD-ut">LNet Transport Unit Tests</a></dd></dl>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-st"></a>
System Tests</h1>
<p>System testing will be performed as part of the transport operation system test.</p>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-O"></a>
Analysis</h1>
<p>The overall design of the LNet transport already addresses the need to minimize data copying between the kernel and user space, and the need to minimize context switching. This is accomplished by use of shared memory and a circular buffer event queue maintained in shared memory. For more information, refer to the HLD. For documentation links, please refer to this file : doc/motr-design-doc-list.rst</p>
<p>In general, the User Core layer simply routes parameters to and from the Kernel Core via the LNet driver. The complexity of this routing is analyzed in <a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html#LNetDRVDLD-O">LNet Driver Analysis</a>.</p>
<p>The user core requires a small structure for each shared core structure. These user core private structures, e.g. <code><a class="el" href="../../d8/dbb/structnlx__ucore__domain.html">nlx_ucore_domain</a></code> are of fixed size and their number is directly proportional to the number of core objects allocated by the transport layer.</p>
<hr/>
 <h1><a class="anchor" id="ULNetCoreDLD-ref"></a>
References</h1>
<ul>
<li>HLD of Motr LNet Transport : For documentation links, please refer to this file : doc/motr-design-doc-list.rst</li>
<li><a class="el" href="../../db/dd7/_k_l_net_core_d_l_d.html">LNet Transport Kernel Core DLD</a></li>
<li><a class="el" href="../../da/d74/_l_net_d_r_v_d_l_d.html">LNet Transport Device DLD</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li><li class="navelem"><a class="el" href="../../d6/de0/_l_net_d_l_d.html">LNet Transport DLD</a></li>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:26 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
