<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: Motr Network Benchmark</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dd/df4/net-test.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Motr Network Benchmark </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-ovw">Overview</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-def">Definitions</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-req">Requirements</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-depends">Dependencies</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-highlights">Design Highlights</a></li>
<li><a class="el" href="../../d9/d5d/net-test-fspec.html">Functional Specification</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec">Logical Specification</a><ul>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-state">State Specification</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-numa">NUMA optimizations</a></li>
</ul>
</li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-conformance">Conformance</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-ut">Unit Tests</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-st">System Tests</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-O">Analysis</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lim">Current Limitations</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-issues">Know Issues</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-ref">References</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="net-test-ovw"></a>
Overview</h1>
<p>Motr network benchmark is designed to test network subsystem of Motr and network connections between nodes that are running Motr.</p>
<p>Motr Network Benchmark is implemented as a kernel module for test node and user space program for test console. Before testing kernel module must be copied to every test node. Then test console will perform test in this way:</p>
<div class="mscgraph">
<img src="../../msc_inline_mscgraph_10.png" alt="msc_inline_mscgraph_10" border="0" usemap="#msc_inline_mscgraph_10.map"/>
<map name="msc_inline_mscgraph_10.map" id="msc_inline_mscgraph_10.map"></map>
</div>
<hr/>
 <h1><a class="anchor" id="net-test-def"></a>
Definitions</h1>
<p>Previously defined terms: </p><dl class="section see"><dt>See also</dt><dd><a class="el" href="../../dd/df4/net-test.html#net-test-hld">Motr Network Benchmark HLD</a></dd></dl>
<p>New terms:</p><ul>
<li><b>Configuration variable</b> Variable with name. It can have some value.</li>
<li><b>Configuration</b> Set of name-value pairs.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="net-test-req"></a>
Requirements</h1>
<ul>
<li><b>R.m0.net.self-test.statistics</b> statistics from the all nodes can be collected on the test console.</li>
<li><b>R.m0.net.self-test.statistics.live</b> statistics from the all nodes can be collected on the test console at any time during the test.</li>
<li><b>R.m0.net.self-test.statistics.live</b> pdsh is used to perform statistics collecting from the all nodes with some interval.</li>
<li><b>R.m0.net.self-test.test.ping</b> latency is automatically measured for all messages.</li>
<li><b>R.m0.net.self-test.test.bulk</b> used messages with additional data.</li>
<li><b>R.m0.net.self-test.test.bulk.integrity.no-check</b> bulk messages additional data isn't checked.</li>
<li><b>R.m0.net.self-test.test.duration.simple</b> end user should be able to specify how long a test should run, by loop.</li>
<li><b>R.m0.net.self-test.kernel</b> test client/server is implemented as a kernel module.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="net-test-depends"></a>
Dependencies</h1>
<ul>
<li>R.m0.net</li>
</ul>
<hr/>
 <h1><a class="anchor" id="net-test-highlights"></a>
Design Highlights</h1>
<ul>
<li>m0_net is used as network library.</li>
<li>To make latency measurement error as little as possible all heavy operations (such as buffer allocation) will be done before test message exchanging between test client and test server.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="net-test-lspec"></a>
Logical Specification</h1>
<ul>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-comps">Component Overview</a><ul>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-ping">Ping Test</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-bulk">Bulk Test</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-algo-client-ping">Ping Test Client Algorithm</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-algo-client-bulk">Bulk Test Client Algorithm</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-algo-server-ping">Ping Test Server Algorithm</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-algo-server-bulk">Bulk Test Server Algorithm</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-console">Test Console</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-misc">Misc</a></li>
</ul>
</li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-state">State Specification</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-numa">NUMA optimizations</a></li>
</ul>
<h2><a class="anchor" id="net-test-lspec-comps"></a>
Component Overview</h2>
<div class="dotgraph">
<img src="../../dot_inline_dotgraph_27.png" alt="dot_inline_dotgraph_27.png" border="0" usemap="#dot_inline_dotgraph_27.map"/>
<map name="dot_inline_dotgraph_27.map" id="dot_inline_dotgraph_27.map"></map>
</div>
<p>Test node can be run in such a way:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d5/d60/structm0__net__test__node__ctx.html">m0_net_test_node_ctx</a> <a class="code" href="../../dc/daf/ut_2commands_8c.html#a781c241da0a7e3f1c71eeda91e3233c6">node</a>;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../dc/d6a/structm0__net__test__node__cfg.html">m0_net_test_node_cfg</a> cfg;</div><div class="line"><span class="keywordtype">int</span> <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line"><span class="comment">// prepare config, m0_init() etc.</span></div><div class="line"><a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d2/d9a/group___net_test_node_internals.html#ga8ba55d2661f8f03306fa6f5fe9397440">m0_net_test_node_init</a>(&amp;<a class="code" href="../../dc/daf/ut_2commands_8c.html#a781c241da0a7e3f1c71eeda91e3233c6">node</a>, &amp;cfg);</div><div class="line"><span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> == 0) {</div><div class="line">     <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d2/d9a/group___net_test_node_internals.html#gafe05512ba659d74f1982ae5219fa2390">m0_net_test_node_start</a>(&amp;<a class="code" href="../../dc/daf/ut_2commands_8c.html#a781c241da0a7e3f1c71eeda91e3233c6">node</a>);</div><div class="line">     <span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> == 0) {</div><div class="line">             <a class="code" href="../../d1/d5d/group__semaphore.html#ga13cc25845a0d00f79cc3397e12881c76">m0_semaphore_down</a>(&amp;<a class="code" href="../../dc/daf/ut_2commands_8c.html#a781c241da0a7e3f1c71eeda91e3233c6">node</a>.ntnc_thread_finished_sem);</div><div class="line">             <a class="code" href="../../d2/d9a/group___net_test_node_internals.html#ga7708df11be36d38ad2d8c0094b96f0f9">m0_net_test_node_stop</a>(&amp;<a class="code" href="../../dc/daf/ut_2commands_8c.html#a781c241da0a7e3f1c71eeda91e3233c6">node</a>);</div><div class="line">     }</div><div class="line">     <a class="code" href="../../d2/d9a/group___net_test_node_internals.html#ga302ad10cee5b68b976f65cc62fe5d5e9">m0_net_test_node_fini</a>(&amp;<a class="code" href="../../dc/daf/ut_2commands_8c.html#a781c241da0a7e3f1c71eeda91e3233c6">node</a>);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="net-test-lspec-ping"></a>
Ping Test</h3>
<p>One test message travel: </p><div class="mscgraph">
<img src="../../msc_inline_mscgraph_11.png" alt="msc_inline_mscgraph_11" border="0" usemap="#msc_inline_mscgraph_11.map"/>
<map name="msc_inline_mscgraph_11.map" id="msc_inline_mscgraph_11.map"></map>
</div>
<h3><a class="anchor" id="net-test-lspec-bulk"></a>
Bulk Test</h3>
<p>RTT is measured as length of time interval [time of transition to transfer start state, time of transition to transfer finish state]. See <a class="el" href="../../dd/df4/net-test.html#net-test-lspec-algo-client-bulk">Bulk Test Client Algorithm</a>, <a class="el" href="../../dd/df4/net-test.html#net-test-lspec-algo-server-bulk">Bulk Test Server Algorithm</a>.</p>
<p>One test message travel: </p><div class="mscgraph">
<img src="../../msc_inline_mscgraph_12.png" alt="msc_inline_mscgraph_12" border="0" usemap="#msc_inline_mscgraph_12.map"/>
<map name="msc_inline_mscgraph_12.map" id="msc_inline_mscgraph_12.map"></map>
</div>
<h3><a class="anchor" id="net-test-lspec-algo-client-ping"></a>
Ping Test Client Algorithm</h3>
<dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000191">Todo:</a></b></dt><dd>Outdated and not used now.</dd></dl>
<div class="dotgraph">
<img src="../../dot_inline_dotgraph_28.png" alt="dot_inline_dotgraph_28.png" border="0" usemap="#dot_inline_dotgraph_28.map"/>
<map name="dot_inline_dotgraph_28.map" id="dot_inline_dotgraph_28.map"></map>
</div>
<p>Callbacks for ping test</p><ul>
<li>M0_NET_QT_MSG_SEND<ul>
<li>update stats</li>
</ul>
</li>
<li>M0_NET_QT_MSG_RECV<ul>
<li>update stats</li>
<li>buf_free.up()</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="net-test-lspec-algo-sm-legend"></a>
State Machine Legend</h3>
<ul>
<li>Red solid arrow - state transition to "error" states.</li>
<li>Green bold arrow - state transition for "successful" operation.</li>
<li>Black dashed arrow - auto state transition (shouldn't be explicit).</li>
<li>State name in double oval - final state.</li>
</ul>
<h3><a class="anchor" id="net-test-lspec-algo-client-bulk"></a>
Bulk Test Client Algorithm</h3>
<div class="dotgraph">
<img src="../../dot_inline_dotgraph_29.png" alt="dot_inline_dotgraph_29.png" border="0" usemap="#dot_inline_dotgraph_29.map"/>
<map name="dot_inline_dotgraph_29.map" id="dot_inline_dotgraph_29.map"></map>
</div>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-algo-sm-legend">State Machine Legend</a></dd></dl>
<p>Bulk buffer pair states</p><ul>
<li>UNUSED - buffer pair is not used in buffer operations now. It is initial state of buffer pair.</li>
<li>QUEUED - buffer pair is queued or almost added to network bulk queue. See <a class="el" href="../../dd/df4/net-test.html#net-test-lspec-bulk-buf-states">RECEIVING state</a>.</li>
<li>BD_SENT - buffer descriptors for bulk buffer pair are sent or almost sent to the test server. See <a class="el" href="../../dd/df4/net-test.html#net-test-lspec-bulk-buf-states">RECEIVING state</a>.</li>
<li>CB_LEFT2(CB_LFET1) - there are 2 (or 1) network buffer callback(s) left for this buffer pair (including network buffer callback for the message with buffer descriptor).</li>
<li>TRANSFERRED - all buffer for this buffer pair and message with buffer descriptors was successfully executed.</li>
<li>FAILED2(FAILED1, FAILED) - some operation failed. Also 2 (1, 0) callbacks left for this buffer pair (like CB_LEFT2, CB_LEFT1).</li>
</ul>
<p>Initial state: UNUSED.</p>
<p>Final states: TRANSFERRED, FAILED.</p>
<p>Transfer start state: QUEUED.</p>
<p>Transfer finish state: TRANSFERRED.</p>
<p>Bulk buffer pair state transitions</p><ul>
<li>UNUSED -&gt; QUEUED<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#gae958234f9c9562dd6172f4f509238e9f">client_process_unused_bulk()</a><ul>
<li>add bulk buffer to passive bulk send queue, then add another bulk buffer in pair to passive recv queue</li>
</ul>
</li>
</ul>
</li>
<li>QUEUED -&gt; BD_SENT<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#ga31538d009a0ca504ebc003602aa7206f">client_process_queued_bulk()</a><ul>
<li>send msg buffer with bulk buffer descriptors</li>
</ul>
</li>
</ul>
</li>
<li>QUEUED -&gt; FAILED<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#gae958234f9c9562dd6172f4f509238e9f">client_process_unused_bulk()</a><ul>
<li>addition to passive send queue failed</li>
</ul>
</li>
</ul>
</li>
<li>QUEUED -&gt; FAILED1<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#gae958234f9c9562dd6172f4f509238e9f">client_process_unused_bulk()</a><ul>
<li>addition to passive recv queue failed<ul>
<li>remove from passive send queue already queued buffer</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>QUEUED -&gt; FAILED2<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#ga31538d009a0ca504ebc003602aa7206f">client_process_queued_bulk()</a><ul>
<li>bulk buffer network descriptors to ping buffer encoding failed<ul>
<li>dequeue already queued bulk buffers</li>
</ul>
</li>
<li>addition msg with bulk buffer descriptors to network queue failed<ul>
<li>dequeue already queued bulk buffers</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>BD_SENT -&gt; CB_LEFT2</li>
<li>CB_LEFT2 -&gt; CB_LEFT1</li>
<li>CB_LEFT1 -&gt; TRANSFERRED<ul>
<li>network buffer callback<ul>
<li>ev-&gt;nbe_status == 0</li>
</ul>
</li>
</ul>
</li>
<li>BD_SENT -&gt; FAILED2</li>
<li>CB_LEFT2 -&gt; FAILED1</li>
<li>CB_LEFT1 -&gt; FAILED<ul>
<li>network buffer callback<ul>
<li>ev-&gt;nbe_status != 0</li>
</ul>
</li>
</ul>
</li>
<li>FAILED2 -&gt; FAILED1</li>
<li>FAILED1 -&gt; FAILED<ul>
<li>network buffer callback</li>
</ul>
</li>
<li>TRANSFERRED -&gt; UNUSED<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#ga021fb48b0d908f8cabc07d5c96564c0a">node_bulk_state_transition_auto_all()</a><ul>
<li>stats: increase total number of number messages</li>
</ul>
</li>
</ul>
</li>
<li>FAILED -&gt; UNUSED<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#ga021fb48b0d908f8cabc07d5c96564c0a">node_bulk_state_transition_auto_all()</a><ul>
<li>stats: increase total number of test messages and number of failed messages</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="net-test-lspec-algo-server-ping"></a>
Ping Test Server Algorithm</h3>
<dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000192">Todo:</a></b></dt><dd>Outdated and not used now.</dd></dl>
<p>Test server allocates all necessary buffers and initializes transfer machine. Then it just works in transfer machine callbacks.</p>
<p>Ping test callbacks</p><ul>
<li>M0_NET_QT_MSG_RECV<ul>
<li>add buffer to msg send queue</li>
<li>update stats</li>
</ul>
</li>
<li>M0_NET_QT_MSG_SEND<ul>
<li>add buffer to msg recv queue</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="net-test-lspec-algo-server-bulk"></a>
Bulk Test Server Algorithm</h3>
<ul>
<li>Every bulk buffer have its own state.</li>
<li>Bulk test server maintains unused bulk buffers queue - the bulk buffer for messages transfer will be taken from this queue when buffer descriptor arrives. If there are no buffers in queue - then buffer descriptor will be discarded, and number of failed and total test messages will be increased.</li>
</ul>
<div class="dotgraph">
<img src="../../dot_inline_dotgraph_30.png" alt="dot_inline_dotgraph_30.png" border="0" usemap="#dot_inline_dotgraph_30.map"/>
<map name="dot_inline_dotgraph_30.map" id="dot_inline_dotgraph_30.map"></map>
</div>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../dd/df4/net-test.html#net-test-lspec-algo-sm-legend">State Machine Legend</a></dd></dl>
<p><a class="anchor" id="net-test-lspec-bulk-buf-states"></a> Bulk buffer states</p><ul>
<li>UNUSED - bulk buffer isn't currently used in network operations and can be used when passive bulk buffer decriptors arrive.</li>
<li>BD_RECEIVED - message with buffer descriptors was received from the test client.</li>
<li>RECEIVING - bulk buffer added to the active bulk receive queue. Bulk buffer enters this state just before adding to the network queue because network buffer callback may be executed before returning from 'add to network buffer queue' function.</li>
<li>SENDING - bulk buffer added to the active bulk send queue. Bulk buffer enters this state as well as for the RECEIVING state.</li>
<li>TRANSFERRED - bulk buffer was successfully received and sent.</li>
<li>FAILED - some operation failed.</li>
<li>BADMSG - message with buffer descriptors contains invalid data.</li>
</ul>
<p>Initial state: UNUSED.</p>
<p>Final states: TRANSFERRED, FAILED, BADMSG.</p>
<p>Transfer start state: RECEIVING.</p>
<p>Transfer finish state: TRANSFERRED.</p>
<p>Bulk buffer state transitions</p>
<ul>
<li>UNUSED -&gt; BD_RECEIVED<ul>
<li>M0_NET_QT_MSG_RECV callback<ul>
<li>message with buffer decriptors was received from the test client</li>
</ul>
</li>
</ul>
</li>
<li>BD_RECEIVED -&gt; BADMSG<ul>
<li>M0_NET_QT_MSG_RECV callback<ul>
<li>message with buffer decscriptors contains invalid data</li>
</ul>
</li>
</ul>
</li>
<li>BD_RECEIVED -&gt; RECEIVING<ul>
<li>M0_NET_QT_MSG_RECV callback<ul>
<li>bulk buffer was successfully added to active bulk receive queue.</li>
</ul>
</li>
</ul>
</li>
<li>RECEIVING -&gt; SENDING<ul>
<li>M0_NET_QT_ACTIVE_BULK_RECV callback<ul>
<li>bulk buffer was successfully received from the test client.</li>
</ul>
</li>
</ul>
</li>
<li>RECEIVING -&gt; FAILED<ul>
<li>M0_NET_QT_MSG_RECV callback<ul>
<li>addition to the active bulk receive queue failed.</li>
</ul>
</li>
<li>M0_NET_QT_ACTIVE_BULK_RECV callback<ul>
<li>bulk buffer receiving failed.</li>
</ul>
</li>
</ul>
</li>
<li>SENDING -&gt; TRANSFERRED<ul>
<li>M0_NET_QT_ACTIVE_BULK_SEND callback<ul>
<li>bulk buffer was successfully sent to the test client.</li>
</ul>
</li>
</ul>
</li>
<li>SENDING -&gt; FAILED<ul>
<li>M0_NET_QT_ACTIVE_BULK_RECV callback<ul>
<li>addition to the active bulk send queue failed.</li>
</ul>
</li>
<li>M0_NET_QT_ACTIVE_BULK_SEND callback<ul>
<li>active bulk sending failed.</li>
</ul>
</li>
</ul>
</li>
<li>TRANSFERRED -&gt; UNUSED<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#ga021fb48b0d908f8cabc07d5c96564c0a">node_bulk_state_transition_auto_all()</a><ul>
<li>stats: increase total number of number messages</li>
</ul>
</li>
</ul>
</li>
<li>FAILED -&gt; UNUSED<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#ga021fb48b0d908f8cabc07d5c96564c0a">node_bulk_state_transition_auto_all()</a><ul>
<li>stats: increase total number of test messages and number of failed messages</li>
</ul>
</li>
</ul>
</li>
<li>BADMSG -&gt; UNUSED<ul>
<li><a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#ga021fb48b0d908f8cabc07d5c96564c0a">node_bulk_state_transition_auto_all()</a><ul>
<li>stats: increase total number of test messages and number of bad messages</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="net-test-lspec-console"></a>
Test Console</h3>
<div class="mscgraph">
<img src="../../msc_inline_mscgraph_13.png" alt="msc_inline_mscgraph_13" border="0" usemap="#msc_inline_mscgraph_13.map"/>
<map name="msc_inline_mscgraph_13.map" id="msc_inline_mscgraph_13.map"></map>
</div>
<h3><a class="anchor" id="net-test-lspec-misc"></a>
Misc</h3>
<ul>
<li>Typed variables are used to store configuration.</li>
<li>Configuration variables are set in m0_net_test_config_init(). They should be never changed in other place.</li>
<li><a class="el" href="../../df/db3/structm0__net__test__stats.html">m0_net_test_stats</a> is used for keeping some data for sample, based on which min/max/average/standard deviation can be calculated.</li>
<li>m0_net_test_network_(msg/bulk)_(send/recv)_* is a wrapper around m0_net. This functions use m0_net_test_ctx as containter for buffers, callbacks, endpoints and transfer machine. Buffer/endpoint index (int in range [0, NR), where NR is number of corresponding elements) is used for selecting buffer/endpoint structure from m0_net_test_ctx.</li>
<li>All buffers are allocated in <a class="el" href="../../df/d38/group___net_test_network_internals.html#ga7a4ec3c1cbf2bc019165a65f7e9e794c">m0_net_test_network_ctx_init()</a>.</li>
<li>Endpoints can be added after <a class="el" href="../../df/d38/group___net_test_network_internals.html#ga7a4ec3c1cbf2bc019165a65f7e9e794c">m0_net_test_network_ctx_init()</a> using <a class="el" href="../../df/d38/group___net_test_network_internals.html#ga7fe069e07ad8fefbbd85d9a8e59d5bdb">m0_net_test_network_ep_add()</a>.</li>
</ul>
<h2><a class="anchor" id="net-test-lspec-state"></a>
State Specification</h2>
<div class="dotgraph">
<img src="../../dot_inline_dotgraph_31.png" alt="dot_inline_dotgraph_31.png" border="0" usemap="#dot_inline_dotgraph_31.map"/>
<map name="dot_inline_dotgraph_31.map" id="dot_inline_dotgraph_31.map"></map>
</div>
<h2><a class="anchor" id="net-test-lspec-thread"></a>
Threading and Concurrency Model</h2>
<ul>
<li>Configuration is not protected by any synchronization mechanism. Configuration is not intended to change after initialization, so no need to use synchronization mechanism for reading configuration.</li>
<li>struct <a class="el" href="../../df/db3/structm0__net__test__stats.html">m0_net_test_stats</a> is not protected by any synchronization mechanism.</li>
<li>struct m0_net_test_ctx is not protected by any synchronization mechanism.</li>
</ul>
<h2><a class="anchor" id="net-test-lspec-numa"></a>
NUMA optimizations</h2>
<ul>
<li>Configuration is not intended to change after initial initialization, so cache coherence overhead will not exists.</li>
<li>One <a class="el" href="../../df/db3/structm0__net__test__stats.html">m0_net_test_stats</a> per locality can be used. Summary statistics can be collected from all localities using <a class="el" href="../../d4/d3b/group___net_test_stats_internals.html#gaa43bebc6747cdb766e1ad33e9ff5e5d2">m0_net_test_stats_add_stats()</a> only when it needed.</li>
<li>One m0_net_test_ctx per locality can be used.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="net-test-conformance"></a>
Conformance</h1>
<ul>
<li><b>I.m0.net.self-test.statistics</b> user-space LNet implementation is used to collect statistics from all nodes.</li>
<li><b>I.m0.net.self-test.statistics.live</b> user-space LNet implementation is used to perform statistics collecting from the all nodes with some interval.</li>
<li><b>I.m0.net.self-test.test.ping</b> latency is automatically measured for all messages.</li>
<li><b>I.m0.net.self-test.test.bulk</b> used messages with additional data.</li>
<li><b>I.m0.net.self-test.test.bulk.integrity.no-check</b> bulk messages additional data isn't checked.</li>
<li><b>I.m0.net.self-test.test.duration.simple</b> end user is able to specify how long a test should run, by loop - see <a class="el" href="../../d6/d7b/net-test-fspec-cli-console.html">Test console command line parameters</a>.</li>
<li><b>I.m0.net.self-test.kernel</b> test client/server is implemented as a kernel module.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="net-test-ut"></a>
Unit Tests</h1>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000117">Test:</a></b></dt><dd><p class="startdd">Ping message send/recv over loopback device. </p>
<p>Concurrent ping messages send/recv over loopback device. </p>
<p>Bulk active send/passive receive over loopback device. </p>
<p>Bulk passive send/active receive over loopback device. </p>
<p>Statistics for sample with one value. </p>
<p>Statistics for sample with ten values. </p>
<p>Merge two <a class="el" href="../../df/db3/structm0__net__test__stats.html">m0_net_test_stats</a> structures with <a class="el" href="../../d4/d3b/group___net_test_stats_internals.html#gaa43bebc6747cdb766e1ad33e9ff5e5d2">m0_net_test_stats_add_stats()</a> </p>
<p class="enddd">Script for tool ping/bulk testing with two test nodes.</p>
</dd></dl>
<hr/>
 <h1><a class="anchor" id="net-test-st"></a>
System Tests</h1>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000118">Test:</a></b></dt><dd>Script for network benchmark ping/bulk self-testing over loopback device on single node. </dd></dl>
<hr/>
 <h1><a class="anchor" id="net-test-O"></a>
Analysis</h1>
<ul>
<li>all m0_net_test_stats_* functions have O(1) complexity;</li>
<li>one mutex lock/unlock per statistics update in test client/server/console;</li>
<li>one semaphore up/down per test message in test client;</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../dd/df4/net-test.html#net-test-hld">Motr Network Benchmark HLD</a></dd></dl>
<hr/>
 <h1><a class="anchor" id="net-test-lim"></a>
Current Limitations</h1>
<ul>
<li>test buffer for commands between test console and test node have size 16KiB now (see <a class="el" href="../../d9/d9e/group___net_test_commands_d_f_s.html#gga5aa2b2a690422e6f64b2a21ae84c4dcea7bdae8ced8ef57fd122fe8656914eb4f">M0_NET_TEST_CMD_SIZE_MAX</a>); <a class="anchor" id="net-test-sem-max-value"></a></li>
<li><a class="el" href="../../da/d23/structm0__net__test__cmd__ctx.html#aa976e134a5e21d9056ffcc0a4fecb734">m0_net_test_cmd_ctx.ntcc_sem_send</a>, <a class="el" href="../../da/d23/structm0__net__test__cmd__ctx.html#aadd49fb5e29764a2a02ab20cf32c70cb">m0_net_test_cmd_ctx.ntcc_sem_recv</a> and <a class="el" href="../../de/d6f/structnode__ping__ctx.html#a8d6dbe0516e98f7751417ad1f86b3bb0">node_ping_ctx.npc_buf_q_sem</a> can exceed SEMVMX (see 'man 3 sem_post', 'man 2 semop') if large number of network buffers used in the corresponding structures;</li>
</ul>
<hr/>
 <h1><a class="anchor" id="net-test-issues"></a>
Know Issues</h1>
<ul>
<li>Test console returns different number of transfers for test clients and test servers if time limit reached. It is because test node can't answer to STATUS command after STOP command. Possible solution: split STOP command to 2 different commands - "stop sending test messages" and "finalize test messages transfer machine" (now STOP command handler performs these actions) - in this case STATUS command can be sent after "stop sending test messages" command.</li>
<li>Bulk test worker thread (<a class="el" href="../../dd/da5/group___net_test_bulk_node_internals.html#ga9b93ecc4c89c4f4d0cca7c9beccd2d33">node_bulk_worker()</a>): it is possible for the test server to have all work done in single <a class="el" href="../../d9/dd2/group__net.html#gac14378833476363fc5dce912b9481de1">m0_net_buffer_event_deliver_all()</a>, especially if number of concurrent buffers is high. STATUS command will give inconsistent results for test clients and test servers in this case. Workaround: use stats from the test client in bulk test.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="net-test-ref"></a>
References</h1>
<p><a class="anchor" id="net-test-hld"></a></p><ul>
<li>Motr Network Benchmark HLD : For documentation links, please refer to this file : doc/motr-design-doc-list.rst</li>
<li><a href="http://wiki.lustre.org/manual/LustreManual20_HTML/
LNETSelfTest.html">LNET Self-Test manual</a></li>
<li><a href="http://reviewboard.clusterstor.com/r/773">DLD review request</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:27 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
