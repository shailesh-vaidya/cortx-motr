<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: Distributed Lock DLD</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dd/d8f/_read_write.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Distributed Lock DLD </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD">Overview</a></li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-req">Requirements</a></li>
<li>RWLockDLD-depends</li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-fspec">Functional Specification</a></li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-lspec">Logical Specification</a><ul>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-lspec-comps">Component Overview</a></li>
<li>RWLockDLD-lspec-numa</li>
</ul>
</li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-conformance">Conformance</a></li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-ut">Unit Tests</a></li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-st">System Tests</a></li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-ref">References</a></li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-impl-plan">Implementation Plan</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="RWLockDLD"></a>
Overview</h1>
<p>This DLD describes the implementation of a distributed RW lock. The distributed RW lock is implemented over Motr resource manager. Distributed RW Lock allows concurrent access for read-only operations, while write operations require exclusive access.</p>
<p><b>Purpose of a DLD</b> <br />
The purpose of the Detailed Level Design (DLD) specification of a distributed RW lock is to:</p><ul>
<li>Describe RW lockable resource type of Motr resource manager</li>
<li>Define interface that allows to acquire RW locks for RW lockable resources</li>
</ul>
<hr/>
 <h1><a class="anchor" id="RWLockDLD-req"></a>
Requirements</h1>
<ul>
<li><b>R.rm-rw-lock.async</b> The distributed RW lock should provide async interfaces.</li>
<li><b>R.rm-rw-lock.RM</b> The distributed RW lock shall use RM (resource manager) to implement the interfaces.</li>
<li><b>R.rm-rw-lock.sharedread</b> All readers can hold RW lock concurrently if no writer exists.</li>
<li><b>R.rm-rw-lock.exclusivewrite</b> Only one writer can hold RW lock at any given time in the whole cluster. Also no readers can hold RW lock if writer holding the RW lock exists.</li>
<li><b>R.rm-rw-lock.livelock</b> Livelock should be avoided when writer can't acquire the lock because of continuous lock requests from readers.</li>
</ul>
<h1><a class="anchor" id="RWLockDLD-lspec"></a>
Logical Specification</h1>
<ul>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d0/ddf/group___r_w_lock_internal.html">Distributed RW Lock Internals</a> <br />
- RWLockDLD-lspec-numa</li>
</ul>
<h2><a class="anchor" id="RWLockDLD-lspec-comps"></a>
Component Overview</h2>
<p>The distributed RW lock implements following resource manager ops:</p><ul>
<li>resource type ops</li>
<li>resource ops</li>
<li>resource credit ops</li>
</ul>
<p>Special wrappers are provided for RW lock user.</p>
<hr/>
 <h1><a class="anchor" id="RWLockDLD-conformance"></a>
Conformance</h1>
<ul>
<li><b>I.rm-rw-lock.async</b> The interfaces are async.</li>
<li><b>I.rm-rw-lock.RM</b> Implements RM ops to implement RW lock resource.</li>
<li><b>I.rm-rw-lock.sharedread</b> Usage credit requests from readers are always satisfied if no active writer exists.</li>
<li><b>I.rm-rw-lock.exclusivewrite</b> Writer requests all existing usage credits for RW lock in the whole cluster. Therefore at any given time only one writer can hold the lock. Usage credit requests from readers can't be satisfied when there is writer holding the lock.</li>
<li><b>I.rm-rw-lock.livelock</b> Livelock can be avoided by using M0_RPF_BARRIER pins, but not implemented yet.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="RWLockDLD-ut"></a>
Unit Tests</h1>
<p>Following scenarios will be tested: </p><dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000119">Test:</a></b></dt><dd>1) Request read lock when RW lock is not held by anyone else<ul>
<li>result: lock is granted immediately</li>
</ul>
</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000120">Test:</a></b></dt><dd>2) Request read lock when RW lock is held by another reader<ul>
<li>result: lock is granted immediately</li>
</ul>
</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000121">Test:</a></b></dt><dd>3) Request read lock when RW lock is held by writer<ul>
<li>result: lock is granted after writer releases it</li>
</ul>
</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000122">Test:</a></b></dt><dd>4) Request write lock when RW lock is not held by anyone else<ul>
<li>result: lock is granted immediately</li>
</ul>
</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000123">Test:</a></b></dt><dd>5) Request write lock when RW lock is held by reader<ul>
<li>result: lock is granted after reader releases it</li>
</ul>
</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000124">Test:</a></b></dt><dd>5) Request write lock when RW lock is held by writer<ul>
<li>result: lock is granted after writer releases it</li>
</ul>
</dd></dl>
<hr/>
 <h1><a class="anchor" id="RWLockDLD-st"></a>
System Tests</h1>
<p>System tests will be performed by the subsystem that uses the distributed RW lock.</p>
<hr/>
 <h1><a class="anchor" id="RWLockDLD-ref"></a>
References</h1>
<ul>
<li>HLD of resource manager Interfaces : For documentation links, please refer to this file : doc/motr-design-doc-list.rst</li>
</ul>
<hr/>
 <h1><a class="anchor" id="RWLockDLD-impl-plan"></a>
Implementation Plan</h1>
<p>The plan is:</p><ul>
<li><a class="el" href="../../d9/dfe/structm0__rm__resource__type__ops.html">m0_rm_resource_type_ops</a></li>
<li><a class="el" href="../../d3/d16/structm0__rm__resource__ops.html">m0_rm_resource_ops</a></li>
<li><a class="el" href="../../d0/d64/structm0__rm__credit__ops.html">m0_rm_credit_ops</a></li>
<li>external interface for RW lock user</li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-fspec-ds">Data Structures</a></li>
<li><a class="el" href="../../dd/d8f/_read_write.html#RWLockDLD-fspec-sub">Subroutines</a></li>
</ul>
<h1><a class="anchor" id="RWLockDLD-fspec"></a>
Functional Specification</h1>
<p>This section describes the data structure and the external interfaces of the distributed RW lock implemented using resource manager.</p>
<h1><a class="anchor" id="RWLockDLD-fspec-ds"></a>
Data Structures</h1>
<p>The distributed RW lock will have the following data structure:</p><ul>
<li><a class="el" href="../../dc/d32/structm0__rw__lockable.html">m0_rw_lockable</a> This holds generic RM resource and pointer to the fid identifying it. RW lock itself is represented by <a class="el" href="../../d6/d46/structm0__rm__credit.html">m0_rm_credit</a> which can be granted for RW lockable resource.</li>
</ul>
<h1><a class="anchor" id="RWLockDLD-fspec-sub"></a>
Subroutines</h1>
<p>The asynchronous distributed RW lock provides the functions listed in in the sub-sections below:</p>
<h2><a class="anchor" id="RWLockDLD-fspec-sub-cons"></a>
Constructors and Destructors</h2>
<h2><a class="anchor" id="RWLockDLD-fspec-sub-opi"></a>
Operational Interfaces</h2>
<ul>
<li><a class="el" href="../../d0/d26/group___distributed.html#ga2800c17d9c5729d148e72e9627a84744">m0_rw_lockable_init()</a></li>
<li><a class="el" href="../../d0/d26/group___distributed.html#ga9f8c4a76d62db4a60d53af206579d2fc">m0_rw_lockable_fini()</a></li>
<li><a class="el" href="../../d0/d26/group___distributed.html#ga09c9bd19c2ad7e07e2adfdefc9f83cea">m0_rm_rwlock_owner_init()</a></li>
<li><a class="el" href="../../d0/d26/group___distributed.html#ga43d649ef422c37e25065f6c9d6bc122e">m0_rm_rwlock_owner_fini()</a></li>
<li><a class="el" href="../../d0/d26/group___distributed.html#gaec14c8481849e52572f1ceb59da13c75">m0_rm_rwlock_req_init()</a></li>
<li><a class="el" href="../../d0/d26/group___distributed.html#ga38dffb818fa32f65bbabf438c7cbf8b2">m0_rm_rwlock_req_fini()</a></li>
<li><a class="el" href="../../d0/d26/group___distributed.html#gacaa4e46aed9b9636afc4136b47122ba7">m0_rw_lockable_type_register()</a></li>
<li><a class="el" href="../../d0/d26/group___distributed.html#gab3a52ab89ca96b74d3f1195643fb4daf">m0_rw_lockable_type_deregister()</a></li>
</ul>
<p>Initialization and acquiring of RW lock for writing: </p><div class="fragment"><div class="line"><a class="code" href="../../da/d7a/group___r_w_lock.html#ga2800c17d9c5729d148e72e9627a84744">m0_rw_lockable_init</a>(lockable, <a class="code" href="../../d4/d00/ut_2di_8c.html#a051b4db29ee353e8028232061faeaa22">fid</a>, <a class="code" href="../../dc/d74/addb2_2ut_2storage_8c.html#a6b9f7e6115c241d0a8ea3087490f1043">dom</a>);</div><div class="line"><a class="code" href="../../dd/d5f/group__fid.html#ga66fb0fa971ce7e90bf09d5d6bc468eaf">m0_fid_tgenerate</a>(&amp;owner_fid, <a class="code" href="../../d2/deb/group__rm.html#gga5c0bfe186e4d64c38a6c4fb9a76a9419ac10ca7a211f997951eb2cd463e4612b7">M0_RM_OWNER_FT</a>);</div><div class="line"><a class="code" href="../../da/d7a/group___r_w_lock.html#ga09c9bd19c2ad7e07e2adfdefc9f83cea">m0_rm_rwlock_owner_init</a>(owner, &amp;owner_fid, lockable, <a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ad38c63adeb01bf5401893843423a9bf1">creditor</a>);</div><div class="line"></div><div class="line"><a class="code" href="../../da/d7a/group___r_w_lock.html#gaec14c8481849e52572f1ceb59da13c75">m0_rm_rwlock_req_init</a>(<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ac1fb8115dcbccb2cdc6477b47df13a3a">req</a>, owner, <a class="code" href="../../d9/dc2/group__io__foms.html#gae1f1a711ed63882d5ee2131824e2d9ff">ops</a>,</div><div class="line">                      <a class="code" href="../../d2/deb/group__rm.html#gga7ad065e42df568aba543a60625f372b7aa2d2b4f5e0e5f9bc0c197c77524fea88">RIF_MAY_BORROW</a> | <a class="code" href="../../d2/deb/group__rm.html#gga7ad065e42df568aba543a60625f372b7af6e7b4d4dcd1a17ae74b2458f7576e0a">RIF_MAY_REVOKE</a>,</div><div class="line">                      <a class="code" href="../../d0/d26/group___distributed.html#ggaeab9315174471992a264949bdda17a5ea4b3f046c8a1e4d71cbdd7ac0efb1c2eb">RM_RWLOCK_WRITE</a>);</div><div class="line"><a class="code" href="../../d2/deb/group__rm.html#ga35b16fb825a3e37b39bace544db5abe5">m0_rm_credit_get</a>(<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ac1fb8115dcbccb2cdc6477b47df13a3a">req</a>);</div><div class="line"><a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d1/dc1/group__sm.html#ga6fccf375389b1976365de53a5517da37">m0_sm_timedwait</a>(&amp;in-&gt;rin_sm,</div><div class="line">                     <a class="code" href="../../df/d2a/lib_2misc_8h.html#ae644c20b9d43e4e0810716647b3d16be">M0_BITS</a>(<a class="code" href="../../d2/deb/group__rm.html#ggac2f51681a3d684fc08532896786ec28ba88389a0d8bc1349784b32cd3cddefe98">RI_SUCCESS</a>, <a class="code" href="../../d2/deb/group__rm.html#ggac2f51681a3d684fc08532896786ec28baaf859403af78d23d85aedee521fc18d7">RI_FAILURE</a>),</div><div class="line">                     <a class="code" href="../../d9/d7d/group__time.html#ga846e2e2bf3e3fb8894e8caca0f7689e3">M0_TIME_NEVER</a>);</div><div class="line"></div><div class="line">...</div><div class="line">m0_rm_credit_put(<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ac1fb8115dcbccb2cdc6477b47df13a3a">req</a>);</div><div class="line"><a class="code" href="../../da/d7a/group___r_w_lock.html#ga38dffb818fa32f65bbabf438c7cbf8b2">m0_rm_rwlock_req_fini</a>(<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ac1fb8115dcbccb2cdc6477b47df13a3a">req</a>)</div><div class="line"></div><div class="line"><a class="code" href="../../da/d7a/group___r_w_lock.html#ga43d649ef422c37e25065f6c9d6bc122e">m0_rm_rwlock_owner_fini</a>(owner);</div><div class="line"><a class="code" href="../../da/d7a/group___r_w_lock.html#ga9f8c4a76d62db4a60d53af206579d2fc">m0_rw_lockable_fini</a>(lockable);</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:27 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
