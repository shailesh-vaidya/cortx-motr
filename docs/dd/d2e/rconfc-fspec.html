<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: Redundant Configuration Client (rconfc)</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dd/d2e/rconfc-fspec.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Redundant Configuration Client (rconfc) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Redundant configuration client library &ndash; rconfc &ndash; provides an interface for Motr applications working in cluster with multiple configuration servers (confd).</p>
<p>Rconfc supplements confc functionality and processes situations when cluster dynamically changes configuration or loses connection to some of confd servers.</p>
<ul>
<li><a class="el" href="../../dd/d2e/rconfc-fspec.html#rconfc-fspec-data">Data Structures</a></li>
<li><a class="el" href="../../dd/d2e/rconfc-fspec.html#rconfc-fspec-sub">Subroutines</a></li>
<li><a class="el" href="../../dd/d2e/rconfc-fspec.html#rconfc-fspec-routines">Initialisation, finalisation and reading data</a></li>
<li><a class="el" href="../../df/d15/group__rconfc__dfspec.html">Detailed Functional Specification</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="rconfc-fspec-data"></a>
Data Structures</h1>
<ul>
<li><a class="el" href="../../d2/d9e/structm0__rconfc.html">m0_rconfc</a> &mdash; an instance of redundant configuration client.</li>
</ul>
<p><a class="el" href="../../d2/d9e/structm0__rconfc.html">m0_rconfc</a> structure includes a dedicated <a class="el" href="../../dd/d03/structm0__confc.html">m0_confc</a> instance <a class="el" href="../../d2/d9e/structm0__rconfc.html#ab4c2761f81f0911021207cfe20b75f22">m0_rconfc::rc_confc</a>, which is intended for conventional configuration reading.</p>
<p>Beside of that, it contains two lists of confc instances, the one used for communication with multiple confd servers in cluster environment during configuration version election, and the other one used for keeping list of discovered confd servers that run the same version that has won in the most recent election.</p>
<hr/>
 <h1><a class="anchor" id="rconfc-fspec-sub"></a>
Subroutines</h1>
<ul>
<li><a class="el" href="../../df/d15/group__rconfc__dfspec.html#ga7371c86b0f8ffc8fd70016b1d6f39da2">m0_rconfc_init()</a> initialises rconfc internals.</li>
<li><a class="el" href="../../df/d15/group__rconfc__dfspec.html#ga30d22166cd72ba7dca127c14eac03e59">m0_rconfc_start()</a> carries out configuration version election. During election all known confd servers are polled for a number of version they run. The elected version, i.e. the version having the quorum, is used in further configuration reading operation. In case quorum is reached, <a class="el" href="../../d2/d9e/structm0__rconfc.html">m0_rconfc</a> connects the dedicated <a class="el" href="../../d2/d9e/structm0__rconfc.html#ab4c2761f81f0911021207cfe20b75f22">m0_rconfc::rc_confc</a> to one of the confd servers from active list.</li>
<li><a class="el" href="../../df/d15/group__rconfc__dfspec.html#gaa60d0cf80399e8d96afd2389c10660d5">m0_rconfc_start_sync()</a> is synchronous version of <a class="el" href="../../df/d15/group__rconfc__dfspec.html#ga30d22166cd72ba7dca127c14eac03e59">m0_rconfc_start()</a>.</li>
<li><a class="el" href="../../df/d15/group__rconfc__dfspec.html#gae604bd67ad0690514cde2749809b203c">m0_rconfc_stop()</a> disconnects dedicated confc and release other internal resources.</li>
<li><a class="el" href="../../df/d15/group__rconfc__dfspec.html#gaf2e40c95204318391ec2bd4c3187c913">m0_rconfc_stop_sync()</a> is synchronous version of <a class="el" href="../../df/d15/group__rconfc__dfspec.html#gae604bd67ad0690514cde2749809b203c">m0_rconfc_stop()</a>.</li>
<li><a class="el" href="../../df/d15/group__rconfc__dfspec.html#ga801db00e66f8d2e4369748df5e98402a">m0_rconfc_fini()</a> finalises rconfc instance.</li>
<li><a class="el" href="../../df/d15/group__rconfc__dfspec.html#ga4ef6d177d0d6c7b0b69460a50e9cebb2">m0_rconfc_ver_max_read()</a> reports the maximum configuration version number the confd servers responded with during the most recent version election.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="rconfc-fspec-routines"></a>
Initialisation, finalisation and reading data</h1>
<p>To access configuration data the configuration consumer is allowed to follow two different scenarios:</p>
<ul>
<li>reading with standalone configuration client (confc)</li>
<li>reading with confc exposed from redundant configuration client (rconfc)</li>
</ul>
<p>In the first case the consumer reads data from particular confd server with no regard to whether its version reached quorum or not.</p>
<p>In the second case the consumer is guaranteed to read data from configuration that reached the quorum in the cluster, i.e. the most recent consistent one. As well, the consumer is guaranteed to be notified about the fact of configuration change, to let accommodate with the change if required. In addition, the ability to switch among confd servers in case of network error transparently for the consumer sufficiently strengthens the reading reliability, and due to this, cluster robustness in whole.</p>
<p>In the latter case the consumer initialises and starts <a class="el" href="../../d2/d9e/structm0__rconfc.html">m0_rconfc</a> instance instead of <a class="el" href="../../dd/d03/structm0__confc.html">m0_confc</a>, and performs all further reading via <a class="el" href="../../d2/d9e/structm0__rconfc.html#ab4c2761f81f0911021207cfe20b75f22">m0_rconfc::rc_confc</a>.</p>
<p>Also, the consumer using rconfc doesn't provide any confd addresses explicitly. The list of confd servers and other related information is centralised and is maintained by HA service. Rconfc queries this information on startup.</p>
<p>Example:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d1/d75/rconfc_8h.html">conf/rconfc.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d5/d99/obj_8h.html">conf/obj.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d5/d32/structm0__sm__group.html">m0_sm_group</a>    *<a class="code" href="../../d0/d45/bytecount_8c.html#acd41fa5833804f5ea4357994c4426f90">grp</a> = ...;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d9/d36/structm0__rpc__machine.html">m0_rpc_machine</a> *rpcm = ...;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d2/d9e/structm0__rconfc.html">m0_rconfc</a>       <a class="code" href="../../de/de2/client__init_8c.html#a5ad0da5653dba50eeb4737237784935f">rconfc</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> conf_exp_cb(<span class="keyword">struct</span> <a class="code" href="../../d2/d9e/structm0__rconfc.html">m0_rconfc</a> *<a class="code" href="../../de/de2/client__init_8c.html#a5ad0da5653dba50eeb4737237784935f">rconfc</a>)</div><div class="line">{</div><div class="line">        ...   clean up all <a class="code" href="../../d2/d66/group__dtm.html#ga46b3af81e9fb5398c7af9b5cd3f70951">local</a> copies of configuration <a class="code" href="../../d4/d00/ut_2di_8c.html#a3de5f992cc2347f66878d072e5934900">data</a>    ...</div><div class="line">        ... close all <a class="code" href="../../df/da6/structm0__conf__obj.html">m0_conf_obj</a> instances retained by consumer ...</div><div class="line">}</div><div class="line"></div><div class="line">startup(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d9/d8a/structm0__fid.html">m0_fid</a> *<a class="code" href="../../d5/d9a/ut_2rconfc_8c.html#a528b949f1ba9f91f623c6ee9da961762">profile</a>, ...)</div><div class="line">{</div><div class="line">        <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../db/d90/group__rconfc__dlspec.html#ga7371c86b0f8ffc8fd70016b1d6f39da2">m0_rconfc_init</a>(&amp;<a class="code" href="../../de/de2/client__init_8c.html#a5ad0da5653dba50eeb4737237784935f">rconfc</a>, <a class="code" href="../../d0/d45/bytecount_8c.html#acd41fa5833804f5ea4357994c4426f90">grp</a>, rpcm, conf_exp_cb);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> == 0) {</div><div class="line">             <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../df/d15/group__rconfc__dfspec.html#gaa60d0cf80399e8d96afd2389c10660d5">m0_rconfc_start_sync</a>(&amp;<a class="code" href="../../de/de2/client__init_8c.html#a5ad0da5653dba50eeb4737237784935f">rconfc</a>);</div><div class="line">             <span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> != 0)</div><div class="line">                     <a class="code" href="../../db/d90/group__rconfc__dlspec.html#gaf2e40c95204318391ec2bd4c3187c913">m0_rconfc_stop_sync</a>(&amp;<a class="code" href="../../de/de2/client__init_8c.html#a5ad0da5653dba50eeb4737237784935f">rconfc</a>);</div><div class="line">        }</div><div class="line">        ...</div><div class="line">}</div><div class="line"></div><div class="line">... Access configuration objects, <span class="keyword">using</span> <a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a> interfaces. ...</div><div class="line"></div><div class="line">reading(...)</div><div class="line">{</div><div class="line">       <span class="keyword">struct </span><a class="code" href="../../df/da6/structm0__conf__obj.html">m0_conf_obj</a> *<a class="code" href="../../dc/dc9/ut_2tlist_8c.html#a21dc5b93c91d40e224e7bb5fc98016eb">obj</a>;</div><div class="line">       <span class="keyword">struct </span><a class="code" href="../../dd/d03/structm0__confc.html">m0_confc</a>    *<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a> = &amp;<a class="code" href="../../de/de2/client__init_8c.html#a5ad0da5653dba50eeb4737237784935f">rconfc</a>.<a class="code" href="../../d2/d9e/structm0__rconfc.html#ab4c2761f81f0911021207cfe20b75f22">rc_confc</a>;</div><div class="line">       <span class="keywordtype">int</span>                 <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line">       <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d0/dca/group__confc__dfspec.html#gaf016ccec50caf97507eecef0d75e1857">m0_confc_open_sync</a>(&amp;<a class="code" href="../../dc/dc9/ut_2tlist_8c.html#a21dc5b93c91d40e224e7bb5fc98016eb">obj</a>, <a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a>-&gt;<a class="code" href="../../dd/d03/structm0__confc.html#a668c917c87cec73ef50eece253628448">cc_root</a>, ... );</div><div class="line">       ... read <span class="keywordtype">object</span> <a class="code" href="../../d4/d00/ut_2di_8c.html#a3de5f992cc2347f66878d072e5934900">data</a> ...</div><div class="line">       <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga899a22f1dafd4ffbb22f6d72e1590ddc">m0_confc_close</a>(<a class="code" href="../../dc/dc9/ut_2tlist_8c.html#a21dc5b93c91d40e224e7bb5fc98016eb">obj</a>);</div><div class="line">}</div><div class="line"></div><div class="line">shutdown(...)</div><div class="line">{</div><div class="line">        <a class="code" href="../../db/d90/group__rconfc__dlspec.html#gaf2e40c95204318391ec2bd4c3187c913">m0_rconfc_stop_sync</a>(&amp;<a class="code" href="../../de/de2/client__init_8c.html#a5ad0da5653dba50eeb4737237784935f">rconfc</a>);</div><div class="line">        <a class="code" href="../../db/d90/group__rconfc__dlspec.html#ga801db00e66f8d2e4369748df5e98402a">m0_rconfc_fini</a>(&amp;<a class="code" href="../../de/de2/client__init_8c.html#a5ad0da5653dba50eeb4737237784935f">rconfc</a>);</div><div class="line">}</div></div><!-- fragment --><p>For asynchronous rconfc start/stop please see details of <a class="el" href="../../df/d15/group__rconfc__dfspec.html#gaa60d0cf80399e8d96afd2389c10660d5">m0_rconfc_start_sync()</a>, <a class="el" href="../../df/d15/group__rconfc__dfspec.html#gaf2e40c95204318391ec2bd4c3187c913">m0_rconfc_stop_sync()</a> implementation or documentation for <a class="el" href="../../df/d15/group__rconfc__dfspec.html#ga30d22166cd72ba7dca127c14eac03e59">m0_rconfc_start()</a>, <a class="el" href="../../df/d15/group__rconfc__dfspec.html#gae604bd67ad0690514cde2749809b203c">m0_rconfc_stop()</a>.</p>
<dl class="section note"><dt>Note</dt><dd>Consumer is allowed to use any standard approach for opening configuration and traversing directories in accordance with confc specification. Using rconfc puts no additional limitation other than stipulated by proper <a class="el" href="../../df/d15/group__rconfc__dfspec.html#ga7371c86b0f8ffc8fd70016b1d6f39da2">m0_rconfc_init()</a>.</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../df/d15/group__rconfc__dfspec.html">Detailed Functional Specification</a> </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li><li class="navelem"><a class="el" href="../../d2/dd9/conf.html">DLD of configuration caching</a></li>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:24 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
