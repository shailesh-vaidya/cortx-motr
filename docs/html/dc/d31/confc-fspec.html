<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: Configuration Client (confc)</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dc/d31/confc-fspec.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Configuration Client (confc) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Configuration client library &ndash; confc &ndash; provides user-space and kernel interfaces for accessing Motr configuration information.</p>
<p>Confc obtains configuration data from network-accessible configuration server (confd) and caches this data in memory.</p>
<ul>
<li><a class="el" href="../../dc/d31/confc-fspec.html#confc-fspec-data">Data Structures</a></li>
<li><a class="el" href="../../dc/d31/confc-fspec.html#confc-fspec-sub">Subroutines</a><ul>
<li><a class="el" href="../../dc/d31/confc-fspec.html#confc-fspec-sub-setup">Initialization and termination</a></li>
<li><a class="el" href="../../dc/d31/confc-fspec.html#confc-fspec-sub-use">Accessing configuration objects</a></li>
</ul>
</li>
<li><a class="el" href="../../dc/d31/confc-fspec.html#confc-fspec-recipes">Recipes</a><ul>
<li><a class="el" href="../../dc/d31/confc-fspec.html#confc-fspec-recipe1">Get profile configuration</a></li>
<li><a class="el" href="../../dc/d31/confc-fspec.html#confc-fspec-recipe2">Iterate directory object asynchronously</a></li>
</ul>
</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html">Detailed Functional Specification</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="confc-fspec-data"></a>
Data Structures</h1>
<ul>
<li><a class="el" href="../../dd/d03/structm0__confc.html">m0_confc</a> &mdash; an instance of configuration client. This structure contains <a class="el" href="../../d0/d1a/structm0__conf__cache.html">m0_conf_cache</a>, which represents configuration cache. <a class="el" href="../../dd/d03/structm0__confc.html">m0_confc</a> also keeps reference to the state machine group that synchronizes state machines created by this confc.</li>
<li><a class="el" href="../../de/d82/structm0__confc__ctx.html">m0_confc_ctx</a> &mdash; configuration retrieval context. This structure embodies data needed by a state machine to process configuration request.</li>
<li><a class="el" href="../../d2/d4b/structm0__conf__diter.html">m0_conf_diter</a> &mdash; configuration directory iterator. This structure maintains multiple levels of a configuration directory path and data needed for its traversal. Each directory level is represented by <a class="el" href="../../d1/df0/structm0__conf__diter__lvl.html">m0_conf_diter_lvl</a>. Each <a class="el" href="../../d1/df0/structm0__conf__diter__lvl.html">m0_conf_diter_lvl</a> contains 2 objects of <a class="el" href="../../de/d82/structm0__confc__ctx.html">m0_confc_ctx</a> corresponding to <a class="el" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open()</a> and <a class="el" href="../../d0/dca/group__confc__dfspec.html#gac29f7f13b3453fbf03379a823a4307c3">m0_confc_readdir()</a> operations, which are re-used for subsequent iterations for that directory level. <a class="el" href="../../d2/d4b/structm0__conf__diter.html">m0_conf_diter</a> traverses the configuration directory tree in depth first order.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="confc-fspec-sub"></a>
Subroutines</h1>
<ul>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#gabf209a6bf58ef464c9b0798e897a59c2">m0_confc_init()</a> initialises configuration cache, creates a stub for the root object (<a class="el" href="../../d5/d7c/structm0__conf__root.html">m0_conf_root</a>). If user specifies profile, then a stub for the profile (<a class="el" href="../../d6/d2f/structm0__conf__profile.html">m0_conf_profile</a>) is also created.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#ga246f8e1e88c76a3045fa0762fd5712ed">m0_confc_fini()</a> finalises confc, destroys configuration cache.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#ga91bf72b4f1a8aac4121111c141d804d4">m0_confc_ctx_init()</a> initialises context object, which will be used by <a class="el" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open()</a> function.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#ga56b93a0699b96051fc7430fd0ce40286">m0_confc_ctx_fini()</a> finalises context object.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open()</a> requests asynchronous opening of a configuration object.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#gaf016ccec50caf97507eecef0d75e1857">m0_confc_open_sync()</a> opens configuration object synchronously.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#ga899a22f1dafd4ffbb22f6d72e1590ddc">m0_confc_close()</a> closes configuration object.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#ga3345102f46c980aef89a53a342ace13a">m0_confc_ctx_error()</a> returns error status of an asynchronous configuration retrieval operation.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#ga174008a1ed4337cf57da2f53faa7bfd3">m0_confc_ctx_result()</a> is used to obtain the resulting configuration object from <a class="el" href="../../de/d82/structm0__confc__ctx.html">m0_confc_ctx</a>.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#gac29f7f13b3453fbf03379a823a4307c3">m0_confc_readdir()</a> gets next directory entry. If the entry is not cached yet, <a class="el" href="../../d0/dca/group__confc__dfspec.html#gac29f7f13b3453fbf03379a823a4307c3">m0_confc_readdir()</a> initiates asynchronous retrieval of configuration data.</li>
<li><a class="el" href="../../d0/dca/group__confc__dfspec.html#gab395786643873d814ddbb951571ddd14">m0_confc_readdir_sync()</a> gets next directory entry synchronously.</li>
</ul>
<h2><a class="anchor" id="confc-fspec-sub-setup"></a>
Initialization and termination</h2>
<p>Prior to accessing configuration, the application (aka configuration consumer) should initialise configuration client by calling <a class="el" href="../../d0/dca/group__confc__dfspec.html#gabf209a6bf58ef464c9b0798e897a59c2">m0_confc_init()</a>.</p>
<p>A confc instance is associated with a state machine group (<a class="el" href="../../d5/d32/structm0__sm__group.html">m0_sm_group</a>). A user managing this group is responsible for making sure <a class="el" href="../../d1/dc1/group__sm.html#ga86a9c851a2733f04ae882053f934abb5">m0_sm_asts_run()</a> is called when the group's channel is signaled; "AST" section of <a class="el" href="../../d1/dc1/group__sm.html">State machine</a> has more details on this topic.</p>
<p><a class="el" href="../../d0/dca/group__confc__dfspec.html#ga246f8e1e88c76a3045fa0762fd5712ed">m0_confc_fini()</a> terminates confc, destroying configuration cache.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d7/d14/confc_8h.html">conf/confc.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d5/d99/obj_8h.html">conf/obj.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d5/d32/structm0__sm__group.html">m0_sm_group</a>    *<a class="code" href="../../d0/d45/bytecount_8c.html#acd41fa5833804f5ea4357994c4426f90">grp</a> = ...;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d9/d36/structm0__rpc__machine.html">m0_rpc_machine</a> *rpcm = ...;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../dd/d03/structm0__confc.html">m0_confc</a>        <a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a>;</div><div class="line"></div><div class="line">startup(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d9/d8a/structm0__fid.html">m0_fid</a> *<a class="code" href="../../d5/d9a/ut_2rconfc_8c.html#a528b949f1ba9f91f623c6ee9da961762">profile</a>, ...)</div><div class="line">{</div><div class="line">        <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d5/d25/group__confc__dlspec.html#gabf209a6bf58ef464c9b0798e897a59c2">m0_confc_init</a>(&amp;<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a>, <a class="code" href="../../d0/d45/bytecount_8c.html#acd41fa5833804f5ea4357994c4426f90">grp</a>, <a class="code" href="../../d5/d9a/ut_2rconfc_8c.html#a528b949f1ba9f91f623c6ee9da961762">profile</a>, <span class="stringliteral">&quot;confd-ep-addr&quot;</span>, rpcm,</div><div class="line">                           <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">        ...</div><div class="line">}</div><div class="line"></div><div class="line">... Access configuration objects, <span class="keyword">using</span> <a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a> interfaces. ...</div><div class="line"></div><div class="line">shutdown(...)</div><div class="line">{</div><div class="line">        <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga246f8e1e88c76a3045fa0762fd5712ed">m0_confc_fini</a>(<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a>);</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="confc-fspec-sub-use"></a>
Accessing configuration objects</h2>
<p>The application gets access to configuration data by opening configuration objects with <a class="el" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open()</a> or <a class="el" href="../../d0/dca/group__confc__dfspec.html#gaf016ccec50caf97507eecef0d75e1857">m0_confc_open_sync()</a>. Directory objects can be iterated over with <a class="el" href="../../d0/dca/group__confc__dfspec.html#gac29f7f13b3453fbf03379a823a4307c3">m0_confc_readdir()</a> or <a class="el" href="../../d0/dca/group__confc__dfspec.html#gab395786643873d814ddbb951571ddd14">m0_confc_readdir_sync()</a>.</p>
<p><a class="el" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open()</a> and <a class="el" href="../../d0/dca/group__confc__dfspec.html#gac29f7f13b3453fbf03379a823a4307c3">m0_confc_readdir()</a> are asynchronous functions. Prior to calling them, the application should initialise a context object (<a class="el" href="../../d0/dca/group__confc__dfspec.html#ga91bf72b4f1a8aac4121111c141d804d4">m0_confc_ctx_init()</a>) and register a clink with .sm_chan member of <a class="el" href="../../de/d82/structm0__confc__ctx.html#a8fc8c582e0828925a01abfdb9876109a">m0_confc_ctx::fc_mach</a>. (See <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga08e6e7d1d828d9ea4574f712cd43a417">sm_waiter_init()</a> in the <a class="el" href="../../dc/d31/confc-fspec.html#confc-fspec-recipe1">recipe #1</a> below.)</p>
<p><a class="el" href="../../d0/dca/group__confc__dfspec.html#ga1fafd6a0b6fe36dda7a26e32d713cfdd">m0_confc_ctx_is_completed()</a> checks whether configuration retrieval has completed, i.e., terminated or failed.</p>
<p><a class="el" href="../../d0/dca/group__confc__dfspec.html#ga3345102f46c980aef89a53a342ace13a">m0_confc_ctx_error()</a> returns the error status of an asynchronous configuration retrieval operation. <a class="el" href="../../d0/dca/group__confc__dfspec.html#ga174008a1ed4337cf57da2f53faa7bfd3">m0_confc_ctx_result()</a> returns the requested configuration object.</p>
<p>A caller of <a class="el" href="../../d0/dca/group__confc__dfspec.html#gaf016ccec50caf97507eecef0d75e1857">m0_confc_open_sync()</a> or <a class="el" href="../../d0/dca/group__confc__dfspec.html#gab395786643873d814ddbb951571ddd14">m0_confc_readdir_sync()</a> will be blocked while confc is processing the request.</p>
<p>All m0_confc_open*()ed configuration objects must be <a class="el" href="../../d0/dca/group__confc__dfspec.html#ga899a22f1dafd4ffbb22f6d72e1590ddc">m0_confc_close()</a>ed before <a class="el" href="../../d0/dca/group__confc__dfspec.html#ga246f8e1e88c76a3045fa0762fd5712ed">m0_confc_fini()</a> is called.</p>
<dl class="section note"><dt>Note</dt><dd>Confc library pins (see <a class="el" href="../../d9/d5d/conf-fspec-obj.html#conf-fspec-obj-pinned">Pinned Objects</a>) only those configuration objects that are m0_confc_open*()ed or m0_confc_readdir*()ed by the application.</dd></dl>
<p><a class="el" href="../../d9/d1b/group__confditer.html#ga869a4242e3dc6a81518b25313acbc95e">m0_conf_diter_next()</a> is an asynchronous function. Prior to invoking it, the application must invoke <a class="el" href="../../d9/d1b/group__confditer.html#gad1da13266b2f748e76fa4a3d7edde2cb">m0_conf_diter_wait_arm()</a> and register a clink to receive the completion event. Result of the iteration must be accessed using <a class="el" href="../../d9/d1b/group__confditer.html#gaddfda2e8e7dd208eb152b28baff6e72c">m0_conf_diter_result()</a>.</p>
<hr/>
 <h1><a class="anchor" id="confc-fspec-recipes"></a>
Recipes</h1>
<p>Configuration objects can be opened asynchronously (<a class="el" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open()</a>) or synchronously (<a class="el" href="../../d0/dca/group__confc__dfspec.html#gaf016ccec50caf97507eecef0d75e1857">m0_confc_open_sync()</a>). Many of the examples below use synchronous calls for the sake of brevity.</p>
<h2><a class="anchor" id="confc-fspec-recipe1"></a>
Get profile configuration</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d7/d14/confc_8h.html">conf/confc.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d5/d99/obj_8h.html">conf/obj.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../dd/d03/structm0__confc.html">m0_confc</a> *g_confc = ...;</div><div class="line"></div><div class="line"><span class="comment">// A sample m0_confc_ctx wrapper.</span></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a> {</div><div class="line">        <span class="keyword">struct </span><a class="code" href="../../de/d82/structm0__confc__ctx.html">m0_confc_ctx</a> <a class="code" href="../../df/d4a/structsm__waiter.html#a453310c651f313f1ea58470e11bae026">w_ctx</a>;</div><div class="line">        <span class="keyword">struct </span><a class="code" href="../../d0/d06/structm0__clink.html">m0_clink</a>     <a class="code" href="../../df/d4a/structsm__waiter.html#a7454c8b07a4c242e4b1836d49a7974ba">w_clink</a>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga08e6e7d1d828d9ea4574f712cd43a417">sm_waiter_init</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a> *w, <span class="keyword">struct</span> <a class="code" href="../../dd/d03/structm0__confc.html">m0_confc</a> *<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a>);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d25/group__confc__dlspec.html#gabc28154c41b2893e1d2ebeb6d304d766">sm_waiter_fini</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a> *w);</div><div class="line"></div><div class="line"><span class="comment">// Uses asynchronous m0_confc_open().</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> profile_open1(<span class="keyword">struct</span> <a class="code" href="../../d6/d2f/structm0__conf__profile.html">m0_conf_profile</a> **<a class="code" href="../../d8/d5d/st__kmain_8c.html#af7c9135f55c842b4b2d6d90308fb9c92">prof</a>,</div><div class="line">                         <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d9/d8a/structm0__fid.html">m0_fid</a> *<span class="keywordtype">id</span>)</div><div class="line">{</div><div class="line">        <span class="keyword">struct </span><a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a> w;</div><div class="line">        <span class="keywordtype">int</span>              <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line"></div><div class="line">        <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga08e6e7d1d828d9ea4574f712cd43a417">sm_waiter_init</a>(&amp;w, g_confc);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> != 0)</div><div class="line">                <span class="keywordflow">return</span> <a class="code" href="../../db/dcd/m0t1fs_2linux__kernel_2dir_8c.html#a01283f6c481bc4a3d0f204e957179d6e">M0_ERR</a>(<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>);</div><div class="line"></div><div class="line">        <a class="code" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open</a>(&amp;w.w_ctx, <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, M0_CONF_ROOT_PROFILES_FID, <span class="keywordtype">id</span>);</div><div class="line">        <span class="keywordflow">while</span> (!<a class="code" href="../../d5/d25/group__confc__dlspec.html#ga1fafd6a0b6fe36dda7a26e32d713cfdd">m0_confc_ctx_is_completed</a>(&amp;w.w_ctx))</div><div class="line">                <a class="code" href="../../df/da0/group__chan.html#ga2370fce32196fcfe356cbb47046449de">m0_chan_wait</a>(&amp;w.w_clink);</div><div class="line"></div><div class="line">        <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga3345102f46c980aef89a53a342ace13a">m0_confc_ctx_error</a>(&amp;w.w_ctx);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> == 0)</div><div class="line">                *<a class="code" href="../../d8/d5d/st__kmain_8c.html#af7c9135f55c842b4b2d6d90308fb9c92">prof</a> = <a class="code" href="../../dd/df9/group__conf__dfspec__obj.html#gaf550482c159edc77ab8da52d5a71a1aa">M0_CONF_CAST</a>(<a class="code" href="../../d5/d25/group__confc__dlspec.html#ga174008a1ed4337cf57da2f53faa7bfd3">m0_confc_ctx_result</a>(&amp;w.w_ctx),</div><div class="line">                                     <a class="code" href="../../d6/d2f/structm0__conf__profile.html">m0_conf_profile</a>);</div><div class="line">        <a class="code" href="../../d5/d25/group__confc__dlspec.html#gabc28154c41b2893e1d2ebeb6d304d766">sm_waiter_fini</a>(&amp;w);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Uses m0_confc_open_sync().</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> profile_open2(<span class="keyword">struct</span> <a class="code" href="../../d6/d2f/structm0__conf__profile.html">m0_conf_profile</a> **<a class="code" href="../../d8/d5d/st__kmain_8c.html#af7c9135f55c842b4b2d6d90308fb9c92">prof</a>,</div><div class="line">                         <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d9/d8a/structm0__fid.html">m0_fid</a> *<span class="keywordtype">id</span>)</div><div class="line">{</div><div class="line">        <span class="keyword">struct </span><a class="code" href="../../df/da6/structm0__conf__obj.html">m0_conf_obj</a> *<a class="code" href="../../dc/dc9/ut_2tlist_8c.html#a21dc5b93c91d40e224e7bb5fc98016eb">obj</a>;</div><div class="line">        <span class="keywordtype">int</span>                 <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line"></div><div class="line">        <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d0/dca/group__confc__dfspec.html#gaf016ccec50caf97507eecef0d75e1857">m0_confc_open_sync</a>(&amp;<a class="code" href="../../dc/dc9/ut_2tlist_8c.html#a21dc5b93c91d40e224e7bb5fc98016eb">obj</a>, g_confc-&gt;<a class="code" href="../../dd/d03/structm0__confc.html#a668c917c87cec73ef50eece253628448">cc_root</a>,</div><div class="line">                                M0_CONF_ROOT_PROFILES_FID, *<span class="keywordtype">id</span>);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> == 0)</div><div class="line">                *<a class="code" href="../../d8/d5d/st__kmain_8c.html#af7c9135f55c842b4b2d6d90308fb9c92">prof</a> = <a class="code" href="../../dd/df9/group__conf__dfspec__obj.html#gaf550482c159edc77ab8da52d5a71a1aa">M0_CONF_CAST</a>(<a class="code" href="../../dc/dc9/ut_2tlist_8c.html#a21dc5b93c91d40e224e7bb5fc98016eb">obj</a>, <a class="code" href="../../d6/d2f/structm0__conf__profile.html">m0_conf_profile</a>);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Filters out intermediate state transitions of m0_confc_ctx::fc_mach.</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> sm_filter(<span class="keyword">struct</span> <a class="code" href="../../d0/d06/structm0__clink.html">m0_clink</a> *link)</div><div class="line">{</div><div class="line">        <span class="keywordflow">return</span> !<a class="code" href="../../d5/d25/group__confc__dlspec.html#ga1fafd6a0b6fe36dda7a26e32d713cfdd">m0_confc_ctx_is_completed</a>(&amp;<a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#af8c317a42292b61c93aae91e59118a46">container_of</a>(link,</div><div class="line">                                                        <span class="keyword">struct</span> <a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a>,</div><div class="line">                                                        w_clink)-&gt;w_ctx);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga08e6e7d1d828d9ea4574f712cd43a417">sm_waiter_init</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a> *w, <span class="keyword">struct</span> <a class="code" href="../../dd/d03/structm0__confc.html">m0_confc</a> *<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga91bf72b4f1a8aac4121111c141d804d4">m0_confc_ctx_init</a>(&amp;w-&gt;<a class="code" href="../../df/d4a/structsm__waiter.html#a453310c651f313f1ea58470e11bae026">w_ctx</a>, <a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a>);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> == 0) {</div><div class="line">                <a class="code" href="../../df/da0/group__chan.html#ga005725ac0a4cb914289fa63d36827df8">m0_clink_init</a>(&amp;w-&gt;<a class="code" href="../../df/d4a/structsm__waiter.html#a7454c8b07a4c242e4b1836d49a7974ba">w_clink</a>, sm_filter);</div><div class="line">                <a class="code" href="../../df/da0/group__chan.html#ga919d9e6111bd9c6e1f0c0e18a8139097">m0_clink_add</a>(&amp;w-&gt;<a class="code" href="../../df/d4a/structsm__waiter.html#a453310c651f313f1ea58470e11bae026">w_ctx</a>.<a class="code" href="../../de/d82/structm0__confc__ctx.html#a8fc8c582e0828925a01abfdb9876109a">fc_mach</a>.<a class="code" href="../../db/d49/structm0__sm.html#a84c8ec397c6919295e9d4a4e3b84faf9">sm_chan</a>, &amp;w-&gt;<a class="code" href="../../df/d4a/structsm__waiter.html#a7454c8b07a4c242e4b1836d49a7974ba">w_clink</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d25/group__confc__dlspec.html#gabc28154c41b2893e1d2ebeb6d304d766">sm_waiter_fini</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a> *w)</div><div class="line">{</div><div class="line">        <a class="code" href="../../df/da0/group__chan.html#ga7abfc22f2c6f33620e68c77a1ade46cb">m0_clink_del</a>(&amp;w-&gt;<a class="code" href="../../df/d4a/structsm__waiter.html#a7454c8b07a4c242e4b1836d49a7974ba">w_clink</a>);</div><div class="line">        <a class="code" href="../../df/da0/group__chan.html#gad8b6e84d3a71f296b398a9c83acea322">m0_clink_fini</a>(&amp;w-&gt;<a class="code" href="../../df/d4a/structsm__waiter.html#a7454c8b07a4c242e4b1836d49a7974ba">w_clink</a>);</div><div class="line">        <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga56b93a0699b96051fc7430fd0ce40286">m0_confc_ctx_fini</a>(&amp;w-&gt;<a class="code" href="../../df/d4a/structsm__waiter.html#a453310c651f313f1ea58470e11bae026">w_ctx</a>);</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="confc-fspec-recipe2"></a>
Iterate directory object asynchronously</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d7/d14/confc_8h.html">conf/confc.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d5/d99/obj_8h.html">conf/obj.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d7/deb/arith_8h.html">lib/arith.h</a>&quot;</span> <span class="comment">// M0_CNT_INC</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a> {</div><div class="line">        <span class="keyword">struct </span><a class="code" href="../../de/d82/structm0__confc__ctx.html">m0_confc_ctx</a> <a class="code" href="../../df/d4a/structsm__waiter.html#a453310c651f313f1ea58470e11bae026">w_ctx</a>;</div><div class="line">        <span class="keyword">struct </span><a class="code" href="../../d0/d06/structm0__clink.html">m0_clink</a>     <a class="code" href="../../df/d4a/structsm__waiter.html#a7454c8b07a4c242e4b1836d49a7974ba">w_clink</a>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// sm_waiter_*() functions are defined in one of the recipes above.</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga08e6e7d1d828d9ea4574f712cd43a417">sm_waiter_init</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a> *w, <span class="keyword">struct</span> <a class="code" href="../../dd/d03/structm0__confc.html">m0_confc</a> *<a class="code" href="../../da/d03/m0t1fs_2linux__kernel_2ut_2file_8c.html#ab97735506991f7d5230b2627f33a7a41">confc</a>);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d25/group__confc__dlspec.html#gabc28154c41b2893e1d2ebeb6d304d766">sm_waiter_fini</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a> *w);</div><div class="line"></div><div class="line"><span class="comment">// Uses configuration data of every object in given directory.</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d72/ut_2confc_8c.html#a488ffe8fa9b113f13092bfdc82438a3f">dir_entries_use</a>(<span class="keyword">struct</span> <a class="code" href="../../df/da6/structm0__conf__obj.html">m0_conf_obj</a> *<a class="code" href="../../db/dcd/m0t1fs_2linux__kernel_2dir_8c.html#a4ca269cf93df1b512b52174c1a256fe5">dir</a>,</div><div class="line">                           <span class="keywordtype">void</span> (*use)(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../df/da6/structm0__conf__obj.html">m0_conf_obj</a> *),</div><div class="line">                           <span class="keywordtype">bool</span> (*stop_at)(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../df/da6/structm0__conf__obj.html">m0_conf_obj</a> *))</div><div class="line">{</div><div class="line">        <span class="keyword">struct </span><a class="code" href="../../df/d4a/structsm__waiter.html">sm_waiter</a>    w;</div><div class="line">        <span class="keywordtype">int</span>                 <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line">        <span class="keyword">struct </span><a class="code" href="../../df/da6/structm0__conf__obj.html">m0_conf_obj</a> *entry = <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"></div><div class="line">        <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga08e6e7d1d828d9ea4574f712cd43a417">sm_waiter_init</a>(&amp;w, <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga5614acafa8103ea4cfdcd417b729672b">m0_confc_from_obj</a>(<a class="code" href="../../db/dcd/m0t1fs_2linux__kernel_2dir_8c.html#a4ca269cf93df1b512b52174c1a256fe5">dir</a>));</div><div class="line"></div><div class="line">        <span class="keywordflow">while</span> ((<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d5/d25/group__confc__dlspec.html#gac29f7f13b3453fbf03379a823a4307c3">m0_confc_readdir</a>(&amp;w.<a class="code" href="../../df/d4a/structsm__waiter.html#a453310c651f313f1ea58470e11bae026">w_ctx</a>, <a class="code" href="../../db/dcd/m0t1fs_2linux__kernel_2dir_8c.html#a4ca269cf93df1b512b52174c1a256fe5">dir</a>, &amp;entry)) &gt; 0) {</div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> == <a class="code" href="../../d9/d40/group__conf__dfspec__objops.html#gga011f03cf9976ad9c789c7b27e1e26a44a7e74d1f36c49f05e6adc78495f5bf6e0">M0_CONF_DIRNEXT</a>) {</div><div class="line">                        <span class="comment">// The entry is available immediately.</span></div><div class="line">                        <a class="code" href="../../dc/da7/assert_8h.html#ac8bebb1ebb72c1dae891a1a1c24e7aec">M0_ASSERT</a>(entry != <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"></div><div class="line">                        use(entry);</div><div class="line">                        <span class="keywordflow">if</span> (stop_at != <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; stop_at(entry)) {</div><div class="line">                                <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = 0;</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">continue</span>; <span class="comment">// Note, that `entry&#39; will be</span></div><div class="line">                                  <span class="comment">// closed by m0_confc_readdir().</span></div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">// Cache miss.</span></div><div class="line">                <a class="code" href="../../dc/da7/assert_8h.html#ac8bebb1ebb72c1dae891a1a1c24e7aec">M0_ASSERT</a>(<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> == <a class="code" href="../../d9/d40/group__conf__dfspec__objops.html#gga011f03cf9976ad9c789c7b27e1e26a44a9013bb5c8485d5aaa07f3c1256e5c45a">M0_CONF_DIRMISS</a>);</div><div class="line">                <span class="keywordflow">while</span> (!<a class="code" href="../../d5/d25/group__confc__dlspec.html#ga1fafd6a0b6fe36dda7a26e32d713cfdd">m0_confc_ctx_is_completed</a>(&amp;w.<a class="code" href="../../df/d4a/structsm__waiter.html#a453310c651f313f1ea58470e11bae026">w_ctx</a>))</div><div class="line">                        <a class="code" href="../../df/da0/group__chan.html#ga2370fce32196fcfe356cbb47046449de">m0_chan_wait</a>(&amp;w.<a class="code" href="../../df/d4a/structsm__waiter.html#a7454c8b07a4c242e4b1836d49a7974ba">w_clink</a>);</div><div class="line"></div><div class="line">                <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> = <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga3345102f46c980aef89a53a342ace13a">m0_confc_ctx_error</a>(&amp;w.<a class="code" href="../../df/d4a/structsm__waiter.html#a453310c651f313f1ea58470e11bae026">w_ctx</a>);</div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a> != 0)</div><div class="line">                        <span class="keywordflow">break</span>; <span class="comment">// error</span></div><div class="line"></div><div class="line">                entry = <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga174008a1ed4337cf57da2f53faa7bfd3">m0_confc_ctx_result</a>(&amp;w.<a class="code" href="../../df/d4a/structsm__waiter.html#a453310c651f313f1ea58470e11bae026">w_ctx</a>);</div><div class="line">                <span class="keywordflow">if</span> (entry == <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">                        <span class="keywordflow">break</span>; <span class="comment">// end of directory</span></div><div class="line"></div><div class="line">                use(entry);</div><div class="line">                <span class="keywordflow">if</span> (stop_at != <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; stop_at(entry))</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="comment">// Re-initialise m0_confc_ctx.</span></div><div class="line">                <a class="code" href="../../d5/d25/group__confc__dlspec.html#gabc28154c41b2893e1d2ebeb6d304d766">sm_waiter_fini</a>(&amp;w);</div><div class="line">                <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga08e6e7d1d828d9ea4574f712cd43a417">sm_waiter_init</a>(&amp;w, <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga5614acafa8103ea4cfdcd417b729672b">m0_confc_from_obj</a>(<a class="code" href="../../db/dcd/m0t1fs_2linux__kernel_2dir_8c.html#a4ca269cf93df1b512b52174c1a256fe5">dir</a>));</div><div class="line">        }</div><div class="line"></div><div class="line">        <a class="code" href="../../d5/d25/group__confc__dlspec.html#ga899a22f1dafd4ffbb22f6d72e1590ddc">m0_confc_close</a>(entry);</div><div class="line">        <a class="code" href="../../d5/d25/group__confc__dlspec.html#gabc28154c41b2893e1d2ebeb6d304d766">sm_waiter_fini</a>(&amp;w);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line">}</div></div><!-- fragment --><dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d0/dca/group__confc__dfspec.html">Detailed Functional Specification</a> </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li><li class="navelem"><a class="el" href="../../d2/dd9/conf.html">DLD of configuration caching</a></li>
    <li class="footer">Generated on Fri May 20 2022 10:35:29 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
