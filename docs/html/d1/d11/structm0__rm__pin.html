<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: m0_rm_pin Struct Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d1/d11/structm0__rm__pin.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-attribs">Data Fields</a>  </div>
  <div class="headertitle">
<div class="title">m0_rm_pin Struct Reference<div class="ingroups"><a class="el" href="../../d2/deb/group__rm.html">Resource management</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="../../db/df8/rm_8h_source.html">rm.h</a>&gt;</code></p>
<div class="dynheader">
Collaboration diagram for m0_rm_pin:</div>
<div class="dyncontent">
<div class="center"><img src="../../db/d51/structm0__rm__pin__coll__graph.png" border="0" usemap="#m0__rm__pin_coll__map" alt="Collaboration graph"/></div>
<map name="m0__rm__pin_coll__map" id="m0__rm__pin_coll__map">
<area shape="rect" id="node5" href="../../d3/db4/structm0__rm__incoming.html" title="{m0_rm_incoming\n||}" alt="" coords="53,329,174,407"/>
<area shape="rect" id="node6" href="../../d6/d46/structm0__rm__credit.html" title="{m0_rm_credit\n||}" alt="" coords="179,175,280,252"/>
<area shape="rect" id="node3" href="../../d9/de0/structm0__tlink.html" title="{m0_tlink\n||}" alt="" coords="241,5,311,83"/>
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-attribs"></a>
Data Fields</h2></td></tr>
<tr class="memitem:ae667e68546112a802f085f8e005a28e4"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d11/structm0__rm__pin.html#ae667e68546112a802f085f8e005a28e4">rp_flags</a></td></tr>
<tr class="separator:ae667e68546112a802f085f8e005a28e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aedfdf15c28b3acbfb37b8de6972c73a9"><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="../../d6/d46/structm0__rm__credit.html">m0_rm_credit</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d11/structm0__rm__pin.html#aedfdf15c28b3acbfb37b8de6972c73a9">rp_credit</a></td></tr>
<tr class="separator:aedfdf15c28b3acbfb37b8de6972c73a9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a75760f7d723b983729025d23ac75b920"><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="../../d3/db4/structm0__rm__incoming.html">m0_rm_incoming</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d11/structm0__rm__pin.html#a75760f7d723b983729025d23ac75b920">rp_incoming</a></td></tr>
<tr class="separator:a75760f7d723b983729025d23ac75b920"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af2bc37ad8c0da9fc4f9a093d58095ea8"><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="../../d9/de0/structm0__tlink.html">m0_tlink</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d11/structm0__rm__pin.html#af2bc37ad8c0da9fc4f9a093d58095ea8">rp_credit_linkage</a></td></tr>
<tr class="separator:af2bc37ad8c0da9fc4f9a093d58095ea8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a402ac97ffac72327ec277f7d5e339ff7"><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="../../d9/de0/structm0__tlink.html">m0_tlink</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d11/structm0__rm__pin.html#a402ac97ffac72327ec277f7d5e339ff7">rp_incoming_linkage</a></td></tr>
<tr class="separator:a402ac97ffac72327ec277f7d5e339ff7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a14aca786347fd1b7aa8bf761e5bb72d7"><td class="memItemLeft" align="right" valign="top">uint64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d11/structm0__rm__pin.html#a14aca786347fd1b7aa8bf761e5bb72d7">rp_magix</a></td></tr>
<tr class="separator:a14aca786347fd1b7aa8bf761e5bb72d7"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>A pin is used to:</p>
<ul>
<li>M0_RPF_TRACK: track when a credit changes its state;</li>
<li>M0_RPF_PROTECT: to protect a credit from revocation;</li>
<li>M0_RPF_BARRIER: to prohibit granting credit to another request.</li>
</ul>
<p>Fields of this struct are protected by the owner's lock.</p>
<p>Abstractly speaking, pins allow N:M (many to many) relationships between incoming requests and credits: an incoming request has a list of pins "from" it and a credit has a list of pins "to" it. A typical use case is as follows:</p>
<p><b>Protection</b> </p>
<p>While a credit is actively used, it cannot be revoked. For example, while file write is going on, the credit to write in the target file extent must be held. A credit is held (or pinned) from the return from <a class="el" href="../../d2/deb/group__rm.html#ga35b16fb825a3e37b39bace544db5abe5">m0_rm_credit_get()</a> until the matching call to <a class="el" href="../../d2/deb/group__rm.html#ga5642217a5a12914f27500be7aa65154a">m0_rm_credit_put()</a>. To mark the credit as pinned, <a class="el" href="../../d2/deb/group__rm.html#ga35b16fb825a3e37b39bace544db5abe5">m0_rm_credit_get()</a> adds a M0_RPF_PROTECT pin from the incoming request to the returned credit (generally, more than one credit can be pinned as result on <a class="el" href="../../d2/deb/group__rm.html#ga35b16fb825a3e37b39bace544db5abe5">m0_rm_credit_get()</a>). This pin is removed by the call to <a class="el" href="../../d2/deb/group__rm.html#ga5642217a5a12914f27500be7aa65154a">m0_rm_credit_put()</a>.</p>
<p>Multiple incoming requests can pin the same credit.</p>
<p><b>Tracking</b> </p>
<p>M0_RPF_TRACK pin is added from the incoming request to the credit when:</p>
<ul>
<li>An incoming request with a RIF_LOCAL_WAIT flag needs to wait until a conflicting pinned credit becomes unpinned;</li>
<li>An incoming request need to wait until reserved credit pinned with M0_RPF_BARRIER is unpinned;</li>
<li>An incoming request needs to wait for outgoing request completion.</li>
</ul>
<p>When the last M0_RPF_PROTECT pin is removed from a credit (credit becomes "cached") or M0_RPF_BARRIER pin is removed, then the list of pins to the credit is scanned. For each M0_RPF_TRACK pin on the list, its incoming request is checked to see whether this was the last tracking pin the request is waiting for.</p>
<p>An incoming request might also issue an outgoing request to borrow or revoke some credits, necessary to fulfill the request. An M0_RPF_TRACK pin is added from the incoming request to the credit embedded in the outgoing request (m0_rm_outgoing::rog_want::rl_credit). Multiple incoming requests can pin the same outgoing request. When the outgoing request completes, the incoming requests waiting for it are checked as above.</p>
<p><b>Barrier</b> </p>
<p>Barrier is necessary to avoid live-locks and guarantee progress of incoming request processing by pinning the credits with a M0_RPF_BARRIER pin. Only RIF_RESERVE requests pin credits with a M0_RPF_BARRIER.</p>
<p>A credit pinned with M0_RPF_BARRIER is called "reserved". Only one incoming request can reserve the credit at any given time, others should wait completion of this incoming request (by placing M0_RPF_TRACK pin, as usual).</p>
<p>It is possible that already reserved credit should be reassigned to another incoming request with higher reserve priority than the current one reserving the credit (<a class="el" href="../../d3/db4/structm0__rm__incoming.html">m0_rm_incoming</a>). Such situation is called "barrier overcome".</p>
<p>M0_RPF_BARRIER pins are not set for outgoing requests, but they set on outgoing requests replies in the following way. When the request is complete and credit is placed at owner-&gt;ro_owned[OWOS_CACHED] list, we check if there are any correspondent RIF_RESERVE incoming requests who pinned it with M0_RPF_TRACK. If there are, the highest priority one is selected and the credit is pinned for it with M0_RPF_BARRIER. It is done this way to add M0_RPF_BARRIER before any other waiting for the same credit request could be excited and possibly grab the credit.</p>
<p><b>Example</b> </p>
<pre class="fragment">*
*        -&gt;ro_owned[]---&gt;R-----&gt;R      R&lt;-----R&lt;----------+
*                        |      |      |      |           |
*   -&gt;ro_incoming[]      |      |      |      |           |
*        |               |      |      |      |           |
*        |               |      |      |      |    -&gt;ro_outgoing[]
*        V               |      |      |      |
*    INC[CHECK]----------T------T------T------T
*        |                      |             |
*        |                      |             |
*        V                      |             |
*    INC[SUCCESS]---------------P             |
*        |                                    |
*        |                                    |
*        V                                    |
*    INC[CHECK]-------------------------------T
*
* </pre><p>On this diagram, INC[S] is an incoming request in a state S, R is a credit, T is an M0_RPF_TRACK pin and P is an M0_RPF_PROTECT pin.</p>
<p>The incoming request in the middle has been processed successfully and now protects its credit. The topmost incoming request waits for two possessed credits to become unpinned and also waiting for completion of two outgoing requests. The incoming request on the bottom waits for completion of the same outgoing request.</p>
<p><a class="el" href="../../d2/deb/group__rm.html#ga5642217a5a12914f27500be7aa65154a">m0_rm_credit_put()</a> scans the request's pin list (horizontal direction) and removes all pins. If the last pin was removed from a credit, credit's pin list is scanned (vertical direction), checking incoming requests for possible state transitions. </p>

<p class="definition">Definition at line <a class="el" href="../../db/df8/rm_8h_source.html#l01675">1675</a> of file <a class="el" href="../../db/df8/rm_8h_source.html">rm.h</a>.</p>
</div><h2 class="groupheader">Field Documentation</h2>
<a id="aedfdf15c28b3acbfb37b8de6972c73a9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aedfdf15c28b3acbfb37b8de6972c73a9">&#9670;&nbsp;</a></span>rp_credit</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="../../d6/d46/structm0__rm__credit.html">m0_rm_credit</a>* rp_credit</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../db/df8/rm_8h_source.html#l01677">1677</a> of file <a class="el" href="../../db/df8/rm_8h_source.html">rm.h</a>.</p>

</div>
</div>
<a id="af2bc37ad8c0da9fc4f9a093d58095ea8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af2bc37ad8c0da9fc4f9a093d58095ea8">&#9670;&nbsp;</a></span>rp_credit_linkage</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="../../d9/de0/structm0__tlink.html">m0_tlink</a> rp_credit_linkage</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Linkage into a list of all pins for a credit, hanging off <a class="el" href="../../d6/d46/structm0__rm__credit.html#a17edf6a2d9b08261965e1955370888f7">m0_rm_credit::cr_pins</a>. </p>

<p class="definition">Definition at line <a class="el" href="../../db/df8/rm_8h_source.html#l01684">1684</a> of file <a class="el" href="../../db/df8/rm_8h_source.html">rm.h</a>.</p>

</div>
</div>
<a id="ae667e68546112a802f085f8e005a28e4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae667e68546112a802f085f8e005a28e4">&#9670;&nbsp;</a></span>rp_flags</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t rp_flags</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../db/df8/rm_8h_source.html#l01676">1676</a> of file <a class="el" href="../../db/df8/rm_8h_source.html">rm.h</a>.</p>

</div>
</div>
<a id="a75760f7d723b983729025d23ac75b920"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a75760f7d723b983729025d23ac75b920">&#9670;&nbsp;</a></span>rp_incoming</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="../../d3/db4/structm0__rm__incoming.html">m0_rm_incoming</a>* rp_incoming</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>An incoming request that stuck this pin. </p>

<p class="definition">Definition at line <a class="el" href="../../db/df8/rm_8h_source.html#l01679">1679</a> of file <a class="el" href="../../db/df8/rm_8h_source.html">rm.h</a>.</p>

</div>
</div>
<a id="a402ac97ffac72327ec277f7d5e339ff7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a402ac97ffac72327ec277f7d5e339ff7">&#9670;&nbsp;</a></span>rp_incoming_linkage</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="../../d9/de0/structm0__tlink.html">m0_tlink</a> rp_incoming_linkage</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Linkage into a list of all pins, held to satisfy an incoming request. This list hangs off <a class="el" href="../../d3/db4/structm0__rm__incoming.html#a574ae8133f4ac8ff9ea522f762e0da35">m0_rm_incoming::rin_pins</a>. </p>

<p class="definition">Definition at line <a class="el" href="../../db/df8/rm_8h_source.html#l01689">1689</a> of file <a class="el" href="../../db/df8/rm_8h_source.html">rm.h</a>.</p>

</div>
</div>
<a id="a14aca786347fd1b7aa8bf761e5bb72d7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a14aca786347fd1b7aa8bf761e5bb72d7">&#9670;&nbsp;</a></span>rp_magix</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint64_t rp_magix</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../db/df8/rm_8h_source.html#l01690">1690</a> of file <a class="el" href="../../db/df8/rm_8h_source.html">rm.h</a>.</p>

</div>
</div>
<hr/>The documentation for this struct was generated from the following file:<ul>
<li>rm/<a class="el" href="../../db/df8/rm_8h_source.html">rm.h</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d1/d11/structm0__rm__pin.html">m0_rm_pin</a></li>
    <li class="footer">Generated on Fri May 20 2022 10:36:14 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
