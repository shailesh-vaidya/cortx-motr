<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: confc Internals</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d1/d89/confc-lspec.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">confc Internals </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-state">State Specification</a><ul>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-state-initial">S_INITIAL</a></li>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-state-check">S_CHECK</a></li>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-state-wait-reply">S_WAIT_REPLY</a></li>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-state-wait-status">S_WAIT_STATUS</a></li>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-state-grow-cache">S_SKIP_CONFD</a></li>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-state-terminal">S_TERMINAL</a></li>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-state-failure">S_FAILURE</a></li>
</ul>
</li>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-walk">Walking the DAG</a></li>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-grow">Growing the cache</a></li>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d5/d25/group__confc__dlspec.html">Detailed Logical Specification</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="confc-lspec-state"></a>
State Specification</h1>
<p>A state machine is embedded into <a class="el" href="../../de/d82/structm0__confc__ctx.html">m0_confc_ctx</a> structure as its <a class="el" href="../../de/d82/structm0__confc__ctx.html#a8fc8c582e0828925a01abfdb9876109a">fc_mach</a> member. <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga91bf72b4f1a8aac4121111c141d804d4">m0_confc_ctx_init()</a> initialises the state machine and sets its state to S_INITIAL.</p>
<div class="dotgraph">
<img src="../../dot_inline_dotgraph_7.png" alt="dot_inline_dotgraph_7.png" border="0" usemap="#dot_inline_dotgraph_7.map"/>
<map name="dot_inline_dotgraph_7.map" id="dot_inline_dotgraph_7.map"></map>
</div>
<h2><a class="anchor" id="confc-lspec-state-initial"></a>
S_INITIAL</h2>
<p>Summary: <a class="el" href="../../de/d82/structm0__confc__ctx.html">m0_confc_ctx</a> has just been initialised.</p>
<p><a class="el" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open()</a> populates <a class="el" href="../../de/d82/structm0__confc__ctx.html#ab07fcc83baa4bc0d768064574b5b98e6">m0_confc_ctx::fc_path</a> array (<a class="el" href="../../d5/d25/group__confc__dlspec.html#ga5be179c1ca62c0be911e41c8304e5e31">path_copy()</a>) and posts an AST to <a class="el" href="../../dd/d03/structm0__confc.html#a5e7425fa8b1bd5ed3a87c2fe1821b52e">m0_confc::cc_group</a>.</p>
<dl class="section note"><dt>Note</dt><dd><a class="el" href="../../d1/dc1/group__sm.html#ga3af9c51bdc59b52e62f0b1dd58c5c05d">m0_sm_ast_post()</a> signals group's clink. Current design of confc assumes that some thread will respond to this event by calling <a class="el" href="../../d1/dc1/group__sm.html#ga86a9c851a2733f04ae882053f934abb5">m0_sm_asts_run()</a>.</dd></dl>
<p>When the AST, posted by <a class="el" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open()</a>, is run, it moves a state machine (<a class="el" href="../../de/d82/structm0__confc__ctx.html#a8fc8c582e0828925a01abfdb9876109a">m0_confc_ctx::fc_mach</a>) to S_CHECK state.</p>
<h2><a class="anchor" id="confc-lspec-state-check"></a>
S_CHECK</h2>
<p>Summary: Traversing the path, checking whether the requested configuration object is accessible.</p>
<p>When S_CHECK state is entered, <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga4334015679e376fe9f71ce84eec85b75">check_st_in()</a> callback is invoked. It calls <a class="el" href="../../d5/d25/group__confc__dlspec.html#gaf74d5792e5a5d800e9d5e6d7fcfa61b0">path_walk()</a> and, depending on the value returned by this call, moves the state machine to another state:</p>
<pre class="fragment">+--------------------+-----------------+
| path_walk() result |   next state    |
+--------------------+-----------------+
|    M0_CS_READY     |  S_TERMINAL     |
|    M0_CS_MISSING   |  S_WAIT_REPLY   |
|    M0_CS_LOADING   |  S_WAIT_STATUS  |
|         &lt; 0        |  S_FAILURE      |
+--------------------+-----------------+
</pre><p>The algorithm of <a class="el" href="../../d5/d25/group__confc__dlspec.html#gaf74d5792e5a5d800e9d5e6d7fcfa61b0">path_walk()</a> is described below (see <a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-walk">Walking the DAG</a>).</p>
<h2><a class="anchor" id="confc-lspec-state-wait-reply"></a>
S_WAIT_REPLY</h2>
<p>Summary: Waiting for confd's reply to arrive.</p>
<p>When a state machine is about to enter S_WAIT_REPLY state, <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga01a4bf60ab1c8675abe6e616d837e780">wait_reply_st_in()</a> callback is executed. This callback sends configuration request (<a class="el" href="../../de/d82/structm0__confc__ctx.html#a612d357ebe14197c0bb42d80077dca4c">m0_confc_ctx::fc_rpc_item</a>) to the confd, using <a class="el" href="../../db/de9/group__rpc.html#gab6406484e4b73d1c6a270d88083b7fc9">m0_rpc_post()</a>.</p>
<p>The state machine remains in S_WAIT_REPLY state until a reply from confd arrives. This event triggers <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga784e9f03c814919df4810f9f276e8379">on_replied()</a> callback. If <a class="el" href="../../de/d21/structm0__rpc__item.html#a45d94b6caba7fd30e5fa490e95462275">m0_rpc_item::ri_error</a> is non-zero, <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga784e9f03c814919df4810f9f276e8379">on_replied()</a> posts an AST that will eventually move the state machine to S_FAILURE state, in case the confc is not coupled with rconfc. If -&gt;ri_error is zero, <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga784e9f03c814919df4810f9f276e8379">on_replied()</a> increments rpc item's reference counter (<a class="el" href="../../db/de9/group__rpc.html#ga260cb5dd16d88d6262e4736276535a6d">m0_rpc_item_get()</a>) and posts an AST, scheduling transition to S_GROW_CACHE state.</p>
<p>In case confc is coupled with rconfc, and -&gt;ri_error is found non-zero in <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga784e9f03c814919df4810f9f276e8379">on_replied()</a>, the state machine is transitioned from S_WAIT_REPLY to S_SKIP_CONFD by posting AST to let rconfc reconnect the confc it is in control of to some other confd server from rconfc's active list.</p>
<h2><a class="anchor" id="confc-lspec-state-wait-status"></a>
S_WAIT_STATUS</h2>
<p>Summary: Waiting for an object to be filled by another configuration request.</p>
<p>A state machine in S_WAIT_STATUS state remains idle until the channel (<a class="el" href="../../df/da6/structm0__conf__obj.html#a44c5403049c2cde8d65c1a68c52561eb">m0_conf_obj::co_chan</a>) that <a class="el" href="../../de/d82/structm0__confc__ctx.html#a99460e037e6f3edb2cbe6d67294c9c8e">m0_confc_ctx::fc_clink</a> is registered with is signaled. Such an event triggers <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga1e04c545cb6a13078b12e9c668d705ad">on_object_updated()</a> callback, which de-registers the clink and posts an AST that will eventually move the state machine to S_CHECK state.</p>
<dl class="section note"><dt>Note</dt><dd>Object's channel (<a class="el" href="../../df/da6/structm0__conf__obj.html#a44c5403049c2cde8d65c1a68c52561eb">m0_conf_obj::co_chan</a>) is signaled (<a class="el" href="../../df/da0/group__chan.html#gad1968f64b50443b0c89881a2471321da">m0_chan_broadcast()</a>) when<ol type="1">
<li><a class="el" href="../../d5/d25/group__confc__dlspec.html#ga9a5d8b8b68c9ea4dd0aa2e50e89f91f6">object_enrich()</a> completes loading of configuration data into this object and changes its status to M0_CS_READY (loading succeeded) or M0_CS_MISSING (loading failed);</li>
<li>the object is closed and its number of references becomes zero. (This case is not applicable to S_WAIT_STATUS state.)</li>
</ol>
</dd></dl>
<h2><a class="anchor" id="confc-lspec-state-grow-cache"></a>
S_SKIP_CONFD</h2>
<p>Summary: Skipping current confd the confc is connected to and reconnecting to some other confd server running the same configuration version.</p>
<p>m0_confc::cc_gops::go_skip() is called to let the confc be reconnected. When reconnection succeeded, the state machine is transitioned to S_CHECK state to repeat the last missing object reading. In case of reconnection failure due to having no more responsive confd servers in the active list, the state machine is transitioned to S_FAILURE state.</p>
<h2><a class="anchor" id="confc-lspec-state-grow-cache"></a>
S_SKIP_CONFD</h2>
<p>Summary: Applying configuration data contained in confd's reply.</p>
<p>When a state machine is entering S_GROW_CACHE state, <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga8158ae558ca6e8c9a2e38c9ef790d69e">grow_cache_st_in()</a> callback is invoked. If the error code contained in confd's response (<a class="el" href="../../de/d40/structm0__conf__fetch__resp.html#a8b2e9bf41c6fa64d76b0d2657a91d8f0">m0_conf_fetch_resp::fr_rc</a>) is zero, the callback calls <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga4a0aea81b8374bdd06bdf0f8f7d529a1">cache_grow()</a> function (see <a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-grow">Growing the cache</a> below). The callback "releases" rpc item by calling <a class="el" href="../../db/de9/group__rpc.html#gaa30c26be52bcb511339a632deae6c092">m0_rpc_item_put()</a>. If -&gt;fr_rc == 0 and <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga4a0aea81b8374bdd06bdf0f8f7d529a1">cache_grow()</a> succeeds, <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga8158ae558ca6e8c9a2e38c9ef790d69e">grow_cache_st_in()</a> moves the state machine to S_CHECK state, otherwise &mdash; to S_FAILURE state.</p>
<h2><a class="anchor" id="confc-lspec-state-terminal"></a>
S_TERMINAL</h2>
<p>Summary: Configuration retrieval succeeded.</p>
<h2><a class="anchor" id="confc-lspec-state-failure"></a>
S_FAILURE</h2>
<p>Summary: Configuration retrieval failed.</p>
<hr/>
 <h1><a class="anchor" id="confc-lspec-walk"></a>
Walking the DAG</h1>
<p><a class="el" href="../../d5/d25/group__confc__dlspec.html#gaf74d5792e5a5d800e9d5e6d7fcfa61b0">path_walk()</a> begins with locking the confc cache (<a class="el" href="../../dd/d03/structm0__confc.html#ac15e45502c36e133c73167fd66d57802">m0_confc::cc_lock</a>); it unlocks the cache before returning.</p>
<p>The function "moves" along the DAG of cached configuration objects, starting at <a class="el" href="../../de/d82/structm0__confc__ctx.html#ae941c91bb38a1a9da62c22795cc6eb58">m0_confc_ctx::fc_origin</a> object and following <a class="el" href="../../de/d82/structm0__confc__ctx.html#ab07fcc83baa4bc0d768064574b5b98e6">m0_confc_ctx::fc_path</a>. Next object is found by calling <a class="el" href="../../df/d9a/structm0__conf__obj__ops.html#af58f3a7a158e2a493dfe1266753d92c6">m0_conf_obj_ops::coo_lookup()</a> with current object and path component as parameters. The iteration continues until -&gt;coo_lookup() fails, or a stub is met, or the end of path is reached.</p>
<p><a class="el" href="../../d5/d25/group__confc__dlspec.html#gad4b343fb8c155c7c8662bbd0d004d1e8">path_walk_complete()</a> applies the results of path walking: increments reference counter of M0_CS_READY object, allocates and fills <a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a> request for M0_CS_MISSING object, or registers clink with the channel of M0_CS_LOADING object.</p>
<hr/>
 <h1><a class="anchor" id="confc-lspec-grow"></a>
Growing the cache</h1>
<p><a class="el" href="../../d5/d25/group__confc__dlspec.html#ga4a0aea81b8374bdd06bdf0f8f7d529a1">cache_grow()</a> locks the cache (<a class="el" href="../../dd/d03/structm0__confc.html#aff19ab1aa47a13d78665c30ea747532e">m0_confc::cc_cache</a>) and unlocks before returning. The function performs the following operations for every object descriptor (<a class="el" href="../../de/dba/structm0__confx__obj.html">m0_confx_obj</a>, defined in conf/onwire.ff):</p><ol type="1">
<li><a class="el" href="../../dd/d7b/group__conf__dlspec__objops.html#gafa3f48f19a9737fda426349201ee41f4">m0_conf_obj_find()</a>: tries to find an object with the same identity (type and id) in the registry of cached objects. If the object is not found, a stub is created and added to the cache.</li>
<li><p class="startli"><a class="el" href="../../d5/d25/group__confc__dlspec.html#ga9a5d8b8b68c9ea4dd0aa2e50e89f91f6">object_enrich()</a>: compares cached object with the descriptor received from the confd. If a discrepancy is found (!m0_conf_obj_match()), the function returns an error code.</p>
<p class="startli">If there is no discrepancy, and the cached object is a stub, <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga9a5d8b8b68c9ea4dd0aa2e50e89f91f6">object_enrich()</a> fills the cached object with configuration data (<a class="el" href="../../dd/d7b/group__conf__dlspec__objops.html#ga97c0f5a3b12f323eacf61fc762fa8480">m0_conf_obj_fill()</a>) and signals object's channel.</p>
</li>
</ol>
<hr/>
 <h1><a class="anchor" id="confc-lspec-thread"></a>
Threading and Concurrency Model</h1>
<p>There are as many state machines in operation as there are unfinished m0_confc_open*() requests.</p>
<p>At most one state transition (<a class="el" href="../../da/d29/structm0__sm__state__descr.html#acfcbdd9dc5092bf7138045716db065c1">m0_sm_state_descr::sd_in()</a>) can be running at any given time. Synchronization of state transitions is achieved by using <a class="el" href="../../d5/d32/structm0__sm__group.html">m0_sm_group</a> (<a class="el" href="../../dd/d03/structm0__confc.html#a5e7425fa8b1bd5ed3a87c2fe1821b52e">m0_confc::cc_group</a>).</p>
<p><a class="el" href="../../dd/d03/structm0__confc.html">m0_confc</a> instance and confc cache are protected from concurrent modifications by <a class="el" href="../../dd/d03/structm0__confc.html#ac15e45502c36e133c73167fd66d57802">m0_confc::cc_lock</a> mutex, aka cache lock. Group lock (m0_confc::cc_group::s_lock) cannot be used for this purpose, because it does not prevent the application from modifying the cache with <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga899a22f1dafd4ffbb22f6d72e1590ddc">m0_confc_close()</a>.</p>
<p>If a function needs both locks &ndash; group lock and cache lock &ndash; for its operation, group lock must be acquired first. Note, that the "function" here cannot be something invoked from an AST callback, because otherwise it would deadlock on the group mutex.</p>
<p>A user managing the state machine group (<a class="el" href="../../dd/d03/structm0__confc.html#a5e7425fa8b1bd5ed3a87c2fe1821b52e">m0_confc::cc_group</a>) is responsible for making sure <a class="el" href="../../d1/dc1/group__sm.html#ga86a9c851a2733f04ae882053f934abb5">m0_sm_asts_run()</a> is called when <a class="el" href="../../d5/d32/structm0__sm__group.html#a456c082093f8ac7b1d10845299dfc461">m0_sm_group::s_clink</a> is signaled. See <a class="el" href="../../d1/dc1/group__sm.html">State machine</a> (search for &lsquo;"ast" thread&rsquo;.) </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li><li class="navelem"><a class="el" href="../../d2/dd9/conf.html">DLD of configuration caching</a></li>
    <li class="footer">Generated on Fri May 20 2022 10:35:29 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
