<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: LNet Buffer Event Queue Functional Specification</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d1/db3/cqueue_d_l_d-fspec.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">LNet Buffer Event Queue Functional Specification </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../d1/db3/cqueue_d_l_d-fspec.html#cqueueDLD-fspec-ds">Data Structures</a></li>
<li><a class="el" href="../../d1/db3/cqueue_d_l_d-fspec.html#cqueueDLD-fspec-sub">Subroutines</a></li>
<li><a class="el" href="../../d1/db3/cqueue_d_l_d-fspec.html#cqueueDLD-fspec-usecases">Recipes</a></li>
<li><a class="el" href="../../dd/d08/group__bevcqueue.html">Detailed Functional Specification</a></li>
</ul>
<h1><a class="anchor" id="cqueueDLD-fspec-ds"></a>
Data Structures</h1>
<p>The circular queue is defined by the <a class="el" href="../../db/d96/structnlx__core__bev__cqueue.html">nlx_core_bev_cqueue</a> data structure.</p>
<h1><a class="anchor" id="cqueueDLD-fspec-sub"></a>
Subroutines</h1>
<p>Subroutines are provided to:</p><ul>
<li>initialize and finalize the <a class="el" href="../../db/d96/structnlx__core__bev__cqueue.html">nlx_core_bev_cqueue</a></li>
<li>produce and consume elements in the queue</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../dd/d08/group__bevcqueue.html">Detailed Functional Specification</a></dd></dl>
<h1><a class="anchor" id="cqueueDLD-fspec-usecases"></a>
Recipes</h1>
<p>The <a class="el" href="../../db/d96/structnlx__core__bev__cqueue.html">nlx_core_bev_cqueue</a> provides access to the producer and consumer elements in the circular queue.</p>
<p>In addition, semaphores or other synchronization mechanisms can be used to notify the producer or consumer when the queue changes, eg. when it becomes not empty.</p>
<h2><a class="anchor" id="cq-init"></a>
Initialization</h2>
<p>The circular queue is initialized as follows:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a> *e1;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a> *e2;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../db/d96/structnlx__core__bev__cqueue.html">nlx_core_bev_cqueue</a> myqueue;</div><div class="line"></div><div class="line"><a class="code" href="../../d8/de0/group___l_net_core.html#ga0cb7da292c027add1e30814acd9b1b53">NLX_ALLOC_PTR</a>(e1, ...);</div><div class="line"><a class="code" href="../../d8/de0/group___l_net_core.html#ga0cb7da292c027add1e30814acd9b1b53">NLX_ALLOC_PTR</a>(e2, ...);</div><div class="line"><a class="code" href="../../dd/d08/group__bevcqueue.html#ga1e5ff189be5e9394e1f1ddad3cf64f6f">bev_cqueue_init</a>(&amp;myqueue, &amp;e1-&gt;<a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html#ac0f10a4e5b530ecd00c5b95138e91051">cbe_tm_link</a>, &amp;e2-&gt;<a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html#ac0f10a4e5b530ecd00c5b95138e91051">cbe_tm_link</a>);</div></div><!-- fragment --><h2><a class="anchor" id="cq-allocator"></a>
Allocator</h2>
<p>The event queue can be expanded to make room for additional buffer events. This should be performed before buffers are queued. One element should exist on the event queue for each expected buffer operation, plus one additional element for the "current" buffer operation.</p>
<div class="fragment"><div class="line"><span class="keywordtype">size_t</span> needed;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a> *<a class="code" href="../../dc/d7e/group__desim.html#ga5b2149049952fc833105a6986e99bb19">el</a>;</div><div class="line"></div><div class="line">... ; <span class="comment">// acquire the lock shared with the consumer</span></div><div class="line"><span class="keywordflow">while</span> (needed &gt; <a class="code" href="../../dd/d08/group__bevcqueue.html#ga790790a68d0eed6c8ce95bae5d0d2413">bev_cqueue_size</a>(&amp;myqueue)) {</div><div class="line">    <a class="code" href="../../d8/de0/group___l_net_core.html#ga0cb7da292c027add1e30814acd9b1b53">NLX_ALLOC_PTR</a>(<a class="code" href="../../dc/d7e/group__desim.html#ga5b2149049952fc833105a6986e99bb19">el</a>, ...);</div><div class="line">    ... ; <span class="comment">// initialize the new element for both address spaces</span></div><div class="line">    <a class="code" href="../../dd/d08/group__bevcqueue.html#ga590b6faabdb5da756b429cf13c4c0ec4">bev_cqueue_add</a>(&amp;myqueue, <a class="code" href="../../dc/d7e/group__desim.html#ga5b2149049952fc833105a6986e99bb19">el</a>);</div><div class="line">}</div><div class="line">... ; <span class="comment">// release the lock shared with the consumer</span></div></div><!-- fragment --><h2><a class="anchor" id="cq-producer"></a>
Producer</h2>
<p>The (single) producer works in a loop, putting event notifications in the queue:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="../../dc/d74/addb2_2ut_2storage_8c.html#aa195dadf0a13af092bd974c517f76f66">done</a>;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d1/d60/structnlx__core__bev__link.html">nlx_core_bev_link</a> *ql;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a> *<a class="code" href="../../dc/d7e/group__desim.html#ga5b2149049952fc833105a6986e99bb19">el</a>;</div><div class="line"></div><div class="line"><span class="keywordflow">while</span> (!<a class="code" href="../../dc/d74/addb2_2ut_2storage_8c.html#aa195dadf0a13af092bd974c517f76f66">done</a>) {</div><div class="line">    ql = <a class="code" href="../../dd/d08/group__bevcqueue.html#ga6027e82fa54371c2e9335f5366455adf">bev_cqueue_pnext</a>(&amp;myqueue);</div><div class="line">    <a class="code" href="../../dc/d7e/group__desim.html#ga5b2149049952fc833105a6986e99bb19">el</a> = <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#af8c317a42292b61c93aae91e59118a46">container_of</a>(ql, <span class="keyword">struct</span> <a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a>, <a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html#ac0f10a4e5b530ecd00c5b95138e91051">cbe_tm_link</a>);</div><div class="line">    ... ; <span class="comment">// initialize the element</span></div><div class="line">    <a class="code" href="../../dd/d08/group__bevcqueue.html#gaef877c0746747aab043617177b5973df">bev_cqueue_put</a>(&amp;myqueue, ql);</div><div class="line">    ... ; <span class="comment">// notify blocked consumer that data is available</span></div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="cq-consumer"></a>
Consumer</h2>
<p>The (single) consumer works in a loop, consuming data from the queue:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="../../dc/d74/addb2_2ut_2storage_8c.html#aa195dadf0a13af092bd974c517f76f66">done</a>;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d1/d60/structnlx__core__bev__link.html">nlx_core_bev_link</a> *ql;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a> *<a class="code" href="../../dc/d7e/group__desim.html#ga5b2149049952fc833105a6986e99bb19">el</a>;</div><div class="line"></div><div class="line"><span class="keywordflow">while</span> (!<a class="code" href="../../dc/d74/addb2_2ut_2storage_8c.html#aa195dadf0a13af092bd974c517f76f66">done</a>) {</div><div class="line">    ... ; <span class="comment">// acquire the lock shared with the allocator</span></div><div class="line">    ql = <a class="code" href="../../dd/d08/group__bevcqueue.html#ga77e31d64b61358e7d0d559a774ceb639">bev_cqueue_get</a>(&amp;myqueue);</div><div class="line">    <span class="keywordflow">if</span> (ql == <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div><div class="line">        ... ; <span class="comment">// unlock a lock shared with the allocator</span></div><div class="line">        ... ; <span class="comment">// block until data is available</span></div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="../../dc/d7e/group__desim.html#ga5b2149049952fc833105a6986e99bb19">el</a> = <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#af8c317a42292b61c93aae91e59118a46">container_of</a>(ql, <span class="keyword">struct</span> <a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html">nlx_core_buffer_event</a>, <a class="code" href="../../d1/d4b/structnlx__core__buffer__event.html#ac0f10a4e5b530ecd00c5b95138e91051">cbe_tm_link</a>);</div><div class="line">    ... ; <span class="comment">// operate on the current element</span></div><div class="line">    ... ; <span class="comment">// release the lock shared with the allocator</span></div><div class="line">}</div></div><!-- fragment --><dl class="section see"><dt>See also</dt><dd><a class="el" href="../../dd/d08/group__bevcqueue.html">Detailed Functional Specification</a> </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li><li class="navelem"><a class="el" href="../../d6/de0/_l_net_d_l_d.html">LNet Transport DLD</a></li><li class="navelem"><a class="el" href="../../de/d4e/_l_netcqueue_d_l_d.html">LNet Buffer Event Circular Queue DLD</a></li>
    <li class="footer">Generated on Fri May 20 2022 10:35:33 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
