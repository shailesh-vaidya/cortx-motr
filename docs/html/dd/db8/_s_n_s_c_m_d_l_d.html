<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: SNS copy machine DLD</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dd/db8/_s_n_s_c_m_d_l_d.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">SNS copy machine DLD </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-ovw">Overview</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-def">Definitions</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-req">Requirements</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-depends">Dependencies</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-highlights">Design Highlights</a></li>
<li><a class="el" href="../../d9/dd8/_s_n_s_c_m_d_l_d-fspec.html#SNSCMDLD-fspec">Functional Specification</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec">Logical specification</a><ul>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-setup">Copy machine setup</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-prepare">Copy machine ready</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-start">Copy machine startup</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-data-next">Copy machine data iterator</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-sliding-window">Copy machine sliding window</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-stop">Copy machine stop</a></li>
</ul>
</li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-conformance">Conformance</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-ut">Unit tests</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-st">System tests</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-O">Analysis</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-ref">References</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-ovw"></a>
Overview</h1>
<p>This module implements sns copy machine using generic copy machine infrastructure. SNS copy machine is built upon the request handler service. The same SNS copy machine can be configured to perform multiple tasks, viz.repair and rebalance using parity de-clustering layout. SNS copy machine is typically started during Motr process startup, although it can also be started later.</p>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-def"></a>
Definitions</h1>
<p>Please refer to "Definitions" section in "HLD of copy machine and agents" and "HLD of SNS Repair" in <a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-ref">References</a></p>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-req"></a>
Requirements</h1>
<ul>
<li><b>r.sns.cm.buffer.acquire</b> The implementation should efficiently provide buffers for the repair as well as re-balance operation without any deadlock.</li>
<li><b>r.sns.cm.sliding.window</b> The implementation should efficiently use various copy machine resources using sliding window during copy machine operation, e.g. memory, cpu, etc.</li>
<li><b>r.sns.cm.sliding.window.init</b> The implementation should efficiently communicate the initial sliding window to other replicas in the cluster.</li>
<li><b>r.sns.cm.sliding.window.update</b> The implementation should efficiently update the sliding window to other replicas during repair.</li>
<li><b>r.sns.cm.data.next</b> The implementation should efficiently select next data to be processed without causing any deadlock or bottle neck.</li>
<li><b>r.sns.cm.report.progress</b> The implementation should efficiently report overall progress of data restructuring and update corresponding layout information for restructured objects.</li>
<li><b>r.sns.cm.repair.trigger</b> For repair, SNS copy machine should respond to triggers caused by various kinds of failures as mentioned in the HLD of SNS Repair.</li>
<li><b>r.sns.cm.repair.iter</b> For repair, SNS copy machine iterator should iterate over parity group units on the survived COBs and accordingly calculate and write the lost data to spare units of the corresponding parity group.</li>
<li><b>r.sns.cm.rebalance.iter</b> For rebalance, SNS copy machine iterator should iterate over the spare units of the repaired parity groups and copy the data from corresponding spare units to the target unit on the new device.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-depends"></a>
Dependencies</h1>
<ul>
<li><p class="startli"><b>r.sns.cm.resources.manage</b> It must be possible to efficiently manage and throttle resources.</p>
<p class="startli">Please refer to "Dependencies" section in "HLD of copy machine and agents" and "HLD of SNS Repair" in <a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-ref">References</a></p>
</li>
</ul>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-highlights"></a>
Design Highlights</h1>
<ul>
<li>SNS copy machine uses request handler service infrastructure.</li>
<li>SNS copy machine specific data structure embeds generic copy machine and other sns repair specific objects.</li>
<li>SNS copy machine defines its specific aggregation group data structure which embeds generic aggregation group.</li>
<li>Once initialised SNS copy machine remains idle until failure is reported.</li>
<li>SNS buffer pool provisioning is done when operation starts.</li>
<li>SNS copy machine creates copy packets only if free buffers are available in the outgoing buffer pool.</li>
<li>Failure triggers SNS copy machine to start repair operation.</li>
<li>For multiple nodes, SNS copy machine maintains a local proxy of every other remote replica in the cluster.</li>
<li>For multiple nodes, SNS copy machine calculates its initial sliding window and communicates it to other replicas identified by the local proxies through READY FOPs.</li>
<li>During the operation the sliding window updates are piggy backed along with the outgoing copy packets and their replies.</li>
<li>Once repair operation is complete, the rebalance operation can start if there exist a new device corresponding to the lost device. Thus the same copy machine is configured to perform re-balance operation.</li>
<li>For rebalance, Each used spare unit corresponds to exactly one (data or parity) unit on the lost device. SNS copy machine uses the same layout as used during sns repair to map a spare unit to the target unit on new device. The newly added device may have a new UUID, but will have the same index in the pool and the COB identifiers of the failed device and the replacement device will also be the same. Thus for re-balance, the same indices of the lost data/parity units on the lost device are used to write on to the newly added device with the same COB identifier as the failed device.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-lspec"></a>
Logical specification</h1>
<ul>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-setup">Copy machine setup</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-prepare">Copy machine ready</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-start">Copy machine startup</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-data-next">Copy machine data iterator</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-sliding-window">Copy machine sliding window</a></li>
<li><a class="el" href="../../dd/db8/_s_n_s_c_m_d_l_d.html#SNSCMDLD-lspec-cm-stop">Copy machine stop</a></li>
</ul>
<h2><a class="anchor" id="SNSCMDLD-lspec-comps"></a>
Component overview</h2>
<p>The focus of sns copy machine is to efficiently restructure (repair or re-balance) data in case of failures, viz. device, node, etc. The restructuring operation is split into various copy packet phases.</p>
<h2><a class="anchor" id="SNSCMDLD-lspec-cm-setup"></a>
Copy machine setup</h2>
<p>SNS copy machine service allocates and initialises the corresponding copy machine. </p><dl class="section see"><dt>See also</dt><dd>SNS Repair service for details. Once the <a class="el" href="../../d8/d6f/ut_2sync_8c.html#a6e096170b1a10d82c6e08fbafaf92355">copy</a> <a class="el" href="../../d7/d93/mdservice_2ut_2mdstore_8c.html#a31ac5fe4c426986a4a393057ae289040">machine</a> is initialised, as part of <a class="el" href="../../d8/d6f/ut_2sync_8c.html#a6e096170b1a10d82c6e08fbafaf92355">copy</a> <a class="el" href="../../d7/d93/mdservice_2ut_2mdstore_8c.html#a31ac5fe4c426986a4a393057ae289040">machine</a> <a class="el" href="../../dd/dc4/namespacesetup.html">setup</a>, SNS <a class="el" href="../../d8/d6f/ut_2sync_8c.html#a6e096170b1a10d82c6e08fbafaf92355">copy</a> <a class="el" href="../../d7/d93/mdservice_2ut_2mdstore_8c.html#a31ac5fe4c426986a4a393057ae289040">machine</a> specific resources are initialised, viz. incoming and outgoing <a class="el" href="../../dd/da2/structbuffer.html">buffer</a> pools (<a class="el" href="../../d5/d77/structm0__sns__cm.html#a934292c80c39b97eef81f2f017b07888">m0_sns_cm::sc_ibp</a> and ::sc_obp). Both the <a class="el" href="../../dd/da2/structbuffer.html">buffer</a> pools are initialised with colours equal to <a class="el" href="../../dc/de2/base_8c.html#ac7af894858cf396a219d632f40afdc8d">total</a> number of localities in the request handler. After cm_setup() is successfully called, the <a class="el" href="../../d8/d6f/ut_2sync_8c.html#a6e096170b1a10d82c6e08fbafaf92355">copy</a> <a class="el" href="../../d7/d93/mdservice_2ut_2mdstore_8c.html#a31ac5fe4c426986a4a393057ae289040">machine</a> transitions to <a class="el" href="../../d0/da4/group___c_m.html#gga167fc16e2b0c0a696c300b1a7357d707a2dbb80a3c8295404b606b78fe6824525">M0_CMS_IDLE</a> state and waits until failure happens. As mentioned in the HLD, failure information is a broadcast to all the replicas in the cluster using TRIGGER FOP. The FOM corresponding to the TRIGGER FOP activates the SNS <a class="el" href="../../d8/d6f/ut_2sync_8c.html#a6e096170b1a10d82c6e08fbafaf92355">copy</a> <a class="el" href="../../d7/d93/mdservice_2ut_2mdstore_8c.html#a31ac5fe4c426986a4a393057ae289040">machine</a> to <a class="el" href="../../d0/da4/group___c_m.html#ga6cb82f8d34f54e75f0f7089da2b00433">start</a> repair operation by invoking <a class="el" href="../../d0/da4/group___c_m.html#ga9af3ca959e6fbe57f613251d16fe65a6">m0_cm_start()</a>, this invokes SNS <a class="el" href="../../d8/d6f/ut_2sync_8c.html#a6e096170b1a10d82c6e08fbafaf92355">copy</a> <a class="el" href="../../d7/d93/mdservice_2ut_2mdstore_8c.html#a31ac5fe4c426986a4a393057ae289040">machine</a> specific <a class="el" href="../../d0/da4/group___c_m.html#ga6cb82f8d34f54e75f0f7089da2b00433">start</a> routine which initialises specific <a class="el" href="../../d4/d00/ut_2di_8c.html#a3de5f992cc2347f66878d072e5934900">data</a> structures.</dd></dl>
<p>Once the repair operation is complete the same copy machine is used to perform re-balance operation, iff there exist a new device/s corresponding to the lost device/s. In re-balance operation the data from the spare units of the repaired parity groups is copied to the new device using the layout.</p>
<h2><a class="anchor" id="SNSCMDLD-lspec-cm-prepare"></a>
Copy machine ready</h2>
<p>Allocates buffers for incoming and outgoing sns copy machine buffer pools.</p>
<h2><a class="anchor" id="SNSCMDLD-lspec-cm-start"></a>
Copy machine startup</h2>
<p>Starts and initialises sns copy machine data iterator. </p><dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d7/daf/group___s_n_s_c_m.html#ga2275ed4ee1e51d9f44a1edf521f3348c">m0_sns_cm_iter_start()</a></dd></dl>
<h2><a class="anchor" id="SNSCMDLD-lspec-cm-data-next"></a>
Copy machine data iterator</h2>
<p>SNS copy machine implements an iterator to efficiently select next data to process. This is done by implementing the copy machine specific operation, <a class="el" href="../../dd/d81/structm0__cm__ops.html#a0638238c9ddd7421ae224fd184ea227d">m0_cm_ops::cmo_data_next()</a>. The following pseudo code illustrates the SNS data iterator for repair as well as re-balance operation,</p>
<div class="fragment"><div class="line">- <span class="keywordflow">for each</span> GOB <a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361a2fe993340f6abb2234e543cd427df70b">G</a> in aux-db (in global <a class="code" href="../../d4/d00/ut_2di_8c.html#a051b4db29ee353e8028232061faeaa22">fid</a> order)</div><div class="line">  - fetch layout L <span class="keywordflow">for</span> <a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361a2fe993340f6abb2234e543cd427df70b">G</a></div><div class="line">  <span class="comment">// proceed in parity group order.</span></div><div class="line">  - <span class="keywordflow">for each</span> <a class="code" href="../../d1/d0e/parity__math__ut_8c.html#a0b2fa0ad38759214c680dad6cdd7f304">parity</a> <a class="code" href="../../d0/d5d/ut_2sm_8c.html#a43ff87b8eb1b8223a2cf8c8f966d7e89">group</a> <a class="code" href="../../d1/d41/ut_2rwlock_8c.html#a0efc1b13f14c790dd3d59de11e12bc6daf1ce01387d2348f8b858721a7db81670">S</a>, until eof of <a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361a2fe993340f6abb2234e543cd427df70b">G</a></div><div class="line">    - <a class="code" href="../../d7/da7/group__processor.html#ga9ec9dda576db2a36c42c1c3af155d07c">map</a> <a class="code" href="../../d0/d5d/ut_2sm_8c.html#a43ff87b8eb1b8223a2cf8c8f966d7e89">group</a> <a class="code" href="../../d1/d41/ut_2rwlock_8c.html#a0efc1b13f14c790dd3d59de11e12bc6daf1ce01387d2348f8b858721a7db81670">S</a> to COB <a class="code" href="../../dd/d94/lib_2ut_2list_8c.html#a510d1f3465504f3f259cf505d0e14d98">list</a></div><div class="line">    <span class="comment">// determine whether group S needs reconstruction.</span></div><div class="line">    - <span class="keywordflow">if</span> no COB.containerid is in the failure <span class="keyword">set</span> <span class="keywordflow">continue</span> to the <a class="code" href="../../d3/daf/group___s_n_s_c_m_c_p.html#ga57d2c0c6b3e56c083dd5cd3fb627de6c">next</a> <a class="code" href="../../d0/d5d/ut_2sm_8c.html#a43ff87b8eb1b8223a2cf8c8f966d7e89">group</a></div><div class="line">    <span class="comment">// group has to be reconstructed, create copy packets for all local units</span></div><div class="line">    - <span class="keywordflow">if</span> REPAIR</div><div class="line">      - <span class="keywordflow">for each</span> <a class="code" href="../../d4/d00/ut_2di_8c.html#a3de5f992cc2347f66878d072e5934900">data</a> and <a class="code" href="../../d1/d0e/parity__math__ut_8c.html#a0b2fa0ad38759214c680dad6cdd7f304">parity</a> unit U in <a class="code" href="../../d1/d41/ut_2rwlock_8c.html#a0efc1b13f14c790dd3d59de11e12bc6daf1ce01387d2348f8b858721a7db81670">S</a> (0 &lt;= U &lt; <a class="code" href="../../d8/d2d/note_8c.html#ac9acce0676755c42b47efe15bfb7da0e">N</a> + K)</div><div class="line">    - <span class="keywordflow">if</span> RE-BALANCE</div><div class="line">      - <span class="keywordflow">for each</span> spare unit U in <a class="code" href="../../d1/d41/ut_2rwlock_8c.html#a0efc1b13f14c790dd3d59de11e12bc6daf1ce01387d2348f8b858721a7db81670">S</a> (<a class="code" href="../../d8/d2d/note_8c.html#ac9acce0676755c42b47efe15bfb7da0e">N</a> + K &lt; U &lt;= <a class="code" href="../../d8/d2d/note_8c.html#ac9acce0676755c42b47efe15bfb7da0e">N</a> + 2K)</div><div class="line">    - <a class="code" href="../../d7/da7/group__processor.html#ga9ec9dda576db2a36c42c1c3af155d07c">map</a> (<a class="code" href="../../d1/d41/ut_2rwlock_8c.html#a0efc1b13f14c790dd3d59de11e12bc6daf1ce01387d2348f8b858721a7db81670">S</a>, U) -&gt; (COB, <a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361af382a63cc3d6491bf26b59e66f46826d">F</a>) by L</div><div class="line">        - <span class="keywordflow">if</span> COB is <a class="code" href="../../d2/d66/group__dtm.html#ga46b3af81e9fb5398c7af9b5cd3f70951">local</a> and COB.containerid does not belong to the failure <span class="keyword">set</span></div><div class="line">          - fetch <a class="code" href="../../d5/d77/structframe.html">frame</a> <a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361af382a63cc3d6491bf26b59e66f46826d">F</a> of COB</div><div class="line">          - <a class="code" href="../../d4/d44/group__cas.html#gad8b4f23dd455dd49c06ff67933b2b18d">create</a> <a class="code" href="../../de/dd4/ut_2fsync_8c.html#ab03ccd061ec8dfcf064d4a0768630b94">copy</a> <a class="code" href="../../df/de8/structpacket.html">packet</a></div></div><!-- fragment --><p> The above iterator iterates through each GOB in aggregation group (parity group) order, so that the copy packet transformation doesn't block. Thus for SNS repair operation, only the data/parity units from every parity group belonging to the lost device are iterated, where as for SNS re-balance operation only the spare units from the repaired parity groups are iterated.</p>
<h2><a class="anchor" id="SNSCMDLD-lspec-cm-sliding-window"></a>
Copy machine sliding window</h2>
<p>SNS copy machine implements sliding window using struct <a class="el" href="../../dd/df9/structm0__cm.html#a950333fb9b8bb352f813d2c517cef904">m0_cm::cm_aggr_grps_in</a> list for aggregation groups having incoming copy packets. SNS copy machine implements the copy machine specific m0_cm::cmo_ag_next() operation to calculate the next relevant aggregation group identifier. Following algorithm illustrates the implementation of m0_cm::cmo_ag_next(),</p>
<p>1) extract GOB (file identifier) G from the given aggregation group identifier A 2) extract parity group identifier P from A 3) increment P to process next group 4) if G is valid (i.e. G is not any of the reserved file identifier e.g. M0_COB_ROOT_FID)</p><ul>
<li>fetch layout and file size for G</li>
<li>calculate total number of parity groups Sn for G</li>
<li>for each parity group P' until eof of G (p &lt; p' &lt; Sn)</li>
<li>setup aggregation group identifier A' using G and P</li>
<li>If P' is relevant aggregation group (has spare unit on any of the local COBs)</li>
<li>If copy machine has space (has enough buffers for all the incoming copy packets)</li>
<li>return A' 5) else reset P to 0, fetch next G from aux-db and repeat from step 5</li>
</ul>
<p><a class="el" href="../../dd/d81/structm0__cm__ops.html#ae24582a226972799a6d04302c22c28ab">m0_cm_ops::cmo_ag_next()</a> is invoked from <a class="el" href="../../d6/db9/group___c_m_a_g.html#ga212ab83fecbbc4ae12137e3023e3c3ad">m0_cm_ag_advance()</a> in a loop until <a class="el" href="../../dd/d81/structm0__cm__ops.html#ae24582a226972799a6d04302c22c28ab">m0_cm_ops::cmo_ag_next()</a> returns valid next relevant aggregation group identifier.</p>
<h2><a class="anchor" id="SNSCMDLD-lspec-cm-stop"></a>
Copy machine stop</h2>
<p>Once all the COBs (i.e. component objects) corresponding to the GOBs (i.e global file objects) belonging to the failure set are re-structured (repair or re-balance) by every replica in the cluster successfully, the re-structuring operation is marked complete.</p>
<h2><a class="anchor" id="SNSCMDLD-lspec-thread"></a>
Threading and Concurrency Model</h2>
<p>SNS copy machine is implemented as a request handler service, thus it shares the request handler threading model and does not create its own threads. All the copy machine operations are performed in context of request handler threads.</p>
<p>SNS copy machine uses generic copy machine infrastructure, which implements copy machine state machine using generic Motr state machine infrastructure. State machine</p>
<p>Locking All the updates to members of copy machine are done with <a class="el" href="../../d0/da4/group___c_m.html#ga516a97e7200e55a7d4f5626512ee2606">m0_cm_lock()</a> held.</p>
<h2><a class="anchor" id="SNSCMDLD-lspec-numa"></a>
NUMA optimizations</h2>
<p>N/A</p>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-conformance"></a>
Conformance</h1>
<p><b>i.sns.cm.buffer.acquire</b> SNS copy machine implements its incoming and outgoing buffer pools. The outgoing buffer pool is used to create copy packets. The respective buffer pools are provisioned during the start of the copy machine operation.</p>
<p><b>i.sns.cm.sliding.window</b> SNS copy machine implements the sliding window using the struct <a class="el" href="../../dd/df9/structm0__cm.html#a950333fb9b8bb352f813d2c517cef904">m0_cm::cm_aggr_grps_in</a> list for aggregation groups having incoming copy packets.</p>
<p><b>i.sns.cm.sliding.window.init</b> SNS copy machine calculates and communicates the initial sliding window in M0_CMS_READY phase through READY FOPs.</p>
<p><b>i.sns.cm.sliding.window.update</b> SNS copy machine piggy backs the sliding window with every outgoing copy packet during the operation.</p>
<p><b>i.sns.cm.data.next</b> SNS copy machine implements a next function using cob name space iterator and pdclust layout infrastructure to select the next data to be repaired from the failure set. This is done in GOB fid and parity group order.</p>
<p><b>i.sns.cm.report.progress</b> Progress is reported using sliding window and layout updates.</p>
<p><b>i.sns.cm.repair.trigger</b> Various failures are reported through TRIGGER FOP, which create corresponding FOMs. FOMs invoke sns specific copy machine operations through generic copy machine interfaces which cause copy machine state transitions.</p>
<p><b>r.sns.cm.repair.iter</b> For repair, SNS copy machine iterator iterates over parity group units on the survived COBs and accordingly calculates and writes the lost data to spare units of the corresponding parity group using layout.</p>
<p><b>r.sns.cm.rebalance.iter</b> For rebalance, SNS copy machine iterator iterates over only the spare units of the repaired parity groups and copy the data to the corresponding target units on the new device.</p>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-ut"></a>
Unit tests</h1>
<h2><a class="anchor" id="SNSCMDLD-ut-cp"></a>
Copy packet specific tests</h2>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000125">Test:</a></b></dt><dd>Test01: If an aggregation group is having a single copy packet, then transformation function should be a NO-OP.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000126">Test:</a></b></dt><dd>Test02: Test if all copy packets of an aggregation group get collected.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000127">Test:</a></b></dt><dd>Test03: Test the transformation function. Input: 2 bufvec's src and dest to be XORed. Output: XORed output stored in dest bufvec.</dd></dl>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-st"></a>
System tests</h1>
<p>N/A</p>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-O"></a>
Analysis</h1>
<p>N/A</p>
<hr/>
 <h1><a class="anchor" id="SNSCMDLD-ref"></a>
References</h1>
<p>Following are the references to the documents from which the design is derived, For documentation links, please refer to this file : doc/motr-design-doc-list.rst</p><ul>
<li>Copy Machine redesign</li>
<li>HLD of copy machine and agents</li>
<li>HLD of SNS Repair </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li>
    <li class="footer">Generated on Fri May 20 2022 10:35:35 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
