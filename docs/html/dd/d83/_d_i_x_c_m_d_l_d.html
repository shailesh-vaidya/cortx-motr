<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: DIX copy machine DLD</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dd/d83/_d_i_x_c_m_d_l_d.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">DIX copy machine DLD </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-ovw">Overview</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-def">Definitions</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-req">Requirements</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-depends">Dependencies</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-highlights">Design Highlights</a></li>
<li><a class="el" href="../../da/d26/_d_i_x_c_m_d_l_d-fspec.html#DIXCMDLD-fspec">Functional Specification</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec">Logical specification</a><ul>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-setup">Copy machine setup</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-prepare">Copy machine ready</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-start">Copy machine startup</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-data-next">Copy machine data iterator</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-sliding-window">Copy machine sliding window</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-stop">Copy machine stop</a></li>
</ul>
</li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-conformance">Conformance</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-ut">Unit tests</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-st">System tests</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-O">Analysis</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-ref">References</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-ovw"></a>
Overview</h1>
<p>This module implements DIX copy machine using generic copy machine infrastructure. DIX copy machine is built upon the request handler service. The same DIX copy machine can be configured to perform multiple tasks, repair and rebalance using parity de-clustering layout. DIX copy machine is typically started during Motr process startup, although it can also be started later.</p>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-def"></a>
Definitions</h1>
<p>Please refer to "Definitions" section in "HLD of copy machine and agents" and <a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-ref">References</a></p>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-req"></a>
Requirements</h1>
<ul>
<li><b>r.dix.cm.aggregation.group</b> Aggregation groups should be implemented taking into account that it should lead to minimal changes into common framework.</li>
<li><b>r.dix.cm.data.next</b> The implementation should efficiently select next data to be processed without causing any deadlock or bottle neck.</li>
<li><b>r.dix.cm.report.progress</b> The implementation should efficiently report overall progress of data restructuring and update corresponding layout information for restructured objects.</li>
<li><b>r.dix.cm.repair.trigger</b> For repair, DIX copy machine should respond to triggers caused by various kinds of failures.</li>
<li><b>r.dix.cm.repair.iter</b> For repair, DIX copy machine iterator should iterate over parity group units on the survived component catalogues and accordingly write the lost data to spare units of the corresponding parity group.</li>
<li><b>r.dix.cm.rebalance.iter</b> For rebalance, DIX copy machine iterator should iterate over the spare units of the repaired parity groups and copy the data from corresponding spare units to the target unit on the new device.</li>
<li><b>r.dix.cm.be.btree</b> The implementation should work with BE btree directly without calling routines of CAS service.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-depends"></a>
Dependencies</h1>
<ul>
<li><p class="startli"><b>r.dix.cm.resources.manage</b> It must be possible to efficiently manage and throttle resources.</p>
<p class="startli">Please refer to "Dependencies" section in "HLD of copy machine and agents" and "HLD of SNS Repair" in <a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-ref">References</a></p>
</li>
</ul>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-highlights"></a>
Design Highlights</h1>
<ul>
<li>DIX copy machine uses request handler service infrastructure.</li>
<li>DIX copy machine specific data structure embeds generic copy machine and other DIX repair specific objects.</li>
<li>DIX copy machine defines its specific aggregation group data structure which embeds generic aggregation group.</li>
<li>Once initialised DIX copy machine remains idle until failure is reported.</li>
<li>DIX copy machine creates copy packets and allocates buffers dynamically without using of any pools.</li>
<li>Failure triggers DIX copy machine to start repair operation.</li>
<li>For multiple nodes, DIX copy machine maintains a local proxy of every other remote replica in the cluster.</li>
<li>For multiple nodes, DIX copy machine sets infinite bounds for its sliding window and communicates it to other replicas identified by the local proxies through READY FOPs.</li>
<li>Every node that serves some unit (from the same parity group) that contains data (as spare units can contain data as well) has enough information to restore parity by sending of served unit. To make this process more deterministic the following rule can be used: if some node serves unit with the lowest number (in scope of parity group) that contains data - this node is responsible for restoring of parity.</li>
<li>No data transformation is needed by DIX repair/re-balance processes.</li>
<li>Aggregation groups are not really needed by DIX repair/re-balance proccesses and can be implemented rudimentary. Such solution allows to use the code of generic copy machine without significant modification. <dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000069">Todo:</a></b></dt><dd>It would be nice to find the solution where implementation of any kind of aggregation groups is not necessary.</dd></dl>
</li>
</ul>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-lspec"></a>
Logical specification</h1>
<ul>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-setup">Copy machine setup</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-prepare">Copy machine ready</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-start">Copy machine startup</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-data-next">Copy machine data iterator</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-sliding-window">Copy machine sliding window</a></li>
<li><a class="el" href="../../dd/d83/_d_i_x_c_m_d_l_d.html#DIXCMDLD-lspec-cm-stop">Copy machine stop</a></li>
</ul>
<h2><a class="anchor" id="DIXCMDLD-lspec-comps"></a>
Component overview</h2>
<p>The focus of DIX copy machine is to efficiently restructure (repair or re-balance) data in case of failures, viz. device, node, etc. The restructuring operation is split into various copy packet phases.</p>
<h2><a class="anchor" id="DIXCMDLD-lspec-cm-setup"></a>
Copy machine setup</h2>
<p>DIX copy machine service allocates and initialises the corresponding copy machine. After cm_setup() is successfully called, the copy machine transitions to M0_CMS_IDLE state and waits until failure happens. As mentioned in the HLD, failure information is a broadcast to all the replicas in the cluster using TRIGGER FOP. The FOM corresponding to the TRIGGER FOP activates the DIX copy machine to start repair operation by invoking <a class="el" href="../../d0/da4/group___c_m.html#ga9af3ca959e6fbe57f613251d16fe65a6">m0_cm_start()</a>, this invokes DIX copy machine specific start routine which initialises specific data structures.</p>
<p>Once the repair operation is complete the same copy machine is used to perform re-balance operation. In re-balance operation the data from the containing unit with the lowest index in the repaired parity group is copied to the new device using the layout.</p>
<h2><a class="anchor" id="DIXCMDLD-lspec-cm-prepare"></a>
Copy machine ready</h2>
<p>Once copy machine is initialised it is ready to start repair/re-balance process.</p>
<h2><a class="anchor" id="DIXCMDLD-lspec-cm-start"></a>
Copy machine startup</h2>
<p>Starts and initialises DIX copy machine data iterator. </p><dl class="section see"><dt>See also</dt><dd><a class="el" href="../../de/d70/group___d_i_x_c_m.html#ga02b26be021c908caf37f2ad4e1f4e4e7">m0_dix_cm_iter_start()</a></dd></dl>
<h2><a class="anchor" id="DIXCMDLD-lspec-cm-data-next"></a>
Copy machine data iterator</h2>
<p>DIX copy machine implements an iterator to efficiently select next data to process. This is done by implementing the copy machine specific operation, <a class="el" href="../../dd/d81/structm0__cm__ops.html#a0638238c9ddd7421ae224fd184ea227d">m0_cm_ops::cmo_data_next()</a>. The following pseudo code illustrates the DIX data iterator for repair as well as re-balance operation,</p>
<div class="fragment"><div class="line">- <span class="keywordflow">for each</span> component catalogue <a class="code" href="../../d6/d0c/ut_2xcode_8c.html#ab95b5b1d7e996d595de83e89c7366920">C</a> in ctidx</div><div class="line">  - fetch layout L <span class="keywordflow">for</span> <a class="code" href="../../d6/d0c/ut_2xcode_8c.html#ab95b5b1d7e996d595de83e89c7366920">C</a></div><div class="line">  <span class="comment">// proceed in local key order (keys belong to C).</span></div><div class="line">  - <span class="keywordflow">for each</span> <a class="code" href="../../d2/d66/group__dtm.html#ga46b3af81e9fb5398c7af9b5cd3f70951">local</a> <a class="code" href="../../d6/d35/structkey.html">key</a> <a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361ad091b8e376f7cf432dc367e1eda65e85">I</a> belonging to <a class="code" href="../../d6/d0c/ut_2xcode_8c.html#ab95b5b1d7e996d595de83e89c7366920">C</a></div><div class="line">    <span class="comment">// determine whether group S that I belongs to needs reconstruction.</span></div><div class="line">    - <span class="keywordflow">if</span> no device <span class="keywordtype">id</span> is in the failure <span class="keyword">set</span> <span class="keywordflow">continue</span> to the <a class="code" href="../../d3/daf/group___s_n_s_c_m_c_p.html#ga57d2c0c6b3e56c083dd5cd3fb627de6c">next</a> <a class="code" href="../../d6/d35/structkey.html">key</a></div><div class="line">    <span class="comment">// group has to be reconstructed, check whether the unit that contains</span></div><div class="line">    <span class="comment">// data and has the lowest number in group S is served locally</span></div><div class="line">    - <span class="keywordflow">for each</span> <a class="code" href="../../d4/d00/ut_2di_8c.html#a3de5f992cc2347f66878d072e5934900">data</a>, <a class="code" href="../../d1/d0e/parity__math__ut_8c.html#a0b2fa0ad38759214c680dad6cdd7f304">parity</a> and spare unit U in <a class="code" href="../../d1/d41/ut_2rwlock_8c.html#a0efc1b13f14c790dd3d59de11e12bc6daf1ce01387d2348f8b858721a7db81670">S</a> (0 &lt;= U &lt; <a class="code" href="../../d8/d2d/note_8c.html#ac9acce0676755c42b47efe15bfb7da0e">N</a> + 2K)</div><div class="line">      - <span class="keywordflow">if</span> U is <a class="code" href="../../d2/d66/group__dtm.html#ga46b3af81e9fb5398c7af9b5cd3f70951">local</a> &amp;&amp; U contains <a class="code" href="../../d4/d00/ut_2di_8c.html#a3de5f992cc2347f66878d072e5934900">data</a> &amp;&amp; U number is <a class="code" href="../../d8/d42/group__crate.html#ga07d21d91aa8686f81164888d63891ac4">min</a></div><div class="line">        - determine destination</div><div class="line">        - <a class="code" href="../../d4/d44/group__cas.html#gad8b4f23dd455dd49c06ff67933b2b18d">create</a> <a class="code" href="../../de/dd4/ut_2fsync_8c.html#ab03ccd061ec8dfcf064d4a0768630b94">copy</a> <a class="code" href="../../df/de8/structpacket.html">packet</a></div></div><!-- fragment --><p> The above iterator iterates through each component catalogue in catalogue-index catalogue in record key order and determines whether corresponding parity group needs reconstruction, if yes then checks whether it serves the unit that contains data and has the lowest index in scope of parity group, if so then this node is responsible for data reconstruction. After that the destination is determined and copy packet is created.</p>
<h2><a class="anchor" id="DIXCMDLD-lspec-cm-sliding-window"></a>
Copy machine sliding window</h2>
<p>DIX copy machine supports only infinite sliding window that does not need to be maintained. It is caused by the following reasons:</p><ul>
<li>DIX repair/rebalance processes have no data transformation, so it is not needed to regulate data reconstruction process using sliding window</li>
<li>Aggregation groups IDs can not be determined and ordered for distributed indices to apply sliding window Some mandatory callbacks can be implemented as stubs.</li>
</ul>
<h2><a class="anchor" id="DIXCMDLD-lspec-cm-stop"></a>
Copy machine stop</h2>
<p>Once all the component objects corresponding to the distibuted indices belonging to the failure set are re-structured (repair or re-balance) by every replica in the cluster successfully, the re-structuring operation is marked complete.</p>
<h2><a class="anchor" id="DIXCMDLD-lspec-thread"></a>
Threading and Concurrency Model</h2>
<p>DIX copy machine is implemented as a request handler service, thus it shares the request handler threading model and does not create its own threads. All the copy machine operations are performed in context of request handler threads.</p>
<p>DIX copy machine uses generic copy machine infrastructure, which implements copy machine state machine using generic Motr state machine infrastructure. State machine</p>
<p>Locking All the updates to members of copy machine are done with <a class="el" href="../../d0/da4/group___c_m.html#ga516a97e7200e55a7d4f5626512ee2606">m0_cm_lock()</a> held.</p>
<h2><a class="anchor" id="DIXCMDLD-lspec-numa"></a>
NUMA optimizations</h2>
<p>N/A</p>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-conformance"></a>
Conformance</h1>
<ul>
<li><b>i.dix.cm.aggregation.group</b> Aggregation groups should be implemented taking into account that it should lead to minimal changes into common framework.</li>
<li><b>i.dix.cm.data.next</b> DIX copy machine implements a next function using catalogue-index catalogue iterator and pdclust layout infrastructure to select the next data to be repaired from the failure set. This is done in component catalogue fid order.</li>
<li><b>i.dix.cm.report.progress</b> The implementation should efficiently report overall progress of data restructuring and update corresponding layout information for restructured objects.</li>
<li><b>i.dix.cm.repair.trigger</b> Various failures are reported through TRIGGER FOP, which create corresponding FOMs. FOMs invoke dix specific copy machine operations through generic copy machine interfaces which cause copy machine state transitions.</li>
<li><b>i.dix.cm.repair.iter</b> For repair, DIX copy machine iterator iterates over record keys, determines whether servived data containing unit with the lowest index in scope of parity group is served locally to use it for lost data reconstruction.</li>
<li><b>i.dix.cm.rebalance.iter</b> For rebalance, DIX copy machine acts like the repair iterator to copy the data to the corresponding target units on the new device.</li>
<li><b>i.dix.cm.be.btree</b> DIX copy machine calls BE btree interfaces without calling of routines of CAS service.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-ut"></a>
Unit tests</h1>
<p>N/A</p>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-st"></a>
System tests</h1>
<p>N/A</p>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-O"></a>
Analysis</h1>
<p>N/A</p>
<hr/>
 <h1><a class="anchor" id="DIXCMDLD-ref"></a>
References</h1>
<p>Following are the references to the documents from which the design is derived. For documentation links, please refer to this file : doc/motr-design-doc-list.rst</p><ul>
<li>Copy Machine redesign</li>
<li>HLD of copy machine and agents</li>
<li>HLD of SNS Repair </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li>
    <li class="footer">Generated on Fri May 20 2022 10:35:31 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
