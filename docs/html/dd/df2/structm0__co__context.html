<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: m0_co_context Struct Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dd/df2/structm0__co__context.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-attribs">Data Fields</a>  </div>
  <div class="headertitle">
<div class="title">m0_co_context Struct Reference<div class="ingroups"><a class="el" href="../../df/d37/group___coroutine.html">Coroutine</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a>&gt;</code></p>
<div class="dynheader">
Collaboration diagram for m0_co_context:</div>
<div class="dyncontent">
<div class="center"><img src="../../d8/d0a/structm0__co__context__coll__graph.png" border="0" usemap="#m0__co__context_coll__map" alt="Collaboration graph"/></div>
<map name="m0__co__context_coll__map" id="m0__co__context_coll__map">
<area shape="rect" id="node4" href="../../dc/de2/structm0__co__locals__allocator.html" title="{m0_co_locals_allocator\n||}" alt="" coords="136,160,294,237"/>
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-attribs"></a>
Data Fields</h2></td></tr>
<tr class="memitem:ae827098c4569e7dd524312f117c81f97"><td class="memItemLeft" align="right" valign="top">void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/df2/structm0__co__context.html#ae827098c4569e7dd524312f117c81f97">mc_stack</a> [<a class="el" href="../../df/d37/group___coroutine.html#gga9e9505a91a84992d04ba4e85217fb4e4aaa1545af814eb7c4ed6091b0ecd804d5">M0_MCC_STACK_NR</a>]</td></tr>
<tr class="separator:ae827098c4569e7dd524312f117c81f97"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd61e6e595adfd81e68144be001ac4fd"><td class="memItemLeft" align="right" valign="top">void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/df2/structm0__co__context.html#acd61e6e595adfd81e68144be001ac4fd">mc_locals</a> [<a class="el" href="../../df/d37/group___coroutine.html#gga9e9505a91a84992d04ba4e85217fb4e4aaa1545af814eb7c4ed6091b0ecd804d5">M0_MCC_STACK_NR</a>]</td></tr>
<tr class="separator:acd61e6e595adfd81e68144be001ac4fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a31e25602bf0d487246f06953532890e1"><td class="memItemLeft" align="right" valign="top">uint64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/df2/structm0__co__context.html#a31e25602bf0d487246f06953532890e1">mc_frame</a></td></tr>
<tr class="separator:a31e25602bf0d487246f06953532890e1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5c51af09e22fa2273dab436ba5e54c3b"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/df2/structm0__co__context.html#a5c51af09e22fa2273dab436ba5e54c3b">mc_yield</a></td></tr>
<tr class="separator:a5c51af09e22fa2273dab436ba5e54c3b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0ba16ea7f79ce7a7668b3726c9fc1119"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/df2/structm0__co__context.html#a0ba16ea7f79ce7a7668b3726c9fc1119">mc_co_end_ret</a></td></tr>
<tr class="separator:a0ba16ea7f79ce7a7668b3726c9fc1119"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5668c00f42f48e92202c59d616e3d40d"><td class="memItemLeft" align="right" valign="top">uint64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/df2/structm0__co__context.html#a5668c00f42f48e92202c59d616e3d40d">mc_yield_frame</a></td></tr>
<tr class="separator:a5668c00f42f48e92202c59d616e3d40d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab50bcf37f8047ecbdc2c0b4ebef1fccf"><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="../../dc/de2/structm0__co__locals__allocator.html">m0_co_locals_allocator</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/df2/structm0__co__context.html#ab50bcf37f8047ecbdc2c0b4ebef1fccf">mc_alloc</a></td></tr>
<tr class="separator:ab50bcf37f8047ecbdc2c0b4ebef1fccf"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Coroutine context.</p>
<p>Saves current state, including coroutine local variables, control flow data, other state variables w.r.t. restore this state after reentering the stack of functions coroutines are used in.</p>
<p>While working with coroutines, user has to use local on-stack variables with understanding, that after yield their values have to be resorted manually. Instead he has to put <a class="el" href="../../df/d37/group___coroutine.html#ga8bd5710de50b89b1b9960e8653fea940">M0_CO_REENTER()</a> inside the beginning of every function, and inside every function in every function-stack which is being yielded.</p>
<p>&lsquo;Restorable variables&rsquo; are used like locals and can be declared inside <a class="el" href="../../df/d37/group___coroutine.html#ga8bd5710de50b89b1b9960e8653fea940">M0_CO_REENTER()</a>. The following code can be inside one of yielded functions: </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/dad/structfoo.html">foo</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/df2/structm0__co__context.html">m0_co_context</a> *context, ...)</div><div class="line">{</div><div class="line">     <a class="code" href="../../df/d37/group___coroutine.html#ga8bd5710de50b89b1b9960e8653fea940">M0_CO_REENTER</a>(context,</div><div class="line">                   <span class="keywordtype">int</span>   a;</div><div class="line">                   <span class="keywordtype">char</span>  b[100];</div><div class="line">                   <span class="keywordtype">int</span>   <a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>;</div><div class="line">     );</div><div class="line">     ...</div><div class="line">}</div></div><!-- fragment --><p>By design, &lsquo;restorable variables&rsquo; can be accessed with <a class="el" href="../../df/d37/group___coroutine.html#ga598282c9adbe6074f986d66618dcdbee">M0_CO_FRAME_DATA()</a>, which can be redefined and used like in the following example: </p><div class="fragment"><div class="line"><span class="preprocessor">#define F M0_CO_FRAME_DATA</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/dad/structfoo.html">foo</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/df2/structm0__co__context.html">m0_co_context</a> *context, ...)</div><div class="line">{</div><div class="line">     <a class="code" href="../../df/d37/group___coroutine.html#ga8bd5710de50b89b1b9960e8653fea940">M0_CO_REENTER</a>(context, ...</div><div class="line">     );</div><div class="line">     ...</div><div class="line">     <a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361af382a63cc3d6491bf26b59e66f46826d">F</a>(<a class="code" href="../../d7/db8/cm_2repreb_2trigger__fop_8h.html#ac6509c6fe4cbf7bde170597172f8a288">rc</a>) = -EINVAL;</div><div class="line">     <a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361af382a63cc3d6491bf26b59e66f46826d">F</a>(a)  = 0xb100df100d;</div><div class="line">     strncpy(<a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361af382a63cc3d6491bf26b59e66f46826d">F</a>(b), <span class="stringliteral">&quot;sillybuff&quot;</span>, <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a25f003de16c08a4888b69f619d70f427">ARRAY_SIZE</a>(<a class="code" href="../../db/d13/module_2ut_2module_8c.html#a723bc6621e4dccd9dd0704cca281a361af382a63cc3d6491bf26b59e66f46826d">F</a>(b)));</div><div class="line">     ...</div><div class="line">}</div></div><!-- fragment --><p>It can be seen, that user has to maintain &lsquo;struct <a class="el" href="../../dd/df2/structm0__co__context.html">m0_co_context</a> context&rsquo; inside his own structures. For motr code, it's is implied to be related to FOM or FOM objects. m0_co_context_{init,fini}() used for these purposes.</p>
<p>Every function, which potentially can be unwinded during yield has to be wrapped with <a class="el" href="../../df/d37/group___coroutine.html#gac9ce206b33009e4b9cdfeacf5104b486">M0_CO_FUN()</a>.</p>
<p>Every place inside underlying functions wrapped by <a class="el" href="../../df/d37/group___coroutine.html#gac9ce206b33009e4b9cdfeacf5104b486">M0_CO_FUN()</a> can be yielded with <a class="el" href="../../df/d37/group___coroutine.html#gaf637363c8dc8937c71aba7db37e5a23a">M0_CO_YIELD()</a>. After this call, function stack is being unwinded up to the place in code where top-level coroutine call is being performed. Our code assumes this place to be near by FOM <a class="el" href="../../d9/d85/ut_2locality_8c.html#a4d93f1b838975a6591edcbdb7b22a862">tick()</a>-function: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> foo_tick(<span class="keyword">struct</span> <a class="code" href="../../d9/db7/structm0__fom.html">m0_fom</a> *<a class="code" href="../../d7/d59/structfom.html">fom</a>)</div><div class="line">{ ...</div><div class="line">     <a class="code" href="../../df/d37/group___coroutine.html#gad2802d4f41e1eb0251d8f2e13814ed07">M0_CO_START</a>(&amp;context);</div><div class="line">     top_rc = toplevel_foo(&amp;context); <span class="comment">// calls foo()-&gt;foo0()-&gt;...-&gt;foo_n()</span></div><div class="line">      co_rc = <a class="code" href="../../df/d37/group___coroutine.html#ga89f24b2a00f81ce3f2f01613fce72b1d">M0_CO_END</a>(&amp;context);</div><div class="line">  ...</div><div class="line">}</div></div><!-- fragment --><p>User controls execution of coroutine by checking &lsquo;<a class="el" href="../../df/d37/group___coroutine.html#ga89f24b2a00f81ce3f2f01613fce72b1d">M0_CO_END(&amp;context)</a>&rsquo;-value. Coroutine is in progress if -EAGAIN is returned, if 0 &ndash; it is succeeded. </p>

<p class="definition">Definition at line <a class="el" href="../../db/d95/coroutine_8h_source.html#l00136">136</a> of file <a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a>.</p>
</div><h2 class="groupheader">Field Documentation</h2>
<a id="ab50bcf37f8047ecbdc2c0b4ebef1fccf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab50bcf37f8047ecbdc2c0b4ebef1fccf">&#9670;&nbsp;</a></span>mc_alloc</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="../../dc/de2/structm0__co__locals__allocator.html">m0_co_locals_allocator</a> mc_alloc</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>simple pool allocator for locals </p>

<p class="definition">Definition at line <a class="el" href="../../db/d95/coroutine_8h_source.html#l00150">150</a> of file <a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a>.</p>

</div>
</div>
<a id="a0ba16ea7f79ce7a7668b3726c9fc1119"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0ba16ea7f79ce7a7668b3726c9fc1119">&#9670;&nbsp;</a></span>mc_co_end_ret</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int mc_co_end_ret</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>code returned from <a class="el" href="../../df/d37/group___coroutine.html#ga89f24b2a00f81ce3f2f01613fce72b1d">M0_CO_END()</a> macro, set in <a class="el" href="../../df/d37/group___coroutine.html#gaf637363c8dc8937c71aba7db37e5a23a">M0_CO_YIELD()</a> </p>

<p class="definition">Definition at line <a class="el" href="../../db/d95/coroutine_8h_source.html#l00146">146</a> of file <a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a>.</p>

</div>
</div>
<a id="a31e25602bf0d487246f06953532890e1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a31e25602bf0d487246f06953532890e1">&#9670;&nbsp;</a></span>mc_frame</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint64_t mc_frame</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>current frame pointer </p>

<p class="definition">Definition at line <a class="el" href="../../db/d95/coroutine_8h_source.html#l00142">142</a> of file <a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a>.</p>

</div>
</div>
<a id="acd61e6e595adfd81e68144be001ac4fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd61e6e595adfd81e68144be001ac4fd">&#9670;&nbsp;</a></span>mc_locals</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* mc_locals[<a class="el" href="../../df/d37/group___coroutine.html#gga9e9505a91a84992d04ba4e85217fb4e4aaa1545af814eb7c4ed6091b0ecd804d5">M0_MCC_STACK_NR</a>]</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>frame locals stack </p>

<p class="definition">Definition at line <a class="el" href="../../db/d95/coroutine_8h_source.html#l00140">140</a> of file <a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a>.</p>

</div>
</div>
<a id="ae827098c4569e7dd524312f117c81f97"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae827098c4569e7dd524312f117c81f97">&#9670;&nbsp;</a></span>mc_stack</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* mc_stack[<a class="el" href="../../df/d37/group___coroutine.html#gga9e9505a91a84992d04ba4e85217fb4e4aaa1545af814eb7c4ed6091b0ecd804d5">M0_MCC_STACK_NR</a>]</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>frame address stack </p>

<p class="definition">Definition at line <a class="el" href="../../db/d95/coroutine_8h_source.html#l00138">138</a> of file <a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a>.</p>

</div>
</div>
<a id="a5c51af09e22fa2273dab436ba5e54c3b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5c51af09e22fa2273dab436ba5e54c3b">&#9670;&nbsp;</a></span>mc_yield</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool mc_yield</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>true if stack is unwinding </p>

<p class="definition">Definition at line <a class="el" href="../../db/d95/coroutine_8h_source.html#l00144">144</a> of file <a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a>.</p>

</div>
</div>
<a id="a5668c00f42f48e92202c59d616e3d40d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5668c00f42f48e92202c59d616e3d40d">&#9670;&nbsp;</a></span>mc_yield_frame</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint64_t mc_yield_frame</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>current frame pointer during reentering </p>

<p class="definition">Definition at line <a class="el" href="../../db/d95/coroutine_8h_source.html#l00148">148</a> of file <a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a>.</p>

</div>
</div>
<hr/>The documentation for this struct was generated from the following file:<ul>
<li>lib/<a class="el" href="../../db/d95/coroutine_8h_source.html">coroutine.h</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dd/df2/structm0__co__context.html">m0_co_context</a></li>
    <li class="footer">Generated on Fri May 20 2022 10:36:12 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
