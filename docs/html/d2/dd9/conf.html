<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: DLD of configuration caching</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d2/dd9/conf.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">DLD of configuration caching </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../d2/dd9/conf.html#conf-ovw">Overview</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-def">Definitions</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-req">Requirements</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-depends">Dependencies</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-highlights">Design Highlights</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-fspec">Functional Specification</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-lspec">Logical Specification</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-conformance">Conformance</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-ut">Unit Tests</a></li>
<li>conf-st</li>
<li>conf-O</li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-scalability">Scalability</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-ref">References</a></li>
<li>conf-impl-plan</li>
</ul>
<hr/>
 <h1><a class="anchor" id="conf-ovw"></a>
Overview</h1>
<p>Configuration is part of Motr cluster meta-data. Configuration client library (confc) provides API for accessing configuration data. Confc obtains configuration data from the configuration server (confd) and caches this data in local memory.</p>
<p>Confd tries to obtain requested configuration data from its own cache. In case of cache miss, confd loads data from the configuration database and updates the cache.</p>
<p>Confd is a user-space service. Confc library is implemented in user space and in the kernel. Applications access configuration data by linking with confc library and using its API.</p>
<hr/>
 <h1><a class="anchor" id="conf-def"></a>
Definitions</h1>
<ul>
<li><b>Confc</b> (configuration client library, configuration client): a library that provides configuration consumers with API to query Motr configuration.</li>
<li><b>Confd</b> (configuration server): a management service that provides configuration clients with information obtained from configuration database.</li>
<li>Configuration <b>consumer:</b> any software that uses confc API to access Motr configuration. Alternative name: <b>application</b>.</li>
<li>Configuration <b>cache:</b> configuration data stored in nodeâ€™s memory. Confc library maintains such a cache and provides configuration consumers with access to its data. Confd also uses configuration cache for faster retrieval of information requested by configuration clients.</li>
<li>Configuration <b>object:</b> a data structure that contains configuration information. There are several types of configuration objects: filesystem, service, node, etc.</li>
<li><b>Identity</b> of a configuration object is a pair of its type and identifier.</li>
<li>Configuration object is a <b>stub</b> if its status is not equal to M0_CS_READY. Stubs contain no meaningful configuration data.</li>
<li>A configuration object is said to be <b>pinned</b> if its reference counter is nonzero; otherwise it is <b>unpinned</b>.</li>
<li><b>Relation:</b> a pointer from one configuration object to another configuration object or to a collection of objects. In former case it is <b>one-to-one</b> relation, in the latter case it is <b>one-to-many</b> relation.</li>
<li><b>Downlink:</b> a relation whose destination is located further from the "root" configuration object than the origin.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="conf-req"></a>
Requirements</h1>
<ul>
<li><b>r.conf.confc.kernel</b> Confc library must be implemented for the kernel.</li>
<li><b>r.conf.confc.user</b> Confc library must be implemented for user space.</li>
<li><b>r.conf.confc.async</b> Confc library provides asynchronous interfaces for accessing configuration data.</li>
<li><b>r.conf.cache.data-model</b> The implementation should organize configuration information as outlined in section 4.1 of the HLD. The same data structures should be used for confc and confd caches, if possible. Configuration structures must be kept in memory.</li>
<li><b>r.conf.cache.pinning</b> Pinning of an object protects existence of this object in the cache. Pinned object can be moved from a stub condition to "ready".</li>
<li><b>r.conf.cache.unique-objects</b> Configuration cache must not contain multiple objects with the same identity.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="conf-depends"></a>
Dependencies</h1>
<ul>
<li>We assume that the size of configuration database is very small compared with other meta-data. Confd can take advantage of this assumption and load the entire contents of configuration database into the cache.</li>
<li>Motr database library ("db/db.h") should provide a user-space interface for creating in-memory databases. This interface will be used by confd and user-space confc.</li>
<li><p class="startli"><a class="el" href="../../db/de9/group__rpc.html#ga260cb5dd16d88d6262e4736276535a6d">m0_rpc_item_get()</a> and <a class="el" href="../../db/de9/group__rpc.html#gaa30c26be52bcb511339a632deae6c092">m0_rpc_item_put()</a> should be implemented.</p>
<p class="startli">Confc implementation schedules a state transition in -&gt;rio_replied(). The data of -&gt;ri_reply will be consumed only when the new state is being entered to. The rpc item pointed to by -&gt;ri_reply must not be freed (by rpc layer) until confc has consumed the data. Thus the need for <a class="el" href="../../db/de9/group__rpc.html#ga260cb5dd16d88d6262e4736276535a6d">m0_rpc_item_get()</a>.</p>
</li>
</ul>
<hr/>
 <h1><a class="anchor" id="conf-highlights"></a>
Design Highlights</h1>
<ul>
<li><p class="startli">The application should not use relations of a configuration object to access other objects.</p>
<p class="startli">Rationale: relations may point to unpinned objects. Confc implementation may convert unpinned objects into stubs. The application shall not use stubs, since they contain no valid configuration data.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d9/d5d/conf-fspec-obj.html#conf-fspec-obj-private">Private Fields</a></dd></dl>
</li>
<li>The registry of cached configuration objects (<a class="el" href="../../d0/d1a/structm0__conf__cache.html#a49441eccb5ff2dec5714967be927078f">m0_conf_cache::ca_registry</a>) is not expected to be queried frequently. It makes sense to base its implementation on linked list data structure.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="conf-fspec"></a>
Functional Specification</h1>
<ul>
<li><a class="el" href="../../d9/d5d/conf-fspec-obj.html">Configuration Objects</a></li>
<li><a class="el" href="../../dc/d31/confc-fspec.html">Configuration Client (confc)</a></li>
<li><a class="el" href="../../d1/dfb/conf-fspec-cache.html">Configuration Cache</a></li>
<li><a class="el" href="../../db/d23/conf-fspec-preload.html">Pre-Loading of Configuration Cache</a></li>
<li><a class="el" href="../../d3/d18/conf-fspec-objops.html">Configuration Object Operations</a></li>
<li><a class="el" href="../../d4/d41/confd-fspec.html">Configuration Service (confd)</a></li>
<li><a class="el" href="../../dd/d2e/rconfc-fspec.html">Redundant Configuration Client (rconfc)</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="conf-lspec"></a>
Logical Specification</h1>
<ul>
<li><a class="el" href="../../d2/dd9/conf.html#conf-lspec-comps">Components Overview</a></li>
<li><a class="el" href="../../d1/d89/confc-lspec.html">confc Internals</a></li>
<li><a class="el" href="../../dd/d7b/group__conf__dlspec__objops.html">Configuration Object Operations (lspec)</a></li>
<li><a class="el" href="../../d2/dd9/group__conf__dlspec__cache.html">Configuration Cache (lspec)</a></li>
<li><a class="el" href="../../d5/d8f/rconfc-lspec.html">rconfc Internals</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html">confd Internals</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d2/dd9/conf.html#conf-lspec-thread">Threading and Concurrency Model</a></li>
</ul>
<h2><a class="anchor" id="conf-lspec-comps"></a>
Components Overview</h2>
<p>Confc and confd maintain independent in-memory <a class="el" href="../../d1/dfb/conf-fspec-cache.html">caches</a> of configuration data.</p>
<p>Configuration cache can be <a class="el" href="../../db/d23/conf-fspec-preload.html">pre-loaded</a> from an ASCII string.</p>
<p>If a confc cache does not have enough data to fulfill a request of configuration consumer, confc obtains the necessary data from the confd and adds new configuration data to the cache.</p>
<p>If a confd cache does not have enough data to fulfill a request of confc, confd loads the necessary data from the configuration database and updates the cache.</p>
<h2><a class="anchor" id="conf-lspec-state"></a>
State Specification</h2>
<ul>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-state">States of a context state machine at confc side</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-lspec-state">States of a FOM at confd side</a></li>
<li><a class="el" href="../../d9/d5d/conf-fspec-obj.html#conf-fspec-obj-enum-status">Configuration Object Status</a></li>
<li><a class="el" href="../../d9/d5d/conf-fspec-obj.html#conf-fspec-obj-pinned">Pinned Objects</a></li>
</ul>
<h2><a class="anchor" id="conf-lspec-thread"></a>
Threading and Concurrency Model</h2>
<ul>
<li><a class="el" href="../../d1/d89/confc-lspec.html#confc-lspec-thread">confc</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-lspec-thread">confd</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="conf-conformance"></a>
Conformance</h1>
<ul>
<li><b>i.conf.confc.kernel</b> The implementation of confc uses portable subset of Motr core API, which abstracts away the differences between kernel and user-space code.</li>
<li><b>i.conf.confc.user</b> Confc library is implemented for user space.</li>
<li><b>i.conf.confc.async</b> <a class="el" href="../../d0/dca/group__confc__dfspec.html#gae637e650b3c0655bae3f22b876fd27e8">m0_confc_open()</a> and <a class="el" href="../../d5/d25/group__confc__dlspec.html#gac29f7f13b3453fbf03379a823a4307c3">m0_confc_readdir()</a> are asynchronous calls.</li>
<li><b>i.conf.cache.data-model</b> Configuration information is organized as outlined in section 4.1 of the HLD. One-to-many relationships are represented by <a class="el" href="../../d6/d1b/structm0__conf__dir.html">m0_conf_dir</a> objects. The same data structures are used for both confc and confd. Configuration structures are kept in memory.</li>
<li><b>i.conf.cache.pinning</b> Confc "pins" configuration object by incrementing its reference counter. <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga246f8e1e88c76a3045fa0762fd5712ed">m0_confc_fini()</a> asserts (<a class="el" href="../../dc/da7/assert_8h.html#a1c063bd08f7e1ab3a6e6008ef825d471">M0_PRE()</a>) that no objects are pinned when the cache is being destroyed.</li>
<li><b>i.conf.cache.unique-objects</b> Uniqueness of configuration object identities is achieved by using a registry of cached objects (<a class="el" href="../../d0/d1a/structm0__conf__cache.html#a49441eccb5ff2dec5714967be927078f">m0_conf_cache::ca_registry</a>).</li>
</ul>
<hr/>
 <h1><a class="anchor" id="conf-ut"></a>
Unit Tests</h1>
<p>Fault Injection mechanism (<a class="el" href="../../dd/dc9/finject_8h.html">lib/finject.h</a>) will be used to test handling of "rare" errors (e.g., allocation errors) and to disable some of external modules' functionality (e.g., to make <a class="el" href="../../db/de9/group__rpc.html#gab6406484e4b73d1c6a270d88083b7fc9">m0_rpc_post()</a> a noop).</p>
<h2><a class="anchor" id="conf-ut-common"></a>
Infrastructure Test Suite</h2>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000005">Test:</a></b></dt><dd><a class="el" href="../../d0/d1a/structm0__conf__cache.html">m0_conf_cache</a> operations will be tested.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000006">Test:</a></b></dt><dd>Path operations will be tested. This includes checking validity of various paths.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000007">Test:</a></b></dt><dd>Object operations will be tested. This includes allocation, comparison with on-wire representation, stub enrichment.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000008">Test:</a></b></dt><dd><a class="el" href="../../d0/dc4/group__conf__dfspec__preload.html#ga34d41b04f28f54ce9ef01deb6c2e06ea">m0_confstr_parse()</a> will be tested.</dd></dl>
<h2><a class="anchor" id="conf-ut-confc"></a>
confc Test Suite</h2>
<pre class="fragment">Test suite's init routine will create an "ast" thread (search
for `ast_thread' in sm/ut/sm.c).  This thread will process ASTs
as they are posted by confc functions.
</pre><dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000009">Test:</a></b></dt><dd><a class="el" href="../../d5/d25/group__confc__dlspec.html#gaf74d5792e5a5d800e9d5e6d7fcfa61b0">path_walk()</a> will be tested.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000010">Test:</a></b></dt><dd>m0_confc_open*() and <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga899a22f1dafd4ffbb22f6d72e1590ddc">m0_confc_close()</a> will be tested.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000011">Test:</a></b></dt><dd>Cache operations will be tested. This includes cache_add(), <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga9a5d8b8b68c9ea4dd0aa2e50e89f91f6">object_enrich()</a>, <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga4a0aea81b8374bdd06bdf0f8f7d529a1">cache_grow()</a>, and cache_preload().</dd></dl>
<hr/>
 <h1><a class="anchor" id="conf-scalability"></a>
Scalability</h1>
<p>Current design imposes no restrictions on the size of configuration cache. If a configuration database is huge and the application is keen to know every aspect of cluster configuration, confc cache may eventually consume all available memory. Confc will be unable to allocate new objects, its state machines will end in S_FAILURE state, and <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga3345102f46c980aef89a53a342ace13a">m0_confc_ctx_error()</a> will return -ENOMEM. The application may opt to get rid of configuration cache by issuing <a class="el" href="../../d5/d25/group__confc__dlspec.html#ga246f8e1e88c76a3045fa0762fd5712ed">m0_confc_fini()</a>.</p>
<p>XXX</p><dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000055">Todo:</a></b></dt><dd>Implement cache eviction.</dd></dl>
<hr/>
 <h1><a class="anchor" id="conf-ref"></a>
References</h1>
<p>For documentation links, please refer to this file : doc/motr-design-doc-list.rst</p><ul>
<li>HLD of configuration caching</li>
<li>HLD of configuration.schema</li>
<li>Configuration one-pager </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li>
    <li class="footer">Generated on Fri May 20 2022 10:35:30 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
