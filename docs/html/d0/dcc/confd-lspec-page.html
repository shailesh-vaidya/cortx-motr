<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: confd Internals</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d0/dcc/confd-lspec-page.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">confd Internals </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>XXX FIXME: confd documentation is outdated.</p>
<ul>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-depends">Dependencies</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-highlights">Design Highlights</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-lspec">Logical Specification</a><ul>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-lspec-long-lock">Locking model</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-lspec-numa">NUMA Optimizations</a></li>
</ul>
</li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-conformance">Conformance</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-ut">Unit Tests</a></li>
<li><a class="el" href="../../d0/dcc/confd-lspec-page.html#confd-O">Analysis</a></li>
<li><a class="el" href="../../d2/d01/group__confd__dlspec.html">Detailed Logical Specification</a></li>
</ul>
<h1><a class="anchor" id="confd-depends"></a>
Dependencies</h1>
<p>Confd depends on the following subsystems:</p><ul>
<li><a class="el" href="../../d1/d84/group__rpc__service.html">RPC service</a></li>
<li>db <br />
- <a class="el" href="../../d1/d59/group__fom.html">Fop state Machine</a></li>
<li><a class="el" href="../../d6/d39/group__fop.html">File operation packet</a></li>
<li><a class="el" href="../../d5/d8c/group__reqh.html">Request handler</a></li>
<li><a class="el" href="../../df/dca/group__m0d.html">Motr Setup</a></li>
<li><a class="el" href="../../da/ddc/group__reqhservice.html#gabb668cfa383c0168dd893af4fa2e0507">m0_reqh_service_type_register()</a> <br />
- <a class="el" href="../../da/ddc/group__reqhservice.html#ga8ed269a2d1bcb91be82f83a83de3f451">m0_reqh_service_type_unregister()</a></li>
<li><a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html">FOM long lock API</a></li>
</ul>
<p>Most important functions, confd depends on, are listed above:</p><ul>
<li>RPC layer:<ul>
<li><a class="el" href="../../db/de9/group__rpc.html#gacbfe74a884f1912395ef2a9bde8ad927">m0_rpc_reply_post()</a> used to send FOP-based reply to Confc;</li>
</ul>
</li>
<li>DB layer:<ul>
<li>m0_db_pair_setup() and m0_table_lookup() used to access configuration values stored in db.</li>
</ul>
</li>
<li>FOP, FOM, REQH:<ul>
<li>m0_fom_block_at();</li>
<li><a class="el" href="../../d1/d59/group__fom.html#ga2329efad9db4fff88bf3ff8570b8524d">m0_fom_block_leave()</a>;</li>
<li><a class="el" href="../../d1/d59/group__fom.html#ga743737aa6426c5610be5b3be98e81777">m0_fom_block_enter()</a>;</li>
<li><a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#ga32c86cc142a302f4b5a976bb66dbeb40">m0_long_read_lock()</a>;</li>
<li><a class="el" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#gafb962350d0560706a0944a515360c54f">m0_long_write_lock()</a>.</li>
</ul>
</li>
<li>Motr setup:<ul>
<li><a class="el" href="../../df/dca/group__m0d.html#ga1f6035a94a88b54e30c5ee54e133adc9">m0_cs_setup_env()</a> configures Motr to use confd's environment.</li>
</ul>
</li>
</ul>
<hr/>
 <h1><a class="anchor" id="confd-highlights"></a>
Design Highlights</h1>
<ul>
<li>User-space implementation.</li>
<li>Provides a "FOP-based" interface for confc to access configuration information.</li>
<li>Relies on request handler threading model and is driven by reqh. Request processing is based on FOM execution.</li>
<li>Maintains its own configuration cache, implementation of which is common to confd and confc.</li>
<li>Several confd state machines (FOMs) processing requests from configuration consumers can work with configuration cache concurrently.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="confd-lspec"></a>
Logical Specification</h1>
<p>Confd service initialization is performed by request handler. To allocate Confd service and its internal structures in memory m0_confd_service_locate() is used.</p>
<p>Confd service type is registered in &lsquo;subsystem&rsquo; data structure of "motr/init.c", the following lines are added: </p><div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="../../de/d21/structinit__fini__call.html">init_fini_call</a> <a class="code" href="../../d9/d54/group__init.html#ga9b938fbbe99ce05908643c16697f192d">subsystem</a>[] = {</div><div class="line">     ...</div><div class="line">     { &amp;<a class="code" href="../../d2/d01/group__confd__dlspec.html#ga06d5da2fc0ed814df3702fb3cbb13d96">m0_confd_register</a>, &amp;<a class="code" href="../../d2/d01/group__confd__dlspec.html#ga8fbf6d092080d9623f2511368f34554d">m0_confd_unregister</a>, <span class="stringliteral">&quot;confd&quot;</span> },</div><div class="line">     ...</div><div class="line">};</div></div><!-- fragment --><p>Configuration cache pre-loading procedure traverses all tables of configuration db. Since relations between neighbour levels only are possible, tables of higher "levels of DAG" are processed first. The following code example presents pre-loading in details:</p>
<div class="fragment"><div class="line">conf_cache_preload (...)</div><div class="line">{</div><div class="line">   <span class="keywordflow">for each</span> <a class="code" href="../../d1/dc6/namespacerecord.html">record</a> in the <span class="stringliteral">&quot;profiles&quot;</span> table <span class="keywordflow">do</span></div><div class="line">     ... allocate and fill <span class="keyword">struct </span><a class="code" href="../../d6/d2f/structm0__conf__profile.html">m0_conf_profile</a> from p_prof</div><div class="line">   endfor</div><div class="line"></div><div class="line">   for table in &quot;file_systems&quot;, &quot;services&quot;,</div><div class="line">             &quot;<a class="code" href="../../dc/daf/ut_2commands_8c.html#ac08180555c1e3b71215608e0f28f768b">nodes</a>&quot;, &quot;nics&quot;, &quot;storage_devices&quot;,</div><div class="line">             in the order specified, do</div><div class="line">      for each <a class="code" href="../../d1/dc6/namespacerecord.html">record</a> in the table, do</div><div class="line">        ... allocate and fill struct <a class="code" href="../../df/da6/structm0__conf__obj.html">m0_conf_obj</a> ...</div><div class="line">        ... <a class="code" href="../../d4/d44/group__cas.html#gad8b4f23dd455dd49c06ff67933b2b18d">create</a> DAG struct m0_conf_relation to appropriate <a class="code" href="../../d5/d89/namespaceconf.html">conf</a> <a class="code" href="../../dc/dd8/classobject.html">object</a> ...</div><div class="line">      endfor</div><div class="line">   end for</div><div class="line">}</div></div><!-- fragment --><p>FOP operation vector, FOP type, and RPC item type have to be defined for each FOP. The following structures are defined for <a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a> FOP:</p>
<ul>
<li>struct <a class="el" href="../../d5/d9d/structm0__fop__type.html">m0_fop_type</a> m0_conf_fetch_fopt &mdash; defines FOP type;</li>
<li>struct <a class="el" href="../../db/d44/structm0__fop__type__ops.html">m0_fop_type_ops</a> m0_conf_fetch_ops &mdash; defines FOP operation vector;</li>
<li>struct <a class="el" href="../../d9/d16/structm0__rpc__item__type.html">m0_rpc_item_type</a> m0_rpc_item_type_fetch &mdash; defines RPC item type.</li>
</ul>
<p>m0_fom_fetch_state() - called by reqh to handle incoming confc requests. Implementation of this function processes all FOP-FOM specific and <a class="el" href="../../de/d40/structm0__conf__fetch__resp.html">m0_conf_fetch_resp</a> phases: </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> m0_fom_fetch_state(<span class="keyword">struct</span> <a class="code" href="../../d9/db7/structm0__fom.html">m0_fom</a> *<a class="code" href="../../d7/d59/structfom.html">fom</a>)</div><div class="line"> {</div><div class="line">      checks <span class="keywordflow">if</span> FOM should <a class="code" href="../../d0/d5d/ut_2sm_8c.html#a35597c6cd4065327ff15e683361b7870">transition</a> into a <span class="keyword">generic</span>/standard</div><div class="line">      phase or FOP specific phase.</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="../../d7/d59/structfom.html">fom</a>-&gt;fo_phase &lt; FOPH_NR) {</div><div class="line">              result = m0_fom_state_generic(<a class="code" href="../../d7/d59/structfom.html">fom</a>);</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">             ... process <a class="code" href="../../de/d40/structm0__conf__fetch__resp.html">m0_conf_fetch_resp</a> phase transitions ...</div><div class="line">      }</div><div class="line"> }</div></div><!-- fragment --><p>Request handler triggers user-defined functions to create FOMs for processed FOPs. Service has to register FOM-initialization functions for each FOP treated as a request:</p><ul>
<li><a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a>;</li>
<li><a class="el" href="../../d1/d24/structm0__conf__update.html">m0_conf_update</a>;</li>
</ul>
<p>To do so, the appropriate structures and functions have to be defined. For example the following used by <a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a> FOP:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d5/ded/structm0__fom__type__ops.html">m0_fom_type_ops</a> fom_fetch_type_ops = {</div><div class="line">      .<a class="code" href="../../d5/ded/structm0__fom__type__ops.html#a562cef83fad1fc4b71796beafd7002df">fto_create</a> = fetch_fom_create</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d9/d79/structm0__fom__type.html">m0_fom_type</a> m0_fom_fetch_mopt = {</div><div class="line">      .<a class="code" href="../../d9/d79/structm0__fom__type.html#a99a33592cf3d27976a7460e7a3e1d0f6">ft_ops</a> = &amp;fom_fetch_type_ops</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> fetch_fom_create(<span class="keyword">struct</span> <a class="code" href="../../d5/d01/structm0__fop.html">m0_fop</a> *<a class="code" href="../../d9/dbf/ut_2item_8c.html#aa6954df11aaf0bcf90cf350315b8c544">fop</a>, <span class="keyword">struct</span> <a class="code" href="../../d9/db7/structm0__fom.html">m0_fom</a> **<a class="code" href="../../d6/d7d/ut_2consumer_8c.html#a68d1e4577870933f97f6909f74b31e29">m</a>,</div><div class="line">                            <span class="keyword">struct</span> <a class="code" href="../../d9/da2/structm0__reqh.html">m0_reqh</a> *<a class="code" href="../../dd/d39/ut_2rm__foms_8c.html#a3df63fafaec040933607559fa17cecea">reqh</a>)</div><div class="line">{</div><div class="line">   1) allocate <a class="code" href="../../d7/d59/structfom.html">fom</a>;</div><div class="line">   2) <a class="code" href="../../d1/d59/group__fom.html#gaa8d2269a41daa6b2913cf8b18eefbfcc">m0_fom_init</a>(<a class="code" href="../../d7/d59/structfom.html">fom</a>, &amp;m0_fom_ping_mopt, &amp;fom_fetch_type_ops,</div><div class="line">                  <a class="code" href="../../d9/dbf/ut_2item_8c.html#aa6954df11aaf0bcf90cf350315b8c544">fop</a>, <a class="code" href="../../db/df8/lib_2user__space_2misc_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dd/d39/ut_2rm__foms_8c.html#a3df63fafaec040933607559fa17cecea">reqh</a>);</div><div class="line">   3) *<a class="code" href="../../d6/d7d/ut_2consumer_8c.html#a68d1e4577870933f97f6909f74b31e29">m</a> = <a class="code" href="../../d7/d59/structfom.html">fom</a>;</div><div class="line">}</div></div><!-- fragment --><p>The implementation of m0_fom_fetch_state() needs the following functions to be defined:</p>
<ul>
<li>fetch_check_request(), update_check_request() - check incoming request and validates requested path of configuration objects.</li>
<li>fetch_next_state(), update_next_state() - transit FOM phases depending on the current phase and on the state of configuration objects.</li>
<li>obj_serialize() - serializes given object to FOP.</li>
<li>fetch_failure_handle(), update_failure_handle() - handle occurred errors.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="confd-lspec-state"></a>
State Specification</h1>
<p>Confd as a whole is not a state machine, phase processing is implemented on basis of FOM of <a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a>, <a class="el" href="../../d1/d24/structm0__conf__update.html">m0_conf_update</a> FOPs. After corresponding FOM went through a list of FOM specific phases it transited into F_INITIAL phase.</p>
<p>The number of state machine instances correspond to the number of FOPs being processed in confd.</p>
<p><a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a> FOM state transition diagram: </p><div class="dotgraph">
<img src="../../dot_inline_dotgraph_8.png" alt="dot_inline_dotgraph_8.png" border="0" usemap="#dot_inline_dotgraph_8.map"/>
<map name="dot_inline_dotgraph_8.map" id="dot_inline_dotgraph_8.map"></map>
</div>
<ul>
<li>F_INITIAL In this phase, incoming FOM/FOP-related structures are being initialized and FOP-processing preconditions are being checked. Then, an attempt is made to obtain a read lock m0_confd::d_cache::ca_rwlock. When it's obtained then <a class="el" href="../../dd/dc5/structm0__long__lock.html">m0_long_lock</a> logic transits FOM back into F_SERIALISE.</li>
<li>F_SERIALISE: Current design assumes that data is pre-loaded into configuration cache. In F_SERIALISE phase, m0_confd::d_cache::ca_rwlock lock has been already obtained as a read lock. <a class="el" href="../../de/d40/structm0__conf__fetch__resp.html">m0_conf_fetch_resp</a> FOP is being prepared for sending by looking up requested path in configuration cache and unlocking m0_confd::d_cache::ca_rwlock. After that, <a class="el" href="../../de/d40/structm0__conf__fetch__resp.html">m0_conf_fetch_resp</a> FOP is sent with <a class="el" href="../../db/de9/group__rpc.html#gacbfe74a884f1912395ef2a9bde8ad927">m0_rpc_reply_post()</a>. fetch_next_state() transits FOM into F_TERMINATE. If incoming request consists of a path which is not in configuration cache, then the <a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a> FOM is transitioned to the F_FAILURE phase.</li>
<li>F_TERMINATE: In this phase, statistics values are being updated in m0_confd::d_stat. m0_confd::d_cache::ca_rwlock has to be unlocked.</li>
<li><p class="startli">F_FAILURE: In this phase, statistics values are being updated in m0_confd::d_stat. <a class="el" href="../../de/d40/structm0__conf__fetch__resp.html">m0_conf_fetch_resp</a> FOP with an empty configuration objects sequence and negative error code is sent with <a class="el" href="../../db/de9/group__rpc.html#gacbfe74a884f1912395ef2a9bde8ad927">m0_rpc_reply_post()</a>. m0_confd::d_cache::ca_rwlock has to be unlocked.</p>
<dl class="section note"><dt>Note</dt><dd>m0_conf_stat FOM has a similar state diagram as <a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a> FOM does and hence is not illustrated here.</dd></dl>
<p><a class="el" href="../../d1/d24/structm0__conf__update.html">m0_conf_update</a> FOM state transition diagram: </p><div class="dotgraph">
<img src="../../dot_inline_dotgraph_9.png" alt="dot_inline_dotgraph_9.png" border="0" usemap="#dot_inline_dotgraph_9.map"/>
<map name="dot_inline_dotgraph_9.map" id="dot_inline_dotgraph_9.map"></map>
</div>
</li>
<li>U_INITIAL: In this phase, incoming FOM/FOP-related structures are being initialized and FOP-processing preconditions are being checked. Then, an attempt is made to obtain a write lock m0_confd::d_cache::ca_rwlock. When it's obtained then <a class="el" href="../../dd/dc5/structm0__long__lock.html">m0_long_lock</a> logic transits FOM back into U_UPDATE.</li>
<li>U_UPDATE: In current phase, m0_confd::d_cache::ca_rwlock lock has been already obtained as a write lock. Then, configuration cache has to be updated and m0_confd::d_cache::ca_rwlock lock should be unlocked. After that, <a class="el" href="../../d0/d23/structm0__conf__update__resp.html">m0_conf_update_resp</a> FOP is sent with <a class="el" href="../../db/de9/group__rpc.html#gacbfe74a884f1912395ef2a9bde8ad927">m0_rpc_reply_post()</a>. update_next_state() transits FOM into U_TERMINATE. If incoming request consists of a path which is not in configuration cache than the <a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a> FOM is transitioned to the U_FAILURE phase</li>
<li>U_TERMINATE: In this phase, statistics values are being updated in m0_confd::d_stat. m0_confd::d_cache::ca_rwlock has to be unlocked.</li>
<li>U_FAILURE: In this phase, statistics values are being updated in m0_confd::d_stat. <a class="el" href="../../d0/d23/structm0__conf__update__resp.html">m0_conf_update_resp</a> FOP with an empty configuration objects sequence and negative error code is sent with <a class="el" href="../../db/de9/group__rpc.html#gacbfe74a884f1912395ef2a9bde8ad927">m0_rpc_reply_post()</a>. m0_confd::d_cache::ca_rwlock has to be unlocked.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="confd-lspec-long-lock"></a>
Locking model</h1>
<p>Confd relies on a locking primitive integrated with FOM signaling mechanism. The following interfaces are used:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> m0_long_{read,write}_lock(<span class="keyword">struct</span> m0_longlock *<a class="code" href="../../d2/d66/group__dtm.html#ga2a86bbc40fcee6c3db38e5a56bf5acf8">lock</a>,</div><div class="line">                               <span class="keyword">struct</span> <a class="code" href="../../d9/db7/structm0__fom.html">m0_fom</a> *<a class="code" href="../../d7/d59/structfom.html">fom</a>, <span class="keywordtype">int</span> next_phase);</div><div class="line"><span class="keywordtype">void</span> m0_long_{read,write}_unlock(<span class="keyword">struct</span> m0_longlock *<a class="code" href="../../d2/d66/group__dtm.html#ga2a86bbc40fcee6c3db38e5a56bf5acf8">lock</a>);</div><div class="line"><span class="keywordtype">bool</span> m0_long_is_{read,write}_locked(<span class="keyword">struct</span> m0_longlock *<a class="code" href="../../d2/d66/group__dtm.html#ga2a86bbc40fcee6c3db38e5a56bf5acf8">lock</a>);</div></div><!-- fragment --><p>m0_long_{read,write}_lock() returns true iff the lock is obtained. If the lock is not obtained (i.e. the return value is false), the subroutine would have arranged to awaken the FOM at the appropriate time to retry the acquisition of the lock. It is expected that the invoker will return M0_FSO_AGAIN from the state function in this case.</p>
<p>m0_long_is_{read,write}_locked() returns true iff the lock has been obtained.</p>
<p>The following code example shows how to perform a transition from F_INITIAL to F_SERIALISE and obtain a lock: </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> fom_fetch_state(<span class="keyword">struct</span> <a class="code" href="../../d9/db7/structm0__fom.html">m0_fom</a> *<a class="code" href="../../d7/d59/structfom.html">fom</a>)</div><div class="line">{</div><div class="line">     <span class="comment">//...</span></div><div class="line">     <span class="keyword">struct </span><a class="code" href="../../df/d87/structm0__long__lock__link.html">m0_long_lock_link</a> *link;</div><div class="line">     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d59/structfom.html">fom</a>-&gt;fo_phase == F_INITIAL) {</div><div class="line">             <span class="comment">// Initialise things.</span></div><div class="line">             <span class="comment">// ...</span></div><div class="line">             <span class="comment">// Retreive long lock link from derived FOM object: link = ...;</span></div><div class="line">             <span class="comment">// and acquire the lock</span></div><div class="line">             <span class="keywordflow">return</span> <a class="code" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#gac7dcfcd902e681ec0766463721434d4f">M0_FOM_LONG_LOCK_RETURN</a>(<a class="code" href="../../dd/d2e/group__m0__long__lock___a_p_i.html#ga32c86cc142a302f4b5a976bb66dbeb40">m0_long_read_lock</a>(<a class="code" href="../../d2/d66/group__dtm.html#ga2a86bbc40fcee6c3db38e5a56bf5acf8">lock</a>,</div><div class="line">                                                              link,</div><div class="line">                                                              F_SERIALISE));</div><div class="line">     }</div><div class="line">     <span class="comment">//...</span></div><div class="line">}</div></div><!-- fragment --> <dl class="section see"><dt>See also</dt><dd>fom-longlock</dd></dl>
<hr/>
 <h1><a class="anchor" id="confd-lspec-thread"></a>
Threading and Concurrency Model</h1>
<p>Confd creates no threads of its own but instead is driven by the request handler. All threading and concurrency is being performed on the Request Handler side, registered in the system. Incoming FOPs handling, phase transitions, outgoing FOPs serialization, error handling is done in callbacks called by reqh-component.</p>
<p>Configuration service relies on rehq component threading model and should not acquire any locks or be in any waiting states, except listed below. Request processing should be performed in an asynchronous-like manner. Only synchronous calls to configuration DB are allowed which should be bracketed with m0_fom_block_{enter,leave}().</p>
<p>Multiple concurrently executing FOMs share the same configuration cache and db environment of confd, so access to them is synchronized with the specialized m0_longlock read/write lock designed for use in FOMs: the FOM does not busy-wait, but gets blocked until lock acquisition can be retried. Simplistic synchronization of the database and in-memory cache through means of this read/writer lock (m0_confd::d_lock) is sufficient, as the workload of confd is predominantly read-only.</p>
<h2><a class="anchor" id="confd-lspec-numa"></a>
NUMA Optimizations</h2>
<p>Multiple confd instances can run in the system, but no more than one per request handler. Each confd has its own data-base back-end and its own pre-loaded copy of data-base in memory.</p>
<hr/>
 <h1><a class="anchor" id="confd-conformance"></a>
Conformance</h1>
<ul>
<li><b>i.conf.confd.user</b> Confd is implemented in user space.</li>
<li><b>i.conf.cache.data-model</b> Configuration information is organized as outlined in section 4.1 of the HLD. The same data structures are used for confc and confd. Configuration structures are kept in memory.</li>
<li><b>i.conf.cache.unique-objects</b> A registry of cached objects (<a class="el" href="../../d0/d1a/structm0__conf__cache.html#a49441eccb5ff2dec5714967be927078f">m0_conf_cache::ca_registry</a>) is used to achieve uniqueness of configuration object identities.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="confd-ut"></a>
Unit Tests</h1>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000001">Test:</a></b></dt><dd><p class="startdd">obj_serialize() will be tested. </p>
<p class="enddd">{fetch,update}_next_state() will be tested.</p>
</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000002">Test:</a></b></dt><dd>Load predefined configuration object from configuration db. Check its predefined value.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000003">Test:</a></b></dt><dd>Load predefined configuration directory from db. Check theirs predefined values.</dd></dl>
<dl class="test"><dt><b><a class="el" href="../../d4/df6/test.html#_test000004">Test:</a></b></dt><dd>Fetch non-existent configuration object from configuration db.</dd></dl>
<hr/>
 <h1><a class="anchor" id="confd-O"></a>
Analysis</h1>
<p>Size of configuration cache, can be evaluated according to a number of configuration objects in configuration db and is proportional to the size of the database file</p>
<p>Configuration request FOP (<a class="el" href="../../df/d50/structm0__conf__fetch.html">m0_conf_fetch</a>) is executed in approximately constant time (measured in disk I/O) because the entire configuration db is cached in-memory and rarely would be blocked by an update.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d2/d01/group__confd__dlspec.html">confd Internals</a> </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li><li class="navelem"><a class="el" href="../../d2/dd9/conf.html">DLD of configuration caching</a></li>
    <li class="footer">Generated on Fri May 20 2022 10:35:29 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
