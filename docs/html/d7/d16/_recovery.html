<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: DLD</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d7/d16/_recovery.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">DLD </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../d7/d16/_recovery.html#recovery-ovw">Recovery overview</a></li>
<li><a class="el" href="../../d7/d16/_recovery.html#recovery-def">Definitions</a></li>
<li><a class="el" href="../../d7/d16/_recovery.html#recovery-req">Requirements</a></li>
<li><a class="el" href="../../d7/d16/_recovery.html#recovery-depends">Dependencies</a></li>
<li><a class="el" href="../../d2/d9d/recovery-fspec.html">Functional Specification</a></li>
<li><a class="el" href="../../d7/d16/_recovery.html#recovery-lspec">Logical Specification</a></li>
</ul>
<p>- <a class="el" href="../../d7/d16/_recovery.html#recovery-lspec-comps">Component Overview</a></p>
<hr/>
 <h1><a class="anchor" id="recovery-ovw"></a>
Recovery overview</h1>
<p>BE allows users to modify segments in transactional way. A segment is backed with a linux stob, which doesn't provide atomic writes. BE should have consistent segments even after crash. Therefore BE should have a part that can recover BE segments data after crash. This part is called recovery.</p>
<h1><a class="anchor" id="recovery-def"></a>
Definitions</h1>
<ul>
<li><b>Recovery</b> is process of consistency reconstruction of segments, which current BE domain contains of.</li>
<li><b>Log</b> is persistent storage where transactions are written before they are placed to segment.</li>
<li><b>Valid group</b> is a transaction group that is fully logged and contains complete commit block with proper magic and checksum.</li>
<li><b>Log-only group</b> is group that was completely logged but it's not known if it was placed.</li>
<li><b>Dirty bit</b> is a flag that indicates whether BE was shut down correctly or not during previous run.</li>
</ul>
<h1><a class="anchor" id="recovery-req"></a>
Requirements</h1>
<ul>
<li>On successful recovery completion segments have to contain only complete and not partial transactions.</li>
<li>Recovery shouldn't take long after normal shutdown;</li>
<li>Recovery time is not important (yet);</li>
<li>Log is stored on persistent storage with random access.</li>
</ul>
<p>Recovery should be started and succeed after:</p><ul>
<li>Power loss;</li>
<li>m0d crash:<ul>
<li>OOM m0d kill;</li>
<li>SIGSEGV or other signal.</li>
</ul>
</li>
<li>Recovery should succeed if some of the above failures happen during recovery.</li>
</ul>
<p>Recovery may fail after:</p><ul>
<li>Memory corruption;</li>
<li>Segment or log corruption;</li>
<li>I/O error in segment or log;</li>
</ul>
<h1><a class="anchor" id="recovery-depends"></a>
Dependencies</h1>
<p>Recovery depends on these BE components:</p><ul>
<li>log;</li>
<li>engine;</li>
<li>tx_group;</li>
<li>seg0.</li>
</ul>
<h1><a class="anchor" id="recovery-lspec"></a>
Logical Specification</h1>
<ul>
<li><a class="el" href="../../d7/d16/_recovery.html#recovery-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d7/d16/_recovery.html#recovery-lspec-sub">Component Subroutines</a></li>
</ul>
<h2><a class="anchor" id="recovery-lspec-comps"></a>
Component Overview</h2>
<p>The following BE subsystems are involved into recovery process, so they have to be updated according to the list:</p><ul>
<li><b>Engine</b> starts recovery process inside m0_be_domain_start(). Recovery process is started every time engine starts. It analyses special bits inside seg0 and starts re-applying groups of transactions stored in Log to make filesystem stored in be segments consistent.</li>
<li><b>Log</b> stores groups of transactions in order to perform durability of BE storage. For recovery process, it has to provide interface or functions for efficient iteration of the groups stored inside. Algorithm has to iterate groups from last placed to last logged.</li>
<li><b>Seg0</b> is a storage of metadata related to the filesystem. Recovery needs to store inside seg0 special bit, analysing which it makes a decision to start log scanning and groups re-applying. These bit (dirty bit) have to be set or cleared with a special (non-transactional) procedure and it can be stored in struct <a class="el" href="../../da/dec/structm0__be__seg__hdr.html">m0_be_seg_hdr</a> nearby the start of the segment. In future, some redundancy can be added: dirty bit can be stored in different places of the segment.</li>
<li><b>Recovery</b> encapsulates a set of algorithms and data structures and formats which are needed to make data stored inside BE segments consistent during failures.</li>
<li>From recovery point of view <b>PageD</b> are special interfaces which have to be used to apply changes to in-memory representation of the segments. Using m0_be_reg_{get,put}() interface recovery loads the page, where data corresponding to the scanned group region area lives to apply changes to the region.</li>
</ul>
<h2><a class="anchor" id="recovery-lspec-sub"></a>
Component Subroutines</h2>
<p><b>Scanning algorithm which finds last logged group and last placed group</b> Log header contains pointer to a valid logged group. Scanning algorithm begins from the pointed group. Groups are scanned in both forward and backward directions. Lsn must follow with increasing order, therefore scanning algorithm repeats while lsn is increased for the forward scanning and while lsn is decreased for backward scanning respectively. Last logged group must be the last handled group during the forward scanning. It contains pointer to last placed group.</p>
<p>Backward scanning is stopped if the following condition is met: lsn of the current group is less than lsn of the last placed group.</p>
<p>Note: BE log operates with a log record that is representation of transactional group in the log.</p>
<p><b>Iterative interface for looking over groups that need to be re-applied</b> Recovery provides interface for pick next group for re-applying. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri May 20 2022 10:35:29 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
