<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: I/O with SNS and SNS repair.</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d5/d61/iosnsrepair.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">I/O with SNS and SNS repair. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-ovw">Overview</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-def">Definitions</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-req">Requirements</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-depends">Dependencies</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-highlights">Design Highlights</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-lspec">Logical Specification</a><ul>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-lspec-numa">NUMA optimizations</a></li>
</ul>
</li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-conformance">Conformance</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-ut">Unit Tests</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-st">System Tests</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-O">Analysis</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-ref">References</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-impl-plan">Implementation Plan</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-ovw"></a>
Overview</h1>
<dl class="section note"><dt>Note</dt><dd>This DLD is written by Huang Hua (<a href="#" onclick="location.href='mai'+'lto:'+'hua'+'.h'+'uan'+'g@'+'sea'+'ga'+'te.'+'co'+'m'; return false;">hua.h<span style="display: none;">.nosp@m.</span>uang<span style="display: none;">.nosp@m.</span>@seag<span style="display: none;">.nosp@m.</span>ate.<span style="display: none;">.nosp@m.</span>com</a>), 2012/10/10.</dd></dl>
<p>This DLD describes how the m0t1fs does I/O with SNS in normal condition, in de-graded mode, and when SNS repair is completed.</p>
<p>A file (also known as global object) in Motr is stored in multiple component objects, spreading on multiple servers. This is usually also called Server Network Striping, a.k.a SNS. Layout is used to describe the mapping of a file to its objects. A read request to some specific offset within a file will be directed to some parts of its component objects, according to its layout. A write request does the same. Some files don't store redundancy information in the file system, like RAID0. But in Motr, the default and typical mode is to have files with redundancy data stored somewhere. So the write requests may include updates to redundancy data.</p>
<p>In case of node or device failure, lost data may be re-constructed from redundancy information. A read request to lost data needs to be satisfied by re-constructing data from its parity data. When SNS repair is completed for the failed node or device, a read or write request can be served by re-directing to its spare unit.</p>
<p>Write requests to failed node or device should be handled in another way, cooperated with SNS repair and NBA (Non-Blocking Availability). Now it is out of the scope of this DLD.</p>
<p>Each client has a cache of Failure Vectors of a pool. With failure vector information, clients know whether to re-construct data from other data units and parity units, or read from spare units (which contains repaired data). The detailed will be discussed in the following logical specification.</p>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-def"></a>
Definitions</h1>
<p>Previously defined terms:</p><ul>
<li><b>layout</b> A mapping from Motr file (global object) to component objects. See <a class="el" href="../../da/da8/group__layout.html">Layouts.</a> for more details.</li>
<li><b>SNS</b> Server Network Striping. See SNS for more details.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-req"></a>
Requirements</h1>
<ul>
<li><b>R.iosnsrepair.read</b> Read request should be served in normal case, during SNS repair, and after SNS repair completes.</li>
<li><b>R.iosnsrepair.write</b> Write request should be served in normal case, and after SNS repair completes.</li>
<li><b>R.iosnsrepair.code</b> Code should be re-used and shared with other m0t1fs client features, especially the rmw feature.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-depends"></a>
Dependencies</h1>
<p>The feature depends on the following features:</p><ul>
<li>layout.</li>
<li>SNS and failure vector.</li>
</ul>
<p>The implementation of this feature may depend on the m0t1fs read-modify-write (rmw) feature, which is under development.</p>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-highlights"></a>
Design Highlights</h1>
<p>M0t1fs read-modify-write (rmw) feature has some similar concepts with this feature. The same code path will be used to serve both the features.</p>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-lspec"></a>
Logical Specification</h1>
<ul>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d5/d61/iosnsrepair.html#iosnsrepair-lspec-numa">NUMA optimizations</a></li>
</ul>
<h2><a class="anchor" id="iosnsrepair-lspec-comps"></a>
Component Overview</h2>
<p>When an I/O request (read, write, or other) comes to client, m0t1fs first checks its cached failure vector to see the status of pool nodes and devices. A read or write request will span some node(s) or device(s). If these node(s) or device(s) are ONLINE, this is the normal case. If some node or device is FAILED or REPAIRING or REPAIRED, it will change the state of a pool. When all nodes and devices are in ONLINE status, the pool is ONLINE. I/O requests are handled normally. If less than or equal failures happen than the pool is configured to sustain, the pool is DEGRADED. I/O requests will be handled with the help of parity information or spare units. If more failures happen than the pool is configured to sustain , the pool is in DUD state, where all I/O requests will fail with -EIO error. The pool states define how client IO is made, specifically whether writes use NBA and whether read and writes use degraded mode. The pool states can be calculated from the failure vector.</p>
<p>If the special action is taken to serve this request. The following table illustrate the actions: </p><pre class="fragment">                    Table 1   I/O request handling
</pre> <hr/>
 <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"></th><th class="markdownTableHeadNone">ONLINE  </th><th class="markdownTableHeadNone">read from the target device   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">OFFLINE  </td><td class="markdownTableBodyNone">same as FAILED   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">---------&mdash;  </td><td class="markdownTableBodyNone">----------------------------------------------------&mdash;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">read  </td><td class="markdownTableBodyNone">FAILED  </td><td class="markdownTableBodyNone">read from other data unit(s) and parity unit(s) and   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">REPAIRING  </td><td class="markdownTableBodyNone">re-construct the data. If NBA** exists, use new   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">layout to do reading if necessary.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">See more detail for this degraded read (1)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">---------&mdash;  </td><td class="markdownTableBodyNone">----------------------------------------------------&mdash;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">REPAIRED  </td><td class="markdownTableBodyNone">read from the repaired spare unit or use new layout   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">if NBA**   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">---&mdash;  </td><td class="markdownTableBodyNone">---------&mdash;  </td><td class="markdownTableBodyNone">----------------------------------------------------&mdash;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">ONLINE  </td><td class="markdownTableBodyNone">write to the target device   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">---------&mdash;  </td><td class="markdownTableBodyNone">----------------------------------------------------&mdash;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">OFFLINE  </td><td class="markdownTableBodyNone">same as FAILED   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">---------&mdash;  </td><td class="markdownTableBodyNone">----------------------------------------------------&mdash;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">write  </td><td class="markdownTableBodyNone">FAILED  </td><td class="markdownTableBodyNone">NBA** determines to use new layout or old layout   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">if old layout is used, this is called degraded   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">write. See more detail in the following (2)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">---------&mdash;  </td><td class="markdownTableBodyNone">----------------------------------------------------&mdash;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">REPAIRING  </td><td class="markdownTableBodyNone">Concurrent++ write I/O and sns repairing is out of   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">the scope of this DLD. Not supported currently.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">-ENOTSUP will be returned at this moment.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">This is  Concurrent r/w in SNS repair   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">---------&mdash;  </td><td class="markdownTableBodyNone">----------------------------------------------------&mdash;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">REPAIRED  </td><td class="markdownTableBodyNone">write to the repaired spare unit or new layout   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">if NBA**   </td></tr>
</table>
<p>-------------------------------------------------------------------------&mdash;| NBA** Non-Blocking Availability. When a device/node is not available for a write request, the system switches the file to use a new layout, and so the data is written to devices in new layout. By such means, the writing request will not be blocked waiting the device to be fixed, or SNS repair to be completed. Device/node becomes un-available when it is OFFLINE or FAILED. Concurrent++ This should be designed in other module.</p>
<p>A device never goes from repaired to online. When the re-balancing process that moves data from spare space to a new device completes, the <em>new</em> device goes from REBALANCING to ONLINE state. If the old device is ever "fixed" somehow, it becomes a new device in ONLINE state.</p>
<p>A degraded read request is handled with the following steps: (1) Calculate its parity group, find out related data units and parity units. This needs help from the file's layout. (2) Send read requests to necessary data units and/or parity units asynchronously. The read request itself is blocked and waiting for those replies. For a N+K+K (N data units, K parity units, K spare units) layout, N units of data or parity units are needed to re-compute the lost data. (3) When those read replies come, ASTs will be called to re-compute the data iteratively. Temporary result is stored in the buffer of the original read request. This async read request and its reply can be released (no cache at this moment). (4) When all read replies come back, and the data is finally re-computed, the original read request has its data, and can be returned to user.</p>
<p>A degraded write request is handled as the following: (1) Calculate its parity group, find out related data units and parity units. This needs help from the file's layout. (2) Prepare to async read data and/or parity units. (2.1) If this is a full-stripe write request, skip to step (4). (2.2) If write request only spans ONLINE devices, this is similar to a Read-Modify-Write (rmw), except a little difference: only async read the spanned data unit(s). Async read all spanned data units. (2.3) If write request spans FAILED/OFFLINE devices, async read all survival and un-spanned data units and necessary parity unit(s). (3) When these async read requests complete, replies come back to client. (3.1) for (2.2) case, prepare new parity units from the old data and new data. (3.2) for (2.3) case, first, re-calculate the lost data unit, and do the same as 3.1. (4) Send write request(s) to data units, along with all the new parity data, except the failed device(s). Please note here: write to the failed devices are excluded to send. (5) When those write requests complete, return to user space.</p>
<p>The same thread used by the rmw will be used here to run the ASTs. The basic algorithm is similar in these two features. No new data structures are introduced by this feature.</p>
<p>Pool's failure vector is cached on clients. Every I/O request to ioservices is tagged with client known failure vector version, and this version is checked against the lastest one by ioservices. If the client known version is stale, new version and failure vector updates will be returned back to clients and clients need to apply this update and do I/O request according to the latest version. Please see <a class="el" href="../../dd/d7f/group__pool.html">Storage pools.</a> and <a class="el" href="../../d8/dec/group__poolmach.html">Pool machine</a> for more details.</p>
<p>Which spare space to use in the SNS repair is managed by failure vector. After SNS repair, client can query this information from failure vector and send r/w request to corresponding spare space.</p>
<h2><a class="anchor" id="iosnsrepair-lspec-state"></a>
State Specification</h2>
<p>N/A</p>
<h2><a class="anchor" id="iosnsrepair-lspec-thread"></a>
Threading and Concurrency Model</h2>
<p>See <a class="el" href="../../d3/df4/rmw_io_dld.html">Detailed Level Design for read-modify-write IO requests.</a> for more information.</p>
<h2><a class="anchor" id="iosnsrepair-lspec-numa"></a>
NUMA optimizations</h2>
<p>See <a class="el" href="../../d3/df4/rmw_io_dld.html">Detailed Level Design for read-modify-write IO requests.</a> for more information.</p>
<h1><a class="anchor" id="iosnsrepair-conformance"></a>
Conformance</h1>
<ul>
<li><b>I.iosnsrepair.read</b> Read request handling is described in logic specification. Every node/device state are covered.</li>
<li><b>I.iosnsrepair.read</b> Write request handling is described in logic specification. Every node/device state are covered.</li>
<li><b>I.iosnsrepair.code</b> In logic specification, the design says the same code and algorithm will be used to handle io request in SNS repair and rmw.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-ut"></a>
Unit Tests</h1>
<p>Unit tests for read and write requests in different devices state are needed. These states includes: ONLINE, OFFLINE, FAILED, REPAIRING, REPAIRED.</p>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-st"></a>
System Tests</h1>
<p>System tests are needed to verify m0t1fs can serve read/write properly when node/device is in various states, and changes its state from one to another. For example:</p><ul>
<li>read/write requests in normal case.</li>
<li>read/write requests when a device changes from ONLINE to FAILED.</li>
<li>read/write requests when a device changes from FAILED to REPAIRING.</li>
<li>read/write requests when a device changes from REPAIRING to REPAIRED.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-O"></a>
Analysis</h1>
<p>See rmw for more information.</p>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-ref"></a>
References</h1>
<ul>
<li>HLD of SNS repair : For documentation links, please refer to this file : doc/motr-design-doc-list.rst</li>
<li><a class="el" href="../../d3/df4/rmw_io_dld.html">Detailed Level Design for read-modify-write IO requests.</a> m0t1fs client read-modify-write DLD</li>
<li><a class="el" href="../../da/da8/group__layout.html">Layouts.</a> Layout</li>
<li><a class="el" href="../../dd/d7f/group__pool.html">Storage pools.</a> Pool and <a class="el" href="../../d8/dec/group__poolmach.html">Pool machine</a> Pool Machine.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="iosnsrepair-impl-plan"></a>
Implementation Plan</h1>
<p>The code implementation depends on the m0t1fs rmw which is under development. The rmw is in code inspection phase right now. When this DLD is approved, code maybe can start. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:25 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
