<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: IO bulk transfer Detailed Level Design.</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d0/d92/io_bulk_client.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">IO bulk transfer Detailed Level Design. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-ovw">Overview</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-def">Definitions</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-req">Requirements</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-depends">Dependencies</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-highlights">Design Highlights</a></li>
<li><a class="el" href="../../d9/db8/bulkclient-fspec.html">IO bulk client Func Spec</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec">Logical Specification</a><ul>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-sc1">Subcomponent design</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-numa">NUMA optimizations</a></li>
</ul>
</li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-conformance">Conformance</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-ut">Unit Tests</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-st">System Tests</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-O">Analysis</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-ref">References</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="bulkclient-ovw"></a>
Overview</h1>
<p>This document describes the working of client side of io bulk transfer. This functionality is used only for io path. IO bulk client constitues the client side of bulk IO carried out between Motr client file system and data server (ioservice aka bulk io server). Motr network layer incorporates a bulk transport mechanism to transfer user buffers in zero-copy fashion. The generic io fop contains a network buffer descriptor which refers to a network buffer. The bulk client creates IO fops and attaches the kernel pages or a vector in user mode to net buffer associated with io fop and submits it to rpc layer. The rpc layer populates the net buffer descriptor from io fop and sends the fop over wire. The receiver starts the zero-copy of buffers using the net buffer descriptor from io fop.</p>
<hr/>
 <h1><a class="anchor" id="bulkclient-def"></a>
Definitions</h1>
<ul>
<li>m0t1fs - Motr client file system. It works as a kernel module.</li>
<li>Bulk transport - Event based, asynchronous message passing functionality of Motr network layer.</li>
<li>io fop - A generic io fop that is used for read and write.</li>
<li>rpc bulk - An interface to abstract the usage of network buffers by client and server programs.</li>
<li>ioservice - A service providing io routines in Motr. It runs only on server side.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="bulkclient-req"></a>
Requirements</h1>
<ul>
<li>R.bulkclient.rpcbulk The bulk client should use rpc bulk abstraction while enqueueing buffers for bulk transfer.</li>
<li>R.bulkclient.fopcreation The bulk client should create io fops as needed if pages overrun the existing rpc bulk structure.</li>
<li>R.bulkclient.netbufdesc The generic io fop should contain a network buffer descriptor which points to an in-memory network buffer.</li>
<li>R.bulkclient.iocoalescing The IO coalescing code should conform to new format of io fop. This is actually a side-effect and not a core part of functionality. Since the format of IO fop changes, the IO coalescing code which depends on it, needs to be restructured.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="bulkclient-depends"></a>
Dependencies</h1>
<ul>
<li>r.misc.net_rpc_convert Bulk Client needs Motr client file system to be using new network layer apis which include <a class="el" href="../../db/d78/structm0__net__domain.html">m0_net_domain</a> and <a class="el" href="../../d9/d7e/structm0__net__buffer.html">m0_net_buffer</a>.</li>
<li>r.fop.referring_another_fop With introduction of a net buffer descriptor in io fop, a mechanism needs to be introduced so that fop definitions from one component can refer to definitions from another component. <a class="el" href="../../d0/db8/structm0__net__buf__desc.html">m0_net_buf_desc</a> is a fop used to represent on-wire representation of a <a class="el" href="../../d9/d7e/structm0__net__buffer.html">m0_net_buffer</a>. <dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d0/db8/structm0__net__buf__desc.html">m0_net_buf_desc</a>.</dd></dl>
<hr/>
 </li>
</ul>
<h1><a class="anchor" id="bulkclient-highlights"></a>
Design Highlights</h1>
<p>IO bulk client uses a generic in-memory structure representing an io fop and its associated network buffer. This in-memory io fop contains another abstract structure to represent the network buffer associated with the fop. The bulk client creates <a class="el" href="../../d6/d93/structm0__io__fop.html">m0_io_fop</a> structures as necessary and attaches kernel pages or user space vector to associated <a class="el" href="../../db/d99/structm0__rpc__bulk.html">m0_rpc_bulk</a> structure and submits the fop to rpc layer. Rpc layer populates the network buffer descriptor embedded in the io fop and sends the fop over wire. The associated network buffer is added to appropriate buffer queue of transfer machine owned by rpc layer. Once, the receiver side receives the io fop, it acquires a local network buffer and calls a <a class="el" href="../../db/d99/structm0__rpc__bulk.html">m0_rpc_bulk</a> apis to start the zero-copy. So, io fop typically carries the net buf descriptor and bulk server asks the transfer machine belonging to rpc layer to start zero copy of data buffers.</p>
<hr/>
 <h1><a class="anchor" id="bulkclient-lspec"></a>
Logical Specification</h1>
<ul>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-comps">Component Overview</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-sc1">Subcomponent design</a><ul>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-ds1">Subcomponent Data Structures</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-sub1">Subcomponent Subroutines</a></li>
<li><a class="el" href="../../d5/dd7/group__bulkclient_d_f_s_internal.html">IO bulk client Detailed Function Spec</a></li>
</ul>
</li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d0/d92/io_bulk_client.html#bulkclient-lspec-numa">NUMA optimizations</a></li>
</ul>
<h2><a class="anchor" id="bulkclient-lspec-comps"></a>
Component Overview</h2>
<p>The following @dot diagram shows the interaction of bulk client program with rpc layer and net layer. </p><div class="dotgraph">
<img src="../../dot_inline_dotgraph_18.png" alt="dot_inline_dotgraph_18.png" border="0" usemap="#dot_inline_dotgraph_18.map"/>
<map name="dot_inline_dotgraph_18.map" id="dot_inline_dotgraph_18.map"></map>
</div>
<h2><a class="anchor" id="bulkclient-lspec-sc1"></a>
Subcomponent design</h2>
<p>Ioservice subsystem primarily comprises of 2 sub-components</p><ul>
<li>IO client (comprises of IO coalescing code)</li>
<li>IO server (server part of io routines)</li>
</ul>
<p>The IO client subsystem under which IO requests belonging to same fid and intent (read/write) are clubbed together in one fop and this resultant fop is sent instead of member io fops.</p>
<h3><a class="anchor" id="bulkclient-lspec-ds1"></a>
Subcomponent Data Structures</h3>
<p>The IO coalescing subsystem from ioservice primarily works on IO segments. IO segment is in-memory structure that represents a contiguous chunk of IO data along with extent information. An internal data structure ioseg represents the IO segment.</p><ul>
<li>ioseg An in-memory structure used to represent a segment of IO data.</li>
</ul>
<h3><a class="anchor" id="bulkclient-lspec-sub1"></a>
Subcomponent Subroutines</h3>
<ul>
<li><a class="el" href="../../d5/dd7/group__bulkclient_d_f_s_internal.html#ga43f1911d6548bf457fd7f08502701bc9">ioseg_get()</a> - Retrieves an ioseg given its index in zero vector.</li>
</ul>
<h2><a class="anchor" id="bulkclient-lspec-state"></a>
State Specification</h2>
<div class="dotgraph">
<img src="../../dot_inline_dotgraph_19.png" alt="dot_inline_dotgraph_19.png" border="0" usemap="#dot_inline_dotgraph_19.map"/>
<map name="dot_inline_dotgraph_19.map" id="dot_inline_dotgraph_19.map"></map>
</div>
<h2><a class="anchor" id="bulkclient-lspec-thread"></a>
Threading and Concurrency Model</h2>
<p>No need of explicit locking for structures like <a class="el" href="../../d6/d93/structm0__io__fop.html">m0_io_fop</a> and ioseg since they are taken care by locking at upper layers like locking at the m0t1fs part for dispatching IO requests.</p>
<h2><a class="anchor" id="bulkclient-lspec-numa"></a>
NUMA optimizations</h2>
<p>The performance need not be optimized by associating the incoming thread to a particular processor. However, keeping in sync with the design of request handler which tries to protect the locality of threads executing in a particular context by establishing affinity to some designated processor, this can be achieved. But this is still at a level higher than the io fop processing.</p>
<hr/>
 <h1><a class="anchor" id="bulkclient-conformance"></a>
Conformance</h1>
<ul>
<li>I.bulkclient.rpcbulk The bulk client uses rpc bulk APIs to enqueue kernel pages to the network buffer.</li>
<li>I.bulkclient.fopcreation bulk client creates new io fops until all kernel pages are enqueued.</li>
<li>I.bulkclient.netbufdesc The on-wire definition of io_fop contains a net buffer descriptor. <dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d0/db8/structm0__net__buf__desc.html">m0_net_buf_desc</a></dd></dl>
</li>
<li>I.bulkclient.iocoalescing Since all IO coalescing code is built around the definition of IO fop, it will conform to new format of io fop.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="bulkclient-ut"></a>
Unit Tests</h1>
<p>All external interfaces based on <a class="el" href="../../d6/d93/structm0__io__fop.html">m0_io_fop</a> and <a class="el" href="../../db/d99/structm0__rpc__bulk.html">m0_rpc_bulk</a> will be unit tested. All unit tests will stress success and failure conditions. Boundary condition testing is also included.</p><ul>
<li>The m0_io_fop* and m0_rpc_bulk* interfaces will be unit tested first in the order<ul>
<li>m0_io_fop_init Check if the inline <a class="el" href="../../d5/d01/structm0__fop.html">m0_fop</a> and <a class="el" href="../../db/d99/structm0__rpc__bulk.html">m0_rpc_bulk</a> are initialized properly.</li>
<li>m0_rpc_bulk_page_add/m0_rpc_bulk_buffer_add to add pages/buffers to the rpc_bulk structure and cross check if they are actually added or not.</li>
<li>Add more pages/buffers to rpc_bulk structure to check if they return proper error code.</li>
<li>Try m0_io_fop_fini to check if an initialized <a class="el" href="../../d6/d93/structm0__io__fop.html">m0_io_fop</a> and the inline <a class="el" href="../../db/d99/structm0__rpc__bulk.html">m0_rpc_bulk</a> get properly finalized.</li>
<li>Initialize and start a network transport and a transfer machine. Invoke m0_rpc_bulk_store on rpc_bulk structure and cross check if the net buffer descriptor is properly populated in the io fop.</li>
<li>Tweak the parameters of transfer machine so that it goes into degraded/failed state and invoke m0_rpc_bulk_store and check if m0_rpc_bulk_store returns proper error code.</li>
<li>Start another transfer machine and invoke m0_rpc_bulk_load to check if it recognizes the net buf descriptor and starts buffer transfer properly.</li>
<li>Tweak the parameters of second transfer machine so that it goes into degraded/failed state and invoke m0_rpc_bulk_load and check if it returns proper error code.</li>
</ul>
</li>
</ul>
<hr/>
 <h1><a class="anchor" id="bulkclient-st"></a>
System Tests</h1>
<p>Not applicable.</p>
<hr/>
 <h1><a class="anchor" id="bulkclient-O"></a>
Analysis</h1>
<ul>
<li>m denotes the number of IO fops with same fid and intent (read/write).</li>
<li>n denotes the total number of IO segments in m IO fops.</li>
<li>Memory consumption O(n) During IO coalescing, n number of IO segments are allocated and subsequently deallocated, once the resulting IO fop is created.</li>
<li>Processor cycles O(n) During IO coalescing, all n segments are traversed and resultant IO fop is created.</li>
<li>Locks Minimal locks since locking is mostly taken care by upper layers.</li>
<li>Messages Not applicable.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="bulkclient-ref"></a>
References</h1>
<p>For documentation links, please refer to this file : doc/motr-design-doc-list.rst</p><ul>
<li>RPC Bulk Transfer Task Plan</li>
<li>Detailed level design HOWTO an older document on which this style guide is partially based. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:25 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
