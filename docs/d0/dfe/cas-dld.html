<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Motr: The catalogue service (CAS)</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Motr
   &#160;<span id="projectnumber">M0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d0/dfe/cas-dld.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">The catalogue service (CAS) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-ovw">Overview</a></li>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-def">Definitions</a></li>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-ref">References</a></li>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-req">Requirements</a></li>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-depends">Dependencies</a></li>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-highlights">Design Highlights</a></li>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-lspec">Logical Specification</a><ul>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-lspec-state">State Specification</a></li>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-lspec-thread">Threading and Concurrency Model</a></li>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-lspec-layout">cas-lspec-layout</a></li>
</ul>
</li>
<li><a class="el" href="../../d0/dfe/cas-dld.html#cas-conformance">Conformance</a></li>
<li><a class="el" href="../../d4/d4d/cas-fspec.html">Functional Specification</a></li>
</ul>
<hr/>
 <h1><a class="anchor" id="cas-ovw"></a>
Overview</h1>
<p>Catalogue service exports BE btrees (be/btree.[ch]) to the network.</p>
<hr/>
 <h1><a class="anchor" id="cas-def"></a>
Definitions</h1>
<p>Some of definitions are copied from HLD (see <a class="el" href="../../d0/dfe/cas-dld.html#cas-ref">References</a>).</p><ul>
<li><b>Catalogue</b> (index): a container for records. A catalogue is explicitly created and deleted by a user and has an identifier (<a class="el" href="../../d9/d8a/structm0__fid.html">m0_fid</a>), assigned by the user.</li>
<li><b>Meta-catalogue</b>: single catalogue containing information about all existing catalogues.</li>
<li><b>Catalogue-index</b>: local (non-distributed) catalogue maintained by the index subsystem on each node in the pool. When a component catalogue is created for a distributed index, a record mapping the catalogue to the index is inserted in the catalogue-index. This record is used by the index repair and re-balance to find locations of other replicas.</li>
<li><b>Record:</b> a key-value pair.</li>
<li><b>Key:</b> an arbitrary sequence of bytes, used to identify a record in a catalogue.</li>
<li><b>Value:</b> an arbitrary sequence of bytes, associated with a key.</li>
<li><b>Key</b> <b>order:</b> total order, defined on keys within a given container. Iterating through the container, returns keys in this order. The order is defined as lexicographical order of keys, interpreted as bit-strings.</li>
<li><b>User:</b> any Motr component or external application using a cas instance by sending fops to it.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="cas-req"></a>
Requirements</h1>
<p>Additional requirements that are not covered in HLD (see <a class="el" href="../../d0/dfe/cas-dld.html#cas-ref">References</a>)</p><ul>
<li><b>r.cas.bulk</b> RPC bulk mechanism should be supported for transmission of CAS request that doesn't fit into one FOP.</li>
<li><b>r.cas.sync</b> CAS service processes requests synchronously. If catalogue can't be locked immediately, then FOM is blocked.</li>
<li><b>r.cas.indices-list</b> User should be able to request list of all indices in meta-index without prior knowledge of any index FID.</li>
<li><b>r.cas.addb</b> ADDB statistics should be collected for:<ul>
<li>Sizes for every requested key/value;</li>
<li>Read/write lock contention.</li>
</ul>
</li>
</ul>
<hr/>
 <h1><a class="anchor" id="cas-depends"></a>
Dependencies</h1>
<ul>
<li>reqh service</li>
<li>fom, fom long lock</li>
<li>BE transaction, BE btree.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="cas-highlights"></a>
Design Highlights</h1>
<ul>
<li>Catalogue service implementation doesn't bother about distribution of key/value records between nodes in the cluster. Distributed key/value storage may be built on the client side.</li>
<li>Keys and values can be of arbitrary size, so they possibly don't fit into single FOP. Bulk RPC transmission should be used in this case (not implemented yet).</li>
<li>Per-FOM BE transaction is used to perform modifications of index B-trees.</li>
<li>B-tree for meta-index is stored in zero BE segment of motr global BE domain. Other B-trees are stored in BE segment of the request handler.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="cas-lspec"></a>
Logical Specification</h1>
<h2><a class="anchor" id="cas-lspec-state"></a>
State Specification</h2>
<pre class="fragment">*                          +----------------------------+
*                          |                            |
*                          V    !cas_op_checked         |
*                      FOPH_INIT---------------+        |
*                          |                   |        |
*                          |                   V        |
*                          |             CAS_CHECK_PRE  |
*                          |                   |        |
*                          |                   V        |
*                          |               CAS_CHECK----+
*                          |                   |
*                          |                   | cas_op_check() failed
*                          V                   |
*                   [generic phases]        FAILURE
*                          .
*                          .                               meta_op
*                          .                       +---------------------+
*                          V                       |                     |
*                       TXN_INIT--------------&gt;CAS_START&lt;-------+        |
*                                                  |            |        |
*                                                  V            |        |
*                       TXN_OPEN&lt;-----+      CAS_META_LOCK      |        |
*                          |          |            |            |        |
*                          |          |            V            |        |
*                   [generic phases]  |     CAS_META_LOOKUP     |        |
*                          .          |            |            |        |
*                          .          |            V            |        |
*           !meta_op       .          |   CAS_META_LOOKUP_DONE  |        |
*          +---------CAS_TXN_OPENED   |            |            |        |
*          |               |          |            |            |        |
*          V               |          |            |            |        |
*   CAS_META_UNLOCK-------&gt;|          |            |            |        |
*                          |          |            | ctg_crow   |        |
*                          |          |            +----------+ |        |
* +-----------------------&gt;|          |            |          | |        |
* |                        |          |            |          V |        |
* |      +-CAS_DTM0&lt;-+     |          |            |   CAS_CTG_CROW_DONE |
* |      |           |     |          |            |                     |
* |      |           |dtm0 |          |            |                     |
* |      V           |     |          |            |                     |
* |   SUCCESS&lt;-------+-CAS_LOOP&lt;----+ |            |                     |
* |                        |        | |            V                     |
* |            index drop  |        | |    +-&gt;CAS_LOAD_KEY&lt;--------------+
* |        +---------------+        | |    |       |
* |        |               |        | |    |       V
* |        V               |        | |    |  CAS_LOAD_VAL
* |  CAS_INSERT_TO_DEAD    |        | |    |       |
* |        |               |        | |    |       V
* |        V               |        | |    +--CAS_LOAD_DONE
* |  CAS_DELETE_FROM_META-&gt;|        | |            |
* |                        |        | |            |
* |        ctidx_op_needed |        | |            |
* |      +-----------------+        | |            |
* |      |                 |        | |            |
* |      V                 |        | |            |
* |  CAS_CTIDX------------&gt;|        | |            |  index drop
* |                        |        | |            +-------------+
* |          index drop    |        | |            |             |
* |       +----------------+        | |            |             V
* |       |                |        | |            |&lt;---CAS_DEAD_INDEX_LOCK
* |       V                |        | |            |
* +--CAS_IDROP_LOOP        |        | |            |
*         |                |        | |            |
*         V                |        | |            |
*  CAS_IDROP_LOCK_LOOP     |        | |            |
*   |       |              |        | |            |
*   |       V              |        | |            |
*   |   CAS_IDROP_LOCKED--&gt;|        | |            |
*   |                      |        | |            |
*   V                      |        | |            |
* CAS_IDROP_START_GC       |        | |            |
*   |                      V        | |            |
*   V              CAS_PREPARE_SEND | |            |
* SUCCESS                  |        | |            |
*                          |next_key| |            |
*                          +-------&gt;| |            |
*                          |        | |        CAS_LOCK------------+
*                          V        | |            |               |
*                     CAS_SEND_KEY  | |            |meta_op        |
*                          |        | |            |               |
*                          V        | |            V               |
*                     CAS_SEND_VAL  | |      CAS_CTIDX_LOCK        |
*                          |        | |            |               |
*                          V        | |            V               |
*                       CAS_DONE----+ +--------CAS_PREP&lt;-----------+
*
* </pre><h2><a class="anchor" id="cas-lspec-thread"></a>
Threading and Concurrency Model</h2>
<p>Catalogues (including meta catalogue) are protected with "multiple
  readers/single writer" lock (see <a class="el" href="../../d5/df2/structm0__cas__ctg.html#a57cafb6b6ba9a0c4e55f7c62fa021a1c">m0_cas_ctg::cc_lock</a>). Writer starvation is not possible due to FOM long lock design, because writer has priority over readers.</p>
<p>B-tree structure has internal rwlock (<a class="el" href="../../d2/d56/structm0__be__btree.html#a3287dddbbd71ccc2fb52db85be2b57e2">m0_be_btree::bb_lock</a>), but it's not convenient for usage inside FOM since it blocks the execution thread. Also, index should be locked before FOM BE TX credit calculation, because amount of credits depends on the height of BE tree. Index is unlocked when all necessary B-tree operations are done.</p>
<h2><a class="anchor" id="cas-lspec-layout"></a>
cas-lspec-layout</h2>
<p>Memory for all indices (including meta-index) is allocated in the first segment (<a class="el" href="../../d9/dcf/group__be.html#gad6b06593f8947f69956282e972959d20">m0_be_domain_seg_first()</a>) of Motr global BE domain (m0::i_be_dom). Address of a meta-index is stored in this segment dictionary. Meta-index btree stores information about existing indices (including itself) as key-value pairs, where key is a FID of an index and value is a pointer to it.</p>
<hr/>
 <h1><a class="anchor" id="cas-conformance"></a>
Conformance</h1>
<ul>
<li><b>i.cas.bulk</b> Not designed yet.</li>
<li><b>i.cas.sync</b> FOM is blocked on waiting of per-index FOM long lock.</li>
<li><b>i.cas.indices-list</b> Meta-index includes itself and has the smallest FID (0,0), so it is always the first by key order. User can specify m0_cas_meta_fid as s starting FID to list indices from the start.</li>
<li><b>i.cas.addb</b> Per-index long lock is initialised with non-NULL addb2 structure. Key/value size of each record in request is collected in <a class="el" href="../../d0/d60/cas_2service_8c.html#af9a1e62a53bf519ea5dbdc0ed161e418">cas_fom_addb2_descr()</a> function.</li>
</ul>
<hr/>
 <h1><a class="anchor" id="cas-ref"></a>
References</h1>
<ul>
<li>HLD of the catalogue service : For documentation links, please refer to this file : doc/motr-design-doc-list.rst </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d3/dd6/_d_l_d_i_x.html">Detailed Designs</a></li>
    <li class="footer">Generated on Thu Apr 14 2022 14:03:22 for Motr by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
